<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AgentFlow v2 â€” Topology View | AgentPane</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@300;400;500;600&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    /* ========================================
       Reset & Foundation
       ======================================== */
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    html { -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; }
    ul, ol { list-style: none; }
    button { cursor: pointer; border: none; background: none; font: inherit; color: inherit; }
    input { font: inherit; color: inherit; }

    :root {
      --bg-canvas: #0d1117;
      --bg-default: #161b22;
      --bg-subtle: #1c2128;
      --bg-muted: #21262d;
      --bg-emphasis: #30363d;
      --fg-default: #e6edf3;
      --fg-muted: #8b949e;
      --fg-subtle: #6e7681;
      --fg-on-emphasis: #ffffff;
      --border-default: #30363d;
      --border-muted: #21262d;
      --accent-fg: #58a6ff;
      --accent-emphasis: #1f6feb;
      --accent-muted: rgba(56, 139, 253, 0.15);
      --success-fg: #3fb950;
      --danger-fg: #f85149;
      --attention-fg: #d29922;
      --done-fg: #a371f7;
      --font-sans: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif;
      --font-mono: 'Fira Code', 'SF Mono', Menlo, Consolas, monospace;
      --radius-sm: 4px;
      --radius: 6px;
      --radius-lg: 12px;
      --radius-full: 9999px;
      --duration-fast: 150ms;
      --duration-normal: 200ms;
      --duration-slow: 300ms;
      --easing: cubic-bezier(0.25, 1, 0.5, 1);

      /* Agent type colors */
      --color-orchestrator: #FFD866;
      --color-planner: #A78BFA;
      --color-coder: #67E8F9;
      --color-reviewer: #C084FC;
      --color-tester: #FCA572;
      --color-scanner: #F87171;
      --color-deployer: #34D399;

      /* Status colors */
      --status-completed: #A78BFA;
      --status-running: #34D399;
      --status-verifying: #FFD866;
      --status-blocked: #FCA572;
      --status-failed: #F87171;
      --status-queued: #475569;
    }

    body {
      font-family: var(--font-sans);
      font-size: 13px;
      color: var(--fg-default);
      background: var(--bg-canvas);
      height: 100vh;
      overflow: hidden;
    }

    /* Subtle grid background */
    body::after {
      content: '';
      position: fixed;
      inset: 0;
      background-image:
        linear-gradient(rgba(88, 166, 255, 0.012) 1px, transparent 1px),
        linear-gradient(90deg, rgba(88, 166, 255, 0.012) 1px, transparent 1px);
      background-size: 32px 32px;
      pointer-events: none;
      z-index: 0;
    }

    /* Atmospheric glow */
    body::before {
      content: '';
      position: fixed;
      inset: 0;
      background:
        radial-gradient(ellipse 900px 500px at 30% 30%, rgba(88, 166, 255, 0.03), transparent),
        radial-gradient(ellipse 700px 400px at 70% 70%, rgba(52, 211, 153, 0.02), transparent);
      pointer-events: none;
      z-index: 0;
    }

    /* ========================================
       Layout
       ======================================== */
    .page {
      display: flex;
      flex-direction: column;
      height: 100vh;
      position: relative;
      z-index: 1;
    }

    .header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 10px 20px;
      border-bottom: 1px solid var(--border-default);
      background: rgba(13, 17, 23, 0.9);
      backdrop-filter: blur(12px);
      flex-shrink: 0;
      z-index: 50;
      gap: 16px;
    }

    .header-left {
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .logo {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 14px;
      font-weight: 600;
      color: var(--fg-default);
      letter-spacing: -0.02em;
    }

    .logo-icon {
      width: 24px;
      height: 24px;
      background: linear-gradient(135deg, var(--accent-fg), var(--done-fg));
      border-radius: 6px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      color: white;
      font-weight: 700;
    }

    .logo-badge {
      font-size: 10px;
      padding: 2px 6px;
      background: var(--accent-muted);
      color: var(--accent-fg);
      border-radius: var(--radius-full);
      font-weight: 500;
    }

    .header-center {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .header-right {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .sim-controls {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 4px 8px;
      background: var(--bg-default);
      border: 1px solid var(--border-default);
      border-radius: var(--radius);
    }

    .sim-btn {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 28px;
      height: 28px;
      border-radius: var(--radius-sm);
      transition: all var(--duration-fast) var(--easing);
      font-size: 14px;
    }

    .sim-btn:hover { background: var(--bg-subtle); }
    .sim-btn.active { background: var(--accent-muted); color: var(--accent-fg); }

    .speed-indicator {
      font-size: 11px;
      font-family: var(--font-mono);
      color: var(--fg-subtle);
      padding: 0 4px;
      min-width: 28px;
      text-align: center;
    }

    .metric-pill {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 4px 10px;
      background: var(--bg-default);
      border: 1px solid var(--border-default);
      border-radius: var(--radius-full);
      font-size: 11px;
      font-family: var(--font-mono);
    }

    .metric-pill .label { color: var(--fg-subtle); }
    .metric-pill .value { color: var(--fg-default); font-weight: 500; }
    .metric-pill .value.running { color: var(--status-running); }
    .metric-pill .value.cost { color: var(--color-orchestrator); }

    .decision-toggle {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 4px 10px;
      background: var(--bg-default);
      border: 1px solid var(--border-default);
      border-radius: var(--radius-full);
      font-size: 11px;
      cursor: pointer;
      transition: all var(--duration-fast) var(--easing);
    }

    .decision-toggle:hover { border-color: var(--fg-subtle); }
    .decision-toggle.active { border-color: var(--accent-fg); background: var(--accent-muted); }
    .decision-toggle .dot {
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: var(--fg-subtle);
    }
    .decision-toggle.active .dot { background: var(--accent-fg); }

    /* Main content split */
    .main-content {
      display: flex;
      flex: 1;
      overflow: hidden;
    }

    /* ========================================
       Canvas Area (left ~70%)
       ======================================== */
    .canvas-area {
      flex: 1;
      position: relative;
      overflow: hidden;
      min-width: 0;
    }

    .canvas-toolbar {
      position: absolute;
      top: 12px;
      left: 12px;
      display: flex;
      gap: 4px;
      z-index: 20;
      background: rgba(22, 27, 34, 0.9);
      backdrop-filter: blur(8px);
      border: 1px solid var(--border-default);
      border-radius: var(--radius);
      padding: 4px;
    }

    .canvas-toolbar button {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 28px;
      height: 28px;
      border-radius: var(--radius-sm);
      font-size: 13px;
      color: var(--fg-muted);
      transition: all var(--duration-fast) var(--easing);
    }

    .canvas-toolbar button:hover { background: var(--bg-subtle); color: var(--fg-default); }
    .canvas-toolbar button.active { background: var(--accent-muted); color: var(--accent-fg); }

    .canvas-toolbar .separator {
      width: 1px;
      background: var(--border-default);
      margin: 2px 2px;
    }

    .zoom-indicator {
      position: absolute;
      bottom: 12px;
      left: 12px;
      z-index: 20;
      font-size: 11px;
      font-family: var(--font-mono);
      color: var(--fg-subtle);
      background: rgba(22, 27, 34, 0.9);
      backdrop-filter: blur(8px);
      border: 1px solid var(--border-default);
      border-radius: var(--radius);
      padding: 4px 8px;
    }

    .task-filter-bar {
      position: absolute;
      top: 12px;
      right: 12px;
      display: flex;
      gap: 4px;
      z-index: 20;
    }

    .task-filter-chip {
      padding: 4px 10px;
      font-size: 11px;
      font-weight: 500;
      border-radius: var(--radius-full);
      background: rgba(22, 27, 34, 0.9);
      backdrop-filter: blur(8px);
      border: 1px solid var(--border-default);
      color: var(--fg-muted);
      cursor: pointer;
      transition: all var(--duration-fast) var(--easing);
    }

    .task-filter-chip:hover { border-color: var(--fg-subtle); color: var(--fg-default); }
    .task-filter-chip.active { border-color: var(--accent-fg); color: var(--accent-fg); background: var(--accent-muted); }

    .task-filter-chip .count {
      font-family: var(--font-mono);
      font-size: 10px;
      margin-left: 4px;
      opacity: 0.7;
    }

    /* SVG Canvas */
    #topology-svg {
      width: 100%;
      height: 100%;
      cursor: grab;
    }

    #topology-svg.dragging { cursor: grabbing; }

    /* ========================================
       SVG Styles
       ======================================== */
    .task-group-bg {
      fill: rgba(22, 27, 34, 0.4);
      stroke: var(--border-muted);
      stroke-width: 1;
      rx: 12;
      ry: 12;
    }

    .task-group-label {
      font-family: var(--font-sans);
      font-size: 11px;
      font-weight: 600;
      fill: var(--fg-subtle);
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .task-group-priority {
      font-family: var(--font-mono);
      font-size: 9px;
      font-weight: 500;
    }

    .edge-line {
      fill: none;
      stroke-width: 1.5;
      marker-end: url(#arrowhead);
    }

    .edge-line.completed { stroke: var(--status-completed); opacity: 0.5; }
    .edge-line.running { stroke: var(--status-running); opacity: 0.7; stroke-dasharray: 6 4; }
    .edge-line.pending { stroke: var(--fg-subtle); opacity: 0.3; stroke-dasharray: 2 4; }
    .edge-line.blocked { stroke: var(--status-blocked); opacity: 0.4; stroke-dasharray: 4 4; }
    .edge-line.failed { stroke: var(--status-failed); opacity: 0.5; }

    .agent-node { cursor: pointer; }
    .agent-node:hover .node-ring { opacity: 1; }

    .node-bg {
      stroke-width: 2;
      transition: all var(--duration-fast) var(--easing);
    }

    .node-ring {
      fill: none;
      stroke-width: 1;
      opacity: 0;
      transition: opacity var(--duration-fast) var(--easing);
    }

    .node-icon {
      font-size: 14px;
      text-anchor: middle;
      dominant-baseline: central;
      fill: var(--bg-canvas);
      font-weight: 600;
    }

    .node-label {
      font-family: var(--font-sans);
      font-size: 10px;
      font-weight: 500;
      fill: var(--fg-muted);
      text-anchor: middle;
    }

    .node-status-dot {
      r: 4;
      stroke: var(--bg-canvas);
      stroke-width: 2;
    }

    .node-token-ring {
      fill: none;
      stroke-width: 2;
      stroke-linecap: round;
      opacity: 0.4;
    }

    /* Decision badge on nodes/edges */
    .decision-badge {
      cursor: pointer;
    }

    .decision-badge-bg {
      rx: 4;
      ry: 4;
      stroke-width: 1;
    }

    .decision-badge-icon {
      font-size: 9px;
      text-anchor: middle;
      dominant-baseline: central;
      font-weight: 600;
    }

    /* Particle animation for active edges */
    .flow-particle {
      r: 2.5;
      opacity: 0.9;
    }

    /* Node selected state */
    .agent-node.selected .node-ring { opacity: 1; stroke-width: 2; }
    .agent-node.selected .node-bg { stroke-width: 3; }

    /* Pulse animation for running nodes */
    @keyframes nodePulse {
      0%, 100% { opacity: 0.15; r: 22; }
      50% { opacity: 0.3; r: 26; }
    }

    .running-pulse {
      animation: nodePulse 2s ease-in-out infinite;
    }

    /* Decision pulse */
    @keyframes decisionPulse {
      0%, 100% { opacity: 0.6; }
      50% { opacity: 1; }
    }

    .decision-badge { animation: decisionPulse 2s ease-in-out infinite; }

    /* ========================================
       Detail Panel (right ~30%)
       ======================================== */
    .detail-panel {
      width: 360px;
      min-width: 360px;
      background: var(--bg-default);
      border-left: 1px solid var(--border-default);
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .panel-empty {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100%;
      gap: 12px;
      color: var(--fg-subtle);
    }

    .panel-empty-icon {
      font-size: 32px;
      opacity: 0.4;
    }

    .panel-empty-text {
      font-size: 13px;
      text-align: center;
      line-height: 1.5;
    }

    .panel-empty-hint {
      font-size: 11px;
      color: var(--fg-subtle);
      opacity: 0.6;
    }

    .panel-header {
      padding: 16px;
      border-bottom: 1px solid var(--border-default);
      display: flex;
      align-items: flex-start;
      gap: 12px;
    }

    .panel-agent-icon {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      font-weight: 700;
      color: var(--bg-canvas);
      flex-shrink: 0;
    }

    .panel-agent-info {
      flex: 1;
      min-width: 0;
    }

    .panel-agent-name {
      font-size: 15px;
      font-weight: 600;
      color: var(--fg-default);
      margin-bottom: 2px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .panel-agent-meta {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 11px;
    }

    .panel-agent-type {
      color: var(--fg-muted);
      text-transform: capitalize;
    }

    .panel-close {
      width: 28px;
      height: 28px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: var(--radius-sm);
      color: var(--fg-subtle);
      transition: all var(--duration-fast) var(--easing);
      flex-shrink: 0;
    }

    .panel-close:hover { background: var(--bg-subtle); color: var(--fg-default); }

    .status-badge {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 2px 8px;
      border-radius: var(--radius-full);
      font-size: 11px;
      font-weight: 500;
    }

    .status-badge .dot {
      width: 6px;
      height: 6px;
      border-radius: 50%;
    }

    .status-badge.completed { background: rgba(167, 139, 250, 0.15); color: #A78BFA; }
    .status-badge.completed .dot { background: #A78BFA; }
    .status-badge.running { background: rgba(52, 211, 153, 0.15); color: #34D399; }
    .status-badge.running .dot { background: #34D399; }
    .status-badge.verifying { background: rgba(255, 216, 102, 0.15); color: #FFD866; }
    .status-badge.verifying .dot { background: #FFD866; }
    .status-badge.blocked { background: rgba(252, 165, 114, 0.15); color: #FCA572; }
    .status-badge.blocked .dot { background: #FCA572; }
    .status-badge.failed { background: rgba(248, 113, 113, 0.15); color: #F87171; }
    .status-badge.failed .dot { background: #F87171; }
    .status-badge.queued { background: rgba(71, 85, 105, 0.25); color: #8b949e; }
    .status-badge.queued .dot { background: #475569; }

    .panel-body {
      flex: 1;
      overflow-y: auto;
      overflow-x: hidden;
    }

    .panel-section {
      padding: 12px 16px;
      border-bottom: 1px solid var(--border-muted);
    }

    .panel-section-title {
      font-size: 10px;
      font-weight: 600;
      color: var(--fg-subtle);
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin-bottom: 8px;
    }

    .stat-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
    }

    .stat-item {
      padding: 8px;
      background: var(--bg-subtle);
      border-radius: var(--radius);
      border: 1px solid var(--border-muted);
    }

    .stat-label {
      font-size: 10px;
      color: var(--fg-subtle);
      margin-bottom: 2px;
    }

    .stat-value {
      font-size: 14px;
      font-weight: 600;
      font-family: var(--font-mono);
      color: var(--fg-default);
    }

    .stat-value.cost { color: var(--color-orchestrator); }

    .progress-bar-container {
      height: 6px;
      background: var(--bg-emphasis);
      border-radius: var(--radius-full);
      overflow: hidden;
      margin-top: 6px;
    }

    .progress-bar-fill {
      height: 100%;
      border-radius: var(--radius-full);
      transition: width 0.5s var(--easing);
    }

    /* Relationships */
    .relationship-item {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 6px 0;
    }

    .relationship-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      flex-shrink: 0;
    }

    .relationship-name {
      font-size: 12px;
      color: var(--fg-default);
      flex: 1;
    }

    .relationship-status {
      font-size: 10px;
      color: var(--fg-subtle);
    }

    .relationship-arrow {
      font-size: 10px;
      color: var(--fg-subtle);
      margin-right: 2px;
    }

    /* Decision feed items */
    .decision-feed-item {
      display: flex;
      gap: 8px;
      padding: 8px 0;
      cursor: pointer;
      border-radius: var(--radius-sm);
      transition: background var(--duration-fast) var(--easing);
    }

    .decision-feed-item:hover { background: var(--bg-subtle); margin: 0 -4px; padding: 8px 4px; }

    .decision-feed-icon {
      width: 24px;
      height: 24px;
      border-radius: var(--radius-sm);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      flex-shrink: 0;
    }

    .decision-feed-content {
      flex: 1;
      min-width: 0;
    }

    .decision-feed-type {
      font-size: 11px;
      font-weight: 600;
      margin-bottom: 1px;
    }

    .decision-feed-summary {
      font-size: 11px;
      color: var(--fg-muted);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .decision-feed-time {
      font-size: 10px;
      font-family: var(--font-mono);
      color: var(--fg-subtle);
      flex-shrink: 0;
    }

    .verification-status {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 12px;
      background: var(--bg-subtle);
      border-radius: var(--radius);
      border: 1px solid var(--border-muted);
    }

    .verification-icon {
      font-size: 16px;
    }

    .verification-text {
      font-size: 12px;
      color: var(--fg-muted);
    }

    .verification-text strong {
      color: var(--fg-default);
      font-weight: 500;
    }

    /* ========================================
       Decision Popover
       ======================================== */
    .popover-overlay {
      position: fixed;
      inset: 0;
      z-index: 100;
    }

    .decision-popover {
      position: fixed;
      width: 340px;
      background: var(--bg-default);
      border: 1px solid var(--border-default);
      border-radius: var(--radius-lg);
      box-shadow: 0 16px 48px rgba(0, 0, 0, 0.35);
      z-index: 101;
      overflow: hidden;
      animation: popoverIn 0.2s var(--easing);
    }

    @keyframes popoverIn {
      from { opacity: 0; transform: scale(0.95) translateY(-4px); }
      to { opacity: 1; transform: scale(1) translateY(0); }
    }

    .popover-header {
      padding: 12px 16px;
      border-bottom: 1px solid var(--border-muted);
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .popover-icon {
      width: 28px;
      height: 28px;
      border-radius: var(--radius);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
    }

    .popover-title {
      font-size: 13px;
      font-weight: 600;
      color: var(--fg-default);
    }

    .popover-subtitle {
      font-size: 11px;
      color: var(--fg-muted);
    }

    .popover-body {
      padding: 12px 16px;
    }

    .popover-section {
      margin-bottom: 12px;
    }

    .popover-section:last-child { margin-bottom: 0; }

    .popover-label {
      font-size: 10px;
      font-weight: 600;
      color: var(--fg-subtle);
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin-bottom: 4px;
    }

    .popover-text {
      font-size: 12px;
      color: var(--fg-muted);
      line-height: 1.5;
    }

    .confidence-bar-bg {
      height: 8px;
      background: var(--bg-emphasis);
      border-radius: var(--radius-full);
      overflow: hidden;
      position: relative;
    }

    .confidence-bar-fill {
      height: 100%;
      border-radius: var(--radius-full);
      transition: width 0.5s var(--easing);
    }

    .confidence-markers {
      display: flex;
      justify-content: space-between;
      margin-top: 2px;
    }

    .confidence-marker {
      font-size: 9px;
      font-family: var(--font-mono);
      color: var(--fg-subtle);
    }

    .confidence-value {
      font-size: 13px;
      font-weight: 600;
      font-family: var(--font-mono);
      margin-bottom: 4px;
    }

    .popover-tag-list {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
    }

    .popover-tag {
      padding: 2px 8px;
      font-size: 10px;
      border-radius: var(--radius-full);
      background: var(--bg-emphasis);
      color: var(--fg-muted);
    }

    .popover-alternative {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 4px 0;
      font-size: 11px;
    }

    .popover-alternative-name { color: var(--fg-muted); }
    .popover-alternative-score {
      font-family: var(--font-mono);
      color: var(--fg-subtle);
    }

    .popover-footer {
      padding: 8px 16px 12px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .popover-policy {
      font-size: 10px;
      color: var(--fg-subtle);
      font-family: var(--font-mono);
    }

    .override-btn {
      padding: 4px 12px;
      font-size: 11px;
      font-weight: 500;
      border-radius: var(--radius);
      border: 1px solid var(--border-default);
      color: var(--fg-muted);
      background: var(--bg-subtle);
      transition: all var(--duration-fast) var(--easing);
    }

    .override-btn:hover { border-color: var(--fg-subtle); color: var(--fg-default); }

    /* ========================================
       Tooltip
       ======================================== */
    .node-tooltip {
      position: fixed;
      pointer-events: none;
      z-index: 200;
      padding: 10px 12px;
      background: rgba(22, 27, 34, 0.95);
      backdrop-filter: blur(8px);
      border: 1px solid var(--border-default);
      border-radius: var(--radius);
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
      font-size: 11px;
      min-width: 160px;
      opacity: 0;
      transition: opacity var(--duration-fast) var(--easing);
    }

    .node-tooltip.visible { opacity: 1; }

    .tooltip-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 2px 0;
    }

    .tooltip-row .label { color: var(--fg-subtle); }
    .tooltip-row .value { color: var(--fg-default); font-weight: 500; font-family: var(--font-mono); }

    .tooltip-name {
      font-size: 12px;
      font-weight: 600;
      color: var(--fg-default);
      margin-bottom: 4px;
      padding-bottom: 4px;
      border-bottom: 1px solid var(--border-muted);
    }

    .tooltip-progress {
      margin-top: 4px;
      height: 3px;
      background: var(--bg-emphasis);
      border-radius: var(--radius-full);
      overflow: hidden;
    }

    .tooltip-progress-fill {
      height: 100%;
      border-radius: var(--radius-full);
    }

    /* ========================================
       Scrollbar
       ======================================== */
    .panel-body::-webkit-scrollbar { width: 6px; }
    .panel-body::-webkit-scrollbar-track { background: transparent; }
    .panel-body::-webkit-scrollbar-thumb { background: var(--bg-emphasis); border-radius: 3px; }
    .panel-body::-webkit-scrollbar-thumb:hover { background: var(--fg-subtle); }

    /* ========================================
       Hidden
       ======================================== */
    .hidden { display: none !important; }

    /* ========================================
       Transitions
       ======================================== */
    .fade-in {
      animation: fadeIn 0.3s var(--easing);
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    /* Panel tabs */
    .panel-tabs {
      display: flex;
      border-bottom: 1px solid var(--border-muted);
      padding: 0 16px;
    }

    .panel-tab {
      padding: 8px 12px;
      font-size: 11px;
      font-weight: 500;
      color: var(--fg-subtle);
      border-bottom: 2px solid transparent;
      margin-bottom: -1px;
      transition: all var(--duration-fast) var(--easing);
    }

    .panel-tab:hover { color: var(--fg-muted); }
    .panel-tab.active { color: var(--fg-default); border-bottom-color: var(--accent-fg); }

    .panel-tab-content { display: none; }
    .panel-tab-content.active { display: block; }

    /* Agent activity log */
    .activity-item {
      display: flex;
      gap: 8px;
      padding: 6px 0;
      font-size: 11px;
    }

    .activity-time {
      font-family: var(--font-mono);
      color: var(--fg-subtle);
      flex-shrink: 0;
      font-size: 10px;
      padding-top: 1px;
    }

    .activity-text { color: var(--fg-muted); line-height: 1.4; }
    .activity-text strong { color: var(--fg-default); font-weight: 500; }

    /* Legend */
    .canvas-legend {
      position: absolute;
      bottom: 12px;
      right: 12px;
      z-index: 20;
      display: flex;
      gap: 12px;
      padding: 6px 12px;
      background: rgba(22, 27, 34, 0.9);
      backdrop-filter: blur(8px);
      border: 1px solid var(--border-default);
      border-radius: var(--radius);
      font-size: 10px;
      color: var(--fg-subtle);
    }

    .legend-item {
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .legend-line {
      width: 16px;
      height: 2px;
      border-radius: 1px;
    }

    .legend-line.solid { background: var(--status-completed); }
    .legend-line.dashed { background: var(--status-running); background: repeating-linear-gradient(90deg, var(--status-running) 0, var(--status-running) 4px, transparent 4px, transparent 7px); }
    .legend-line.dotted { background: repeating-linear-gradient(90deg, var(--fg-subtle) 0, var(--fg-subtle) 2px, transparent 2px, transparent 5px); }

    .legend-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
    }
  </style>
</head>
<body>
  <!-- Page layout -->
  <div class="page">
    <!-- Header -->
    <header class="header">
      <div class="header-left">
        <div class="logo">
          <div class="logo-icon">A</div>
          AgentFlow
          <span class="logo-badge">TOPOLOGY</span>
        </div>
      </div>

      <div class="header-center">
        <div class="sim-controls">
          <button class="sim-btn" id="sim-reset" title="Reset">
            <span style="font-size:12px">&#8634;</span>
          </button>
          <button class="sim-btn active" id="sim-play" title="Play/Pause">&#9654;</button>
          <button class="sim-btn" id="sim-fast" title="Fast Forward">&#9654;&#9654;</button>
          <span class="speed-indicator" id="speed-label">1x</span>
        </div>

        <div class="metric-pill">
          <span class="label">Agents</span>
          <span class="value running" id="metric-active">0</span>
          <span class="label">/</span>
          <span class="value" id="metric-total">33</span>
        </div>

        <div class="metric-pill">
          <span class="label">Tokens</span>
          <span class="value" id="metric-tokens">0</span>
        </div>

        <div class="metric-pill">
          <span class="label">Cost</span>
          <span class="value cost" id="metric-cost">$0.00</span>
        </div>

        <div class="metric-pill">
          <span class="label">Decisions</span>
          <span class="value" id="metric-decisions">0</span>
        </div>
      </div>

      <div class="header-right">
        <div class="decision-toggle active" id="decision-toggle">
          <span class="dot"></span>
          <span>Decisions</span>
        </div>
      </div>
    </header>

    <!-- Main split -->
    <div class="main-content">
      <!-- Canvas -->
      <div class="canvas-area">
        <div class="canvas-toolbar">
          <button title="Zoom In" onclick="zoomIn()">+</button>
          <button title="Zoom Out" onclick="zoomOut()">&minus;</button>
          <button title="Fit View" onclick="fitView()">&#9724;</button>
          <div class="separator"></div>
          <button title="Center" onclick="centerView()">&#8982;</button>
        </div>

        <div class="task-filter-bar" id="task-filters"></div>

        <div class="zoom-indicator" id="zoom-label">100%</div>

        <div class="canvas-legend">
          <div class="legend-item">
            <div class="legend-line solid"></div> Completed
          </div>
          <div class="legend-item">
            <div class="legend-line dashed"></div> Active
          </div>
          <div class="legend-item">
            <div class="legend-line dotted"></div> Pending
          </div>
          <div class="legend-item">
            <div class="legend-dot" style="background:var(--color-orchestrator)"></div> Orch
          </div>
          <div class="legend-item">
            <div class="legend-dot" style="background:var(--color-coder)"></div> Coder
          </div>
          <div class="legend-item">
            <div class="legend-dot" style="background:var(--color-reviewer)"></div> Review
          </div>
          <div class="legend-item">
            <div class="legend-dot" style="background:var(--color-tester)"></div> Test
          </div>
        </div>

        <svg id="topology-svg" xmlns="http://www.w3.org/2000/svg">
          <defs>
            <marker id="arrowhead" markerWidth="8" markerHeight="6" refX="7" refY="3" orient="auto" markerUnits="userSpaceOnUse">
              <polygon points="0 0, 8 3, 0 6" fill="#6e7681" opacity="0.6"/>
            </marker>
            <marker id="arrowhead-active" markerWidth="8" markerHeight="6" refX="7" refY="3" orient="auto" markerUnits="userSpaceOnUse">
              <polygon points="0 0, 8 3, 0 6" fill="#34D399" opacity="0.7"/>
            </marker>
            <marker id="arrowhead-completed" markerWidth="8" markerHeight="6" refX="7" refY="3" orient="auto" markerUnits="userSpaceOnUse">
              <polygon points="0 0, 8 3, 0 6" fill="#A78BFA" opacity="0.5"/>
            </marker>
            <!-- Glow filter for running nodes -->
            <filter id="glow-running" x="-50%" y="-50%" width="200%" height="200%">
              <feGaussianBlur stdDeviation="4" result="blur"/>
              <feFlood flood-color="#34D399" flood-opacity="0.3" result="color"/>
              <feComposite in="color" in2="blur" operator="in" result="glow"/>
              <feMerge>
                <feMergeNode in="glow"/>
                <feMergeNode in="SourceGraphic"/>
              </feMerge>
            </filter>
            <filter id="glow-verifying" x="-50%" y="-50%" width="200%" height="200%">
              <feGaussianBlur stdDeviation="3" result="blur"/>
              <feFlood flood-color="#FFD866" flood-opacity="0.25" result="color"/>
              <feComposite in="color" in2="blur" operator="in" result="glow"/>
              <feMerge>
                <feMergeNode in="glow"/>
                <feMergeNode in="SourceGraphic"/>
              </feMerge>
            </filter>
          </defs>
          <g id="svg-root">
            <g id="groups-layer"></g>
            <g id="edges-layer"></g>
            <g id="particles-layer"></g>
            <g id="nodes-layer"></g>
            <g id="decisions-layer"></g>
          </g>
        </svg>
      </div>

      <!-- Detail Panel -->
      <div class="detail-panel" id="detail-panel">
        <div class="panel-empty" id="panel-empty">
          <div class="panel-empty-icon">&#9673;</div>
          <div class="panel-empty-text">Select an agent node to<br>view details and activity</div>
          <div class="panel-empty-hint">Click any node on the topology graph</div>
        </div>

        <div id="panel-content" class="hidden" style="display:none;flex-direction:column;height:100%;">
          <div class="panel-header" id="panel-header"></div>
          <div class="panel-tabs" id="panel-tabs">
            <button class="panel-tab active" data-tab="details">Details</button>
            <button class="panel-tab" data-tab="decisions">Decisions</button>
            <button class="panel-tab" data-tab="activity">Activity</button>
          </div>
          <div class="panel-body">
            <div class="panel-tab-content active" id="tab-details"></div>
            <div class="panel-tab-content" id="tab-decisions"></div>
            <div class="panel-tab-content" id="tab-activity"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Tooltip -->
  <div class="node-tooltip" id="node-tooltip"></div>

  <!-- Decision popover container -->
  <div id="popover-container"></div>

  <script>
    // ========================================
    // DATA MODEL
    // ========================================

    const AGENT_TYPES = {
      orchestrator: { icon: '&#9670;', symbol: '\u25C6', color: '#FFD866', label: 'Orchestrator' },
      planner:      { icon: '&#9679;', symbol: '\u25CF', color: '#A78BFA', label: 'Planner' },
      coder:        { icon: '&#9677;', symbol: '\u25CD', color: '#67E8F9', label: 'Coder' },
      reviewer:     { icon: '&#9733;', symbol: '\u2605', color: '#C084FC', label: 'Reviewer' },
      tester:       { icon: '&#9635;', symbol: '\u25A3', color: '#FCA572', label: 'Tester' },
      scanner:      { icon: '&#9651;', symbol: '\u25B3', color: '#F87171', label: 'Scanner' },
      deployer:     { icon: '&#9654;', symbol: '\u25B6', color: '#34D399', label: 'Deployer' }
    };

    const STATUS_COLORS = {
      completed: '#A78BFA',
      running:   '#34D399',
      verifying: '#FFD866',
      blocked:   '#FCA572',
      failed:    '#F87171',
      queued:    '#475569'
    };

    const DECISION_TYPES = {
      auto_verify:  { icon: '\u26A1', color: '#34D399', label: 'Auto Verify' },
      route:        { icon: '\u2461', color: '#67E8F9', label: 'Route' },
      retry:        { icon: '\u21BB', color: '#FCA572', label: 'Retry' },
      escalate:     { icon: '\u25B2', color: '#F87171', label: 'Escalate' },
      spawn:        { icon: '\u25C7', color: '#A78BFA', label: 'Spawn' },
      tool_select:  { icon: '\u2699', color: '#FFD866', label: 'Tool Select' },
      delegate:     { icon: '\u2192', color: '#67E8F9', label: 'Delegate' },
      throttle:     { icon: '\u25D1', color: '#FCA572', label: 'Throttle' },
      prioritize:   { icon: '\u2605', color: '#FFD866', label: 'Prioritize' }
    };

    // Task definitions
    const TASKS = [
      {
        id: 'api-platform',
        name: 'API Platform v2',
        priority: 'P0',
        priorityColor: '#F87171',
        agents: [
          { id: 'ap-orch',   name: 'API Orchestrator',  type: 'orchestrator', children: ['ap-plan'] },
          { id: 'ap-plan',   name: 'API Planner',       type: 'planner',      children: ['ap-code1', 'ap-code2', 'ap-code3'] },
          { id: 'ap-code1',  name: 'Routes Coder',      type: 'coder',        children: ['ap-rev1'] },
          { id: 'ap-code2',  name: 'Models Coder',      type: 'coder',        children: ['ap-rev1'] },
          { id: 'ap-code3',  name: 'Middleware Coder',   type: 'coder',        children: ['ap-rev2'] },
          { id: 'ap-rev1',   name: 'API Reviewer',      type: 'reviewer',     children: ['ap-test1'] },
          { id: 'ap-rev2',   name: 'Security Reviewer',  type: 'reviewer',    children: ['ap-test2'] },
          { id: 'ap-test1',  name: 'Integration Tester', type: 'tester',      children: ['ap-scan'] },
          { id: 'ap-test2',  name: 'Security Tester',    type: 'tester',      children: ['ap-scan'] },
          { id: 'ap-scan',   name: 'Vuln Scanner',       type: 'scanner',     children: [] }
        ]
      },
      {
        id: 'auth-migration',
        name: 'Auth Migration',
        priority: 'P0',
        priorityColor: '#F87171',
        agents: [
          { id: 'am-orch', name: 'Auth Orchestrator', type: 'orchestrator', children: ['am-code1'] },
          { id: 'am-code1', name: 'OAuth Coder',      type: 'coder',        children: ['am-code2'] },
          { id: 'am-code2', name: 'Session Coder',    type: 'coder',        children: ['am-rev'] },
          { id: 'am-rev',   name: 'Auth Reviewer',    type: 'reviewer',     children: ['am-test'] },
          { id: 'am-test',  name: 'Auth Tester',      type: 'tester',       children: [] }
        ]
      },
      {
        id: 'terraform-refactor',
        name: 'Terraform Refactor',
        priority: 'P1',
        priorityColor: '#FFD866',
        agents: [
          { id: 'tf-orch', name: 'TF Orchestrator',  type: 'orchestrator', children: ['tf-plan'] },
          { id: 'tf-plan', name: 'TF Planner',       type: 'planner',      children: ['tf-code1', 'tf-code2'] },
          { id: 'tf-code1', name: 'Module Coder',    type: 'coder',        children: ['tf-rev'] },
          { id: 'tf-code2', name: 'State Coder',     type: 'coder',        children: ['tf-rev'] },
          { id: 'tf-rev',   name: 'TF Reviewer',     type: 'reviewer',     children: ['tf-test'] },
          { id: 'tf-test',  name: 'TF Tester',       type: 'tester',       children: [] }
        ]
      },
      {
        id: 'dashboard-redesign',
        name: 'Dashboard Redesign',
        priority: 'P1',
        priorityColor: '#FFD866',
        agents: [
          { id: 'dr-orch', name: 'UI Orchestrator',   type: 'orchestrator', children: ['dr-code1', 'dr-code2'] },
          { id: 'dr-code1', name: 'Components Coder', type: 'coder',        children: ['dr-rev'] },
          { id: 'dr-code2', name: 'Layout Coder',     type: 'coder',        children: ['dr-rev'] },
          { id: 'dr-rev',   name: 'UI Reviewer',      type: 'reviewer',     children: ['dr-test'] },
          { id: 'dr-test',  name: 'Visual Tester',    type: 'tester',       children: [] }
        ]
      },
      {
        id: 'data-pipeline',
        name: 'Data Pipeline ETL',
        priority: 'P0',
        priorityColor: '#F87171',
        agents: [
          { id: 'dp-orch', name: 'ETL Orchestrator',  type: 'orchestrator', children: ['dp-code1'] },
          { id: 'dp-code1', name: 'Extract Coder',    type: 'coder',        children: ['dp-code2'] },
          { id: 'dp-code2', name: 'Transform Coder',  type: 'coder',        children: ['dp-code3'] },
          { id: 'dp-code3', name: 'Load Coder',       type: 'coder',        children: ['dp-test'] },
          { id: 'dp-test',  name: 'Pipeline Tester',  type: 'tester',       children: [] }
        ]
      },
      {
        id: 'ci-optimization',
        name: 'CI Optimization',
        priority: 'P2',
        priorityColor: '#8b949e',
        agents: [
          { id: 'ci-code', name: 'CI Coder',   type: 'coder',  children: ['ci-test'] },
          { id: 'ci-test', name: 'CI Tester',  type: 'tester', children: [] }
        ]
      }
    ];

    // ========================================
    // SIMULATION STATE
    // ========================================

    let simState = {
      running: true,
      speed: 1,
      tick: 0,
      agents: {},
      decisions: [],
      totalTokens: 0,
      totalCost: 0,
      selectedAgent: null,
      hoveredAgent: null,
      showDecisions: true,
      activeFilters: new Set(),
      zoom: 1,
      panX: 0,
      panY: 0,
      viewBox: { x: 0, y: 0, w: 0, h: 0 }
    };

    // Initialize agent simulation state
    function initAgentStates() {
      for (const task of TASKS) {
        for (const agent of task.agents) {
          simState.agents[agent.id] = {
            ...agent,
            taskId: task.id,
            taskName: task.name,
            status: 'queued',
            progress: 0,
            tokens: 0,
            cost: 0,
            messages: 0,
            turns: 0,
            startedAt: null,
            decisions: [],
            verified: false,
            verificationScore: 0,
            x: 0, y: 0,
            radius: 18,
            targetProgress: 0,
            tokenRate: 800 + Math.random() * 2000
          };
        }
      }
    }

    // ========================================
    // GRAPH LAYOUT
    // ========================================

    function computeLayout() {
      const svg = document.getElementById('topology-svg');
      const rect = svg.getBoundingClientRect();
      const canvasW = rect.width;
      const canvasH = rect.height;

      // Layout tasks in a grid-like arrangement
      const padding = 40;
      const taskPadding = 24;
      const nodeSpacingX = 100;
      const nodeSpacingY = 80;

      // Calculate task sizes first
      const taskLayouts = [];

      for (const task of TASKS) {
        // Build layers using BFS
        const layers = [];
        const visited = new Set();
        const roots = task.agents.filter(a => {
          return !task.agents.some(other => other.children.includes(a.id));
        });

        let currentLayer = roots.map(a => a.id);
        while (currentLayer.length > 0) {
          const layer = currentLayer.filter(id => !visited.has(id));
          if (layer.length === 0) break;
          layers.push(layer);
          layer.forEach(id => visited.add(id));
          const nextLayer = [];
          for (const id of layer) {
            const agent = task.agents.find(a => a.id === id);
            if (agent) {
              for (const childId of agent.children) {
                if (!visited.has(childId)) {
                  nextLayer.push(childId);
                }
              }
            }
          }
          currentLayer = nextLayer;
        }

        // Handle any unvisited agents
        for (const agent of task.agents) {
          if (!visited.has(agent.id)) {
            if (layers.length === 0) layers.push([]);
            layers[layers.length - 1].push(agent.id);
          }
        }

        const maxLayerWidth = Math.max(...layers.map(l => l.length));
        const w = maxLayerWidth * nodeSpacingX + taskPadding * 2;
        const h = layers.length * nodeSpacingY + taskPadding * 2 + 20;

        taskLayouts.push({ task, layers, w, h });
      }

      // Arrange tasks in rows
      const maxRowWidth = canvasW - padding * 2;
      let rows = [[]];
      let currentRowWidth = 0;
      const taskGap = 30;

      for (const tl of taskLayouts) {
        if (currentRowWidth > 0 && currentRowWidth + tl.w + taskGap > maxRowWidth) {
          rows.push([]);
          currentRowWidth = 0;
        }
        rows[rows.length - 1].push(tl);
        currentRowWidth += tl.w + taskGap;
      }

      // Position tasks
      let globalY = padding;
      const groupRects = [];

      for (const row of rows) {
        const totalW = row.reduce((sum, tl) => sum + tl.w, 0) + (row.length - 1) * taskGap;
        let startX = (canvasW - totalW) / 2;
        let maxH = 0;

        for (const tl of row) {
          const gx = startX;
          const gy = globalY;

          groupRects.push({
            taskId: tl.task.id,
            taskName: tl.task.name,
            priority: tl.task.priority,
            priorityColor: tl.task.priorityColor,
            x: gx,
            y: gy,
            w: tl.w,
            h: tl.h
          });

          // Position agents within task
          for (let li = 0; li < tl.layers.length; li++) {
            const layer = tl.layers[li];
            const layerWidth = layer.length * nodeSpacingX;
            const layerStartX = gx + (tl.w - layerWidth) / 2 + nodeSpacingX / 2;

            for (let ni = 0; ni < layer.length; ni++) {
              const agentId = layer[ni];
              if (simState.agents[agentId]) {
                simState.agents[agentId].x = layerStartX + ni * nodeSpacingX;
                simState.agents[agentId].y = gy + taskPadding + 20 + li * nodeSpacingY + nodeSpacingY / 2;
              }
            }
          }

          startX += tl.w + taskGap;
          maxH = Math.max(maxH, tl.h);
        }

        globalY += maxH + taskGap;
      }

      return groupRects;
    }

    // ========================================
    // SVG RENDERING
    // ========================================

    let groupRects = [];

    function renderGraph() {
      groupRects = computeLayout();
      renderGroups();
      renderEdges();
      renderNodes();
      updateViewBox();
    }

    function renderGroups() {
      const layer = document.getElementById('groups-layer');
      layer.innerHTML = '';

      for (const gr of groupRects) {
        // Background rect
        const rect = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
        rect.setAttribute('x', gr.x);
        rect.setAttribute('y', gr.y);
        rect.setAttribute('width', gr.w);
        rect.setAttribute('height', gr.h);
        rect.setAttribute('class', 'task-group-bg');
        rect.setAttribute('data-task', gr.taskId);
        layer.appendChild(rect);

        // Label
        const label = document.createElementNS('http://www.w3.org/2000/svg', 'text');
        label.setAttribute('x', gr.x + 12);
        label.setAttribute('y', gr.y + 16);
        label.setAttribute('class', 'task-group-label');
        label.textContent = gr.taskName;
        layer.appendChild(label);

        // Priority
        const pri = document.createElementNS('http://www.w3.org/2000/svg', 'text');
        pri.setAttribute('x', gr.x + gr.w - 12);
        pri.setAttribute('y', gr.y + 16);
        pri.setAttribute('class', 'task-group-priority');
        pri.setAttribute('text-anchor', 'end');
        pri.setAttribute('fill', gr.priorityColor);
        pri.textContent = gr.priority;
        layer.appendChild(pri);
      }
    }

    function renderEdges() {
      const layer = document.getElementById('edges-layer');
      layer.innerHTML = '';

      for (const task of TASKS) {
        for (const agent of task.agents) {
          for (const childId of agent.children) {
            const parent = simState.agents[agent.id];
            const child = simState.agents[childId];
            if (!parent || !child) continue;

            const edge = document.createElementNS('http://www.w3.org/2000/svg', 'path');
            const dx = child.x - parent.x;
            const dy = child.y - parent.y;
            const mx = parent.x + dx * 0.5;
            const d = `M ${parent.x} ${parent.y + parent.radius + 2} C ${parent.x} ${parent.y + dy * 0.5}, ${child.x} ${parent.y + dy * 0.5}, ${child.x} ${child.y - child.radius - 8}`;

            edge.setAttribute('d', d);
            edge.setAttribute('data-from', agent.id);
            edge.setAttribute('data-to', childId);

            // Determine edge status
            let edgeStatus = 'pending';
            if (parent.status === 'completed' && (child.status === 'completed' || child.status === 'running' || child.status === 'verifying')) {
              edgeStatus = 'completed';
            } else if (parent.status === 'running' || child.status === 'running') {
              edgeStatus = 'running';
            } else if (parent.status === 'blocked' || child.status === 'blocked') {
              edgeStatus = 'blocked';
            } else if (parent.status === 'failed') {
              edgeStatus = 'failed';
            }

            edge.setAttribute('class', `edge-line ${edgeStatus}`);

            if (edgeStatus === 'running') {
              edge.setAttribute('marker-end', 'url(#arrowhead-active)');
            } else if (edgeStatus === 'completed') {
              edge.setAttribute('marker-end', 'url(#arrowhead-completed)');
            } else {
              edge.setAttribute('marker-end', 'url(#arrowhead)');
            }

            layer.appendChild(edge);
          }
        }
      }
    }

    function renderNodes() {
      const layer = document.getElementById('nodes-layer');
      layer.innerHTML = '';

      for (const id of Object.keys(simState.agents)) {
        const agent = simState.agents[id];
        const typeInfo = AGENT_TYPES[agent.type];
        const statusColor = STATUS_COLORS[agent.status] || STATUS_COLORS.queued;
        const nodeSize = Math.max(16, Math.min(28, 16 + (agent.tokens / 50000) * 12));
        agent.radius = nodeSize;

        const g = document.createElementNS('http://www.w3.org/2000/svg', 'g');
        g.setAttribute('class', `agent-node ${simState.selectedAgent === id ? 'selected' : ''}`);
        g.setAttribute('data-id', id);
        g.setAttribute('transform', `translate(${agent.x}, ${agent.y})`);

        // Running pulse
        if (agent.status === 'running') {
          const pulse = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
          pulse.setAttribute('cx', 0);
          pulse.setAttribute('cy', 0);
          pulse.setAttribute('r', nodeSize + 4);
          pulse.setAttribute('fill', statusColor);
          pulse.setAttribute('class', 'running-pulse');
          g.appendChild(pulse);
        }

        // Token usage ring (background)
        if (agent.tokens > 0) {
          const ringBg = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
          ringBg.setAttribute('cx', 0);
          ringBg.setAttribute('cy', 0);
          ringBg.setAttribute('r', nodeSize + 3);
          ringBg.setAttribute('fill', 'none');
          ringBg.setAttribute('stroke', '#21262d');
          ringBg.setAttribute('stroke-width', '2');
          g.appendChild(ringBg);

          // Token ring (progress)
          const circumference = 2 * Math.PI * (nodeSize + 3);
          const tokenPct = Math.min(1, agent.tokens / 100000);
          const ring = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
          ring.setAttribute('cx', 0);
          ring.setAttribute('cy', 0);
          ring.setAttribute('r', nodeSize + 3);
          ring.setAttribute('class', 'node-token-ring');
          ring.setAttribute('stroke', typeInfo.color);
          ring.setAttribute('stroke-dasharray', `${circumference * tokenPct} ${circumference * (1 - tokenPct)}`);
          ring.setAttribute('transform', 'rotate(-90)');
          g.appendChild(ring);
        }

        // Selection ring
        const selRing = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
        selRing.setAttribute('cx', 0);
        selRing.setAttribute('cy', 0);
        selRing.setAttribute('r', nodeSize + 7);
        selRing.setAttribute('stroke', typeInfo.color);
        selRing.setAttribute('class', 'node-ring');
        g.appendChild(selRing);

        // Main circle
        const circle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
        circle.setAttribute('cx', 0);
        circle.setAttribute('cy', 0);
        circle.setAttribute('r', nodeSize);
        circle.setAttribute('fill', typeInfo.color);
        circle.setAttribute('stroke', statusColor);
        circle.setAttribute('class', 'node-bg');
        if (agent.status === 'running') circle.setAttribute('filter', 'url(#glow-running)');
        if (agent.status === 'verifying') circle.setAttribute('filter', 'url(#glow-verifying)');
        g.appendChild(circle);

        // Icon
        const icon = document.createElementNS('http://www.w3.org/2000/svg', 'text');
        icon.setAttribute('x', 0);
        icon.setAttribute('y', 0);
        icon.setAttribute('class', 'node-icon');
        icon.setAttribute('font-size', Math.max(11, nodeSize * 0.7));
        icon.textContent = typeInfo.symbol;
        g.appendChild(icon);

        // Status dot
        const statusDot = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
        statusDot.setAttribute('cx', nodeSize * 0.7);
        statusDot.setAttribute('cy', -nodeSize * 0.7);
        statusDot.setAttribute('class', 'node-status-dot');
        statusDot.setAttribute('fill', statusColor);
        g.appendChild(statusDot);

        // Name label
        const label = document.createElementNS('http://www.w3.org/2000/svg', 'text');
        label.setAttribute('x', 0);
        label.setAttribute('y', nodeSize + 14);
        label.setAttribute('class', 'node-label');
        label.textContent = agent.name.length > 14 ? agent.name.substring(0, 12) + '..' : agent.name;
        g.appendChild(label);

        // Progress bar (small under label)
        if (agent.progress > 0 && agent.status !== 'completed') {
          const barW = 30;
          const barBg = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
          barBg.setAttribute('x', -barW / 2);
          barBg.setAttribute('y', nodeSize + 19);
          barBg.setAttribute('width', barW);
          barBg.setAttribute('height', 2);
          barBg.setAttribute('rx', 1);
          barBg.setAttribute('fill', '#21262d');
          g.appendChild(barBg);

          const barFill = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
          barFill.setAttribute('x', -barW / 2);
          barFill.setAttribute('y', nodeSize + 19);
          barFill.setAttribute('width', barW * (agent.progress / 100));
          barFill.setAttribute('height', 2);
          barFill.setAttribute('rx', 1);
          barFill.setAttribute('fill', statusColor);
          g.appendChild(barFill);
        }

        // Events
        g.addEventListener('mouseenter', (e) => showTooltip(id, e));
        g.addEventListener('mouseleave', hideTooltip);
        g.addEventListener('click', (e) => { e.stopPropagation(); selectAgent(id); });

        layer.appendChild(g);
      }
    }

    function renderDecisions() {
      const layer = document.getElementById('decisions-layer');
      layer.innerHTML = '';

      if (!simState.showDecisions) return;

      for (const decision of simState.decisions) {
        const agent = simState.agents[decision.agentId];
        if (!agent) continue;

        // Check filter
        if (simState.activeFilters.size > 0 && !simState.activeFilters.has(agent.taskId)) continue;

        const dt = DECISION_TYPES[decision.type];
        if (!dt) continue;

        const g = document.createElementNS('http://www.w3.org/2000/svg', 'g');
        g.setAttribute('class', 'decision-badge');
        g.setAttribute('transform', `translate(${agent.x + agent.radius + 6}, ${agent.y - agent.radius - 2})`);

        const bg = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
        bg.setAttribute('x', -10);
        bg.setAttribute('y', -10);
        bg.setAttribute('width', 20);
        bg.setAttribute('height', 20);
        bg.setAttribute('class', 'decision-badge-bg');
        bg.setAttribute('fill', dt.color + '22');
        bg.setAttribute('stroke', dt.color + '66');
        g.appendChild(bg);

        const icon = document.createElementNS('http://www.w3.org/2000/svg', 'text');
        icon.setAttribute('x', 0);
        icon.setAttribute('y', 1);
        icon.setAttribute('class', 'decision-badge-icon');
        icon.setAttribute('fill', dt.color);
        icon.textContent = dt.icon;
        g.appendChild(icon);

        g.addEventListener('click', (e) => {
          e.stopPropagation();
          showDecisionPopover(decision, e);
        });

        layer.appendChild(g);
      }
    }

    function renderParticles() {
      const layer = document.getElementById('particles-layer');
      layer.innerHTML = '';

      for (const task of TASKS) {
        for (const agent of task.agents) {
          const parent = simState.agents[agent.id];
          if (!parent || parent.status !== 'running' && parent.status !== 'completed') continue;

          for (const childId of agent.children) {
            const child = simState.agents[childId];
            if (!child || child.status !== 'running') continue;

            // Create flowing particles
            const numParticles = 3;
            for (let i = 0; i < numParticles; i++) {
              const t = ((simState.tick * 0.02 * simState.speed + i / numParticles) % 1);
              const x = parent.x + (child.x - parent.x) * t;
              const cy = parent.y + parent.radius + 2;
              const cy2 = child.y - child.radius - 8;
              const midY = (cy + cy2) / 2;
              // Simple bezier interpolation
              const y = (1-t)*(1-t)*cy + 2*(1-t)*t*midY + t*t*cy2;

              const particle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
              particle.setAttribute('cx', x);
              particle.setAttribute('cy', y);
              particle.setAttribute('class', 'flow-particle');
              particle.setAttribute('fill', '#34D399');
              particle.setAttribute('r', 2 + Math.sin(t * Math.PI) * 1.5);
              particle.setAttribute('opacity', 0.3 + Math.sin(t * Math.PI) * 0.5);
              layer.appendChild(particle);
            }
          }
        }
      }
    }

    // ========================================
    // VIEW CONTROLS
    // ========================================

    function updateViewBox() {
      const svg = document.getElementById('topology-svg');
      const rect = svg.getBoundingClientRect();

      // Calculate bounds of all content
      let minX = Infinity, minY = Infinity, maxX = -Infinity, maxY = -Infinity;

      for (const gr of groupRects) {
        minX = Math.min(minX, gr.x);
        minY = Math.min(minY, gr.y);
        maxX = Math.max(maxX, gr.x + gr.w);
        maxY = Math.max(maxY, gr.y + gr.h);
      }

      const contentW = maxX - minX + 80;
      const contentH = maxY - minY + 80;
      const cx = minX - 40 + contentW / 2;
      const cy = minY - 40 + contentH / 2;

      const vw = rect.width / simState.zoom;
      const vh = rect.height / simState.zoom;

      simState.viewBox = {
        x: cx - vw / 2 + simState.panX,
        y: cy - vh / 2 + simState.panY,
        w: vw,
        h: vh
      };

      svg.setAttribute('viewBox', `${simState.viewBox.x} ${simState.viewBox.y} ${simState.viewBox.w} ${simState.viewBox.h}`);
    }

    function zoomIn() {
      simState.zoom = Math.min(3, simState.zoom * 1.2);
      updateViewBox();
      document.getElementById('zoom-label').textContent = Math.round(simState.zoom * 100) + '%';
    }

    function zoomOut() {
      simState.zoom = Math.max(0.3, simState.zoom / 1.2);
      updateViewBox();
      document.getElementById('zoom-label').textContent = Math.round(simState.zoom * 100) + '%';
    }

    function fitView() {
      simState.zoom = 1;
      simState.panX = 0;
      simState.panY = 0;
      updateViewBox();
      document.getElementById('zoom-label').textContent = '100%';
    }

    function centerView() {
      simState.panX = 0;
      simState.panY = 0;
      updateViewBox();
    }

    // Pan & zoom handlers
    (function setupCanvasInteraction() {
      const svg = document.getElementById('topology-svg');
      let isPanning = false;
      let startX, startY;

      svg.addEventListener('mousedown', (e) => {
        if (e.target === svg || e.target.classList.contains('task-group-bg')) {
          isPanning = true;
          startX = e.clientX;
          startY = e.clientY;
          svg.classList.add('dragging');
        }
      });

      window.addEventListener('mousemove', (e) => {
        if (!isPanning) return;
        const dx = (e.clientX - startX) / simState.zoom;
        const dy = (e.clientY - startY) / simState.zoom;
        simState.panX -= dx;
        simState.panY -= dy;
        startX = e.clientX;
        startY = e.clientY;
        updateViewBox();
      });

      window.addEventListener('mouseup', () => {
        isPanning = false;
        svg.classList.remove('dragging');
      });

      svg.addEventListener('wheel', (e) => {
        e.preventDefault();
        const delta = e.deltaY > 0 ? 0.9 : 1.1;
        simState.zoom = Math.min(3, Math.max(0.3, simState.zoom * delta));
        updateViewBox();
        document.getElementById('zoom-label').textContent = Math.round(simState.zoom * 100) + '%';
      }, { passive: false });

      // Click on empty space deselects
      svg.addEventListener('click', (e) => {
        if (e.target === svg || e.target.classList.contains('task-group-bg')) {
          deselectAgent();
        }
      });
    })();

    // ========================================
    // TOOLTIP
    // ========================================

    function showTooltip(agentId, event) {
      if (simState.selectedAgent === agentId) return;
      simState.hoveredAgent = agentId;
      const agent = simState.agents[agentId];
      const typeInfo = AGENT_TYPES[agent.type];
      const statusColor = STATUS_COLORS[agent.status];
      const tooltip = document.getElementById('node-tooltip');

      tooltip.innerHTML = `
        <div class="tooltip-name" style="color:${typeInfo.color}">${agent.name}</div>
        <div class="tooltip-row"><span class="label">Type</span><span class="value" style="color:${typeInfo.color};font-family:var(--font-sans)">${typeInfo.label}</span></div>
        <div class="tooltip-row"><span class="label">Status</span><span class="value" style="color:${statusColor};font-family:var(--font-sans)">${agent.status}</span></div>
        <div class="tooltip-row"><span class="label">Progress</span><span class="value">${Math.round(agent.progress)}%</span></div>
        <div class="tooltip-row"><span class="label">Tokens</span><span class="value">${formatNumber(agent.tokens)}</span></div>
        <div class="tooltip-row"><span class="label">Cost</span><span class="value" style="color:#FFD866">$${agent.cost.toFixed(2)}</span></div>
        <div class="tooltip-progress"><div class="tooltip-progress-fill" style="width:${agent.progress}%;background:${statusColor}"></div></div>
      `;

      const rect = event.target.closest('.agent-node').getBoundingClientRect();
      tooltip.style.left = (rect.right + 12) + 'px';
      tooltip.style.top = rect.top + 'px';
      tooltip.classList.add('visible');
    }

    function hideTooltip() {
      simState.hoveredAgent = null;
      document.getElementById('node-tooltip').classList.remove('visible');
    }

    // ========================================
    // AGENT SELECTION & DETAIL PANEL
    // ========================================

    function selectAgent(agentId) {
      simState.selectedAgent = agentId;
      hideTooltip();
      updateNodeSelectionClasses();
      updateDetailPanel();
    }

    function deselectAgent() {
      simState.selectedAgent = null;
      updateNodeSelectionClasses();
      document.getElementById('panel-empty').classList.remove('hidden');
      document.getElementById('panel-content').classList.add('hidden');
      document.getElementById('panel-content').style.display = 'none';
    }

    function updateNodeSelectionClasses() {
      document.querySelectorAll('.agent-node').forEach(node => {
        if (node.getAttribute('data-id') === simState.selectedAgent) {
          node.classList.add('selected');
        } else {
          node.classList.remove('selected');
        }
      });
    }

    function updateDetailPanel() {
      const agent = simState.agents[simState.selectedAgent];
      if (!agent) return;

      document.getElementById('panel-empty').classList.add('hidden');
      const pc = document.getElementById('panel-content');
      pc.classList.remove('hidden');
      pc.style.display = 'flex';

      const typeInfo = AGENT_TYPES[agent.type];
      const statusColor = STATUS_COLORS[agent.status];

      // Header
      document.getElementById('panel-header').innerHTML = `
        <div class="panel-agent-icon" style="background:${typeInfo.color}">${typeInfo.symbol}</div>
        <div class="panel-agent-info">
          <div class="panel-agent-name">${agent.name}</div>
          <div class="panel-agent-meta">
            <span class="panel-agent-type" style="color:${typeInfo.color}">${typeInfo.label}</span>
            <span class="status-badge ${agent.status}"><span class="dot"></span>${agent.status}</span>
          </div>
        </div>
        <button class="panel-close" onclick="deselectAgent()">&times;</button>
      `;

      // Details tab
      updateDetailsTab(agent, typeInfo, statusColor);

      // Decisions tab
      updateDecisionsTab(agent);

      // Activity tab
      updateActivityTab(agent);
    }

    function updateDetailsTab(agent, typeInfo, statusColor) {
      const task = TASKS.find(t => t.id === agent.taskId);

      // Find parent and children
      let parentAgent = null;
      const childAgents = [];
      if (task) {
        for (const a of task.agents) {
          if (a.children.includes(agent.id)) parentAgent = simState.agents[a.id];
          if (agent.children.includes(a.id)) childAgents.push(simState.agents[a.id]);
        }
      }

      let html = `
        <div class="panel-section">
          <div class="panel-section-title">Task</div>
          <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px">
            <span style="font-size:12px;font-weight:500;color:var(--fg-default)">${agent.taskName}</span>
            <span style="font-size:10px;font-family:var(--font-mono);color:${task ? task.priorityColor : '#8b949e'}">${task ? task.priority : ''}</span>
          </div>
        </div>

        <div class="panel-section">
          <div class="panel-section-title">Progress</div>
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px">
            <span style="font-size:20px;font-weight:600;font-family:var(--font-mono);color:${statusColor}">${Math.round(agent.progress)}%</span>
            <span style="font-size:11px;color:var(--fg-subtle)">${agent.turns} turns</span>
          </div>
          <div class="progress-bar-container">
            <div class="progress-bar-fill" style="width:${agent.progress}%;background:${statusColor}"></div>
          </div>
        </div>

        <div class="panel-section">
          <div class="panel-section-title">Metrics</div>
          <div class="stat-grid">
            <div class="stat-item">
              <div class="stat-label">Tokens</div>
              <div class="stat-value">${formatNumber(agent.tokens)}</div>
            </div>
            <div class="stat-item">
              <div class="stat-label">Cost</div>
              <div class="stat-value cost">$${agent.cost.toFixed(2)}</div>
            </div>
            <div class="stat-item">
              <div class="stat-label">Messages</div>
              <div class="stat-value">${agent.messages}</div>
            </div>
            <div class="stat-item">
              <div class="stat-label">Turns</div>
              <div class="stat-value">${agent.turns}</div>
            </div>
          </div>
        </div>

        <div class="panel-section">
          <div class="panel-section-title">Verification</div>
          <div class="verification-status">
            ${agent.verified
              ? `<span class="verification-icon" style="color:var(--status-completed)">\u2713</span>
                 <span class="verification-text"><strong>Verified</strong> - Score ${agent.verificationScore}%</span>`
              : agent.status === 'verifying'
                ? `<span class="verification-icon" style="color:var(--status-verifying)">\u23F3</span>
                   <span class="verification-text"><strong>Verifying</strong> - ${agent.verificationScore}% checked</span>`
                : `<span class="verification-icon" style="color:var(--fg-subtle)">\u25CB</span>
                   <span class="verification-text">Not yet verified</span>`
            }
          </div>
        </div>

        <div class="panel-section">
          <div class="panel-section-title">Relationships</div>
          ${parentAgent ? `
            <div class="relationship-item">
              <span class="relationship-arrow">\u2190</span>
              <span class="relationship-dot" style="background:${AGENT_TYPES[parentAgent.type].color}"></span>
              <span class="relationship-name">${parentAgent.name}</span>
              <span class="relationship-status" style="color:${STATUS_COLORS[parentAgent.status]}">${parentAgent.status}</span>
            </div>
          ` : ''}
          ${childAgents.map(c => `
            <div class="relationship-item">
              <span class="relationship-arrow">\u2192</span>
              <span class="relationship-dot" style="background:${AGENT_TYPES[c.type].color}"></span>
              <span class="relationship-name">${c.name}</span>
              <span class="relationship-status" style="color:${STATUS_COLORS[c.status]}">${c.status}</span>
            </div>
          `).join('')}
          ${!parentAgent && childAgents.length === 0 ? '<div style="font-size:11px;color:var(--fg-subtle)">No connections</div>' : ''}
        </div>
      `;

      document.getElementById('tab-details').innerHTML = html;
    }

    function updateDecisionsTab(agent) {
      const agentDecisions = simState.decisions.filter(d => d.agentId === agent.id);

      if (agentDecisions.length === 0) {
        document.getElementById('tab-decisions').innerHTML = `
          <div class="panel-section" style="text-align:center;padding:32px 16px">
            <div style="font-size:24px;opacity:0.3;margin-bottom:8px">\u26A1</div>
            <div style="font-size:12px;color:var(--fg-subtle)">No decisions yet</div>
          </div>
        `;
        return;
      }

      const html = `<div class="panel-section">
        <div class="panel-section-title">Recent Decisions (${agentDecisions.length})</div>
        ${agentDecisions.slice(-10).reverse().map(d => {
          const dt = DECISION_TYPES[d.type];
          return `
            <div class="decision-feed-item" onclick="showDecisionPopover(window._decisions[${simState.decisions.indexOf(d)}], event)">
              <div class="decision-feed-icon" style="background:${dt.color}22;color:${dt.color}">${dt.icon}</div>
              <div class="decision-feed-content">
                <div class="decision-feed-type" style="color:${dt.color}">${dt.label}</div>
                <div class="decision-feed-summary">${d.summary}</div>
              </div>
              <div class="decision-feed-time">${d.time}</div>
            </div>
          `;
        }).join('')}
      </div>`;

      document.getElementById('tab-decisions').innerHTML = html;
    }

    function updateActivityTab(agent) {
      const activities = generateActivityLog(agent);

      document.getElementById('tab-activity').innerHTML = `
        <div class="panel-section">
          <div class="panel-section-title">Activity Log</div>
          ${activities.map(a => `
            <div class="activity-item">
              <span class="activity-time">${a.time}</span>
              <span class="activity-text">${a.text}</span>
            </div>
          `).join('')}
        </div>
      `;
    }

    function generateActivityLog(agent) {
      const logs = [];
      if (agent.status !== 'queued') {
        logs.push({ time: '0:00', text: `<strong>Started</strong> - Agent initialized` });
      }
      if (agent.progress > 10) {
        logs.push({ time: '0:15', text: `Scanning workspace files` });
      }
      if (agent.progress > 25) {
        logs.push({ time: '0:32', text: `<strong>Planning</strong> - Analyzing dependencies` });
      }
      if (agent.progress > 40) {
        logs.push({ time: '1:05', text: `Writing code in <strong>${agent.name.split(' ')[0].toLowerCase()}</strong> module` });
      }
      if (agent.progress > 60) {
        logs.push({ time: '2:10', text: `Running <strong>tests</strong> - 12/15 passing` });
      }
      if (agent.progress > 80) {
        logs.push({ time: '3:20', text: `Code review cycle completed` });
      }
      if (agent.status === 'completed') {
        logs.push({ time: '4:00', text: `<strong>Completed</strong> - All checks passed` });
      }
      if (agent.status === 'failed') {
        logs.push({ time: '2:45', text: `<strong>Failed</strong> - Build error in test suite` });
      }
      return logs.reverse();
    }

    // ========================================
    // DECISION POPOVER
    // ========================================

    // Store decisions globally for click handlers
    window._decisions = [];

    function showDecisionPopover(decision, event) {
      const dt = DECISION_TYPES[decision.type];
      const agent = simState.agents[decision.agentId];
      const container = document.getElementById('popover-container');

      const confColor = decision.confidence >= 85 ? '#34D399' : decision.confidence >= 60 ? '#FFD866' : '#F87171';

      container.innerHTML = `
        <div class="popover-overlay" onclick="closePopover()"></div>
        <div class="decision-popover" style="left:${Math.min(event.clientX + 10, window.innerWidth - 360)}px;top:${Math.min(event.clientY - 20, window.innerHeight - 400)}px">
          <div class="popover-header">
            <div class="popover-icon" style="background:${dt.color}22;color:${dt.color}">${dt.icon}</div>
            <div>
              <div class="popover-title">${dt.label}</div>
              <div class="popover-subtitle">${agent ? agent.name : 'Unknown'} &middot; ${decision.time}</div>
            </div>
          </div>
          <div class="popover-body">
            <div class="popover-section">
              <div class="popover-label">Summary</div>
              <div class="popover-text">${decision.summary}</div>
            </div>
            <div class="popover-section">
              <div class="popover-label">Detail</div>
              <div class="popover-text">${decision.detail}</div>
            </div>
            <div class="popover-section">
              <div class="popover-label">Confidence</div>
              <div class="confidence-value" style="color:${confColor}">${decision.confidence}%</div>
              <div class="confidence-bar-bg">
                <div class="confidence-bar-fill" style="width:${decision.confidence}%;background:${confColor}"></div>
              </div>
              <div class="confidence-markers">
                <span class="confidence-marker">0</span>
                <span class="confidence-marker" style="color:${decision.confidence >= 60 ? '#FFD866' : 'var(--fg-subtle)'}">60</span>
                <span class="confidence-marker" style="color:${decision.confidence >= 85 ? '#34D399' : 'var(--fg-subtle)'}">85</span>
                <span class="confidence-marker">100</span>
              </div>
            </div>
            <div class="popover-section">
              <div class="popover-label">Criteria</div>
              <div class="popover-tag-list">
                ${decision.criteria.map(c => `<span class="popover-tag">${c}</span>`).join('')}
              </div>
            </div>
            <div class="popover-section">
              <div class="popover-label">Alternatives</div>
              ${decision.alternatives.map(a => `
                <div class="popover-alternative">
                  <span class="popover-alternative-name">${a.name}</span>
                  <span class="popover-alternative-score">${a.score}%</span>
                </div>
              `).join('')}
            </div>
          </div>
          <div class="popover-footer">
            <span class="popover-policy">${decision.policy}</span>
            <button class="override-btn" onclick="closePopover()">Override</button>
          </div>
        </div>
      `;
    }

    function closePopover() {
      document.getElementById('popover-container').innerHTML = '';
    }

    // ========================================
    // TASK FILTER CHIPS
    // ========================================

    function buildFilterChips() {
      const container = document.getElementById('task-filters');
      container.innerHTML = '';

      const allChip = document.createElement('button');
      allChip.className = `task-filter-chip ${simState.activeFilters.size === 0 ? 'active' : ''}`;
      allChip.innerHTML = `All <span class="count">${Object.keys(simState.agents).length}</span>`;
      allChip.onclick = () => {
        simState.activeFilters.clear();
        buildFilterChips();
        renderGraph();
      };
      container.appendChild(allChip);

      for (const task of TASKS) {
        const chip = document.createElement('button');
        chip.className = `task-filter-chip ${simState.activeFilters.has(task.id) ? 'active' : ''}`;
        chip.innerHTML = `${task.name.split(' ').slice(0, 2).join(' ')} <span class="count">${task.agents.length}</span>`;
        chip.onclick = () => {
          if (simState.activeFilters.has(task.id)) {
            simState.activeFilters.delete(task.id);
          } else {
            simState.activeFilters.add(task.id);
          }
          buildFilterChips();
          // Don't re-layout, just highlight
          updateGroupHighlights();
        };
        container.appendChild(chip);
      }
    }

    function updateGroupHighlights() {
      document.querySelectorAll('.task-group-bg').forEach(rect => {
        const taskId = rect.getAttribute('data-task');
        if (simState.activeFilters.size === 0 || simState.activeFilters.has(taskId)) {
          rect.style.opacity = '1';
        } else {
          rect.style.opacity = '0.2';
        }
      });

      document.querySelectorAll('.agent-node').forEach(node => {
        const id = node.getAttribute('data-id');
        const agent = simState.agents[id];
        if (simState.activeFilters.size === 0 || simState.activeFilters.has(agent.taskId)) {
          node.style.opacity = '1';
        } else {
          node.style.opacity = '0.15';
        }
      });
    }

    // ========================================
    // PANEL TAB SWITCHING
    // ========================================

    document.querySelectorAll('.panel-tab').forEach(tab => {
      tab.addEventListener('click', () => {
        document.querySelectorAll('.panel-tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.panel-tab-content').forEach(c => c.classList.remove('active'));
        tab.classList.add('active');
        document.getElementById(`tab-${tab.dataset.tab}`).classList.add('active');
      });
    });

    // ========================================
    // SIMULATION ENGINE
    // ========================================

    const DECISION_SUMMARIES = {
      auto_verify: [
        'All tests passing, auto-approving changes',
        'Code coverage above threshold, verification passed',
        'Lint and type checks clean, auto-verified'
      ],
      route: [
        'Routing to specialized coder for database module',
        'Delegating UI components to frontend specialist',
        'Assigning infrastructure task to DevOps agent'
      ],
      retry: [
        'Test flake detected, retrying with fresh context',
        'Build timeout, retrying with extended limits',
        'Network error during API call, attempting retry'
      ],
      escalate: [
        'Critical security finding requires human review',
        'Breaking change detected, escalating to architect',
        'Resource limit exceeded, needs manual intervention'
      ],
      spawn: [
        'Spawning parallel workers for batch processing',
        'Creating sub-agent for isolated module testing',
        'Forking agent for concurrent API development'
      ],
      tool_select: [
        'Selected grep for codebase search over AST',
        'Choosing TypeScript compiler API for type analysis',
        'Using Docker SDK for container management'
      ],
      delegate: [
        'Delegating review to specialized reviewer agent',
        'Passing security scan to dedicated scanner',
        'Handing off deployment to deployer agent'
      ],
      throttle: [
        'Reducing concurrency due to rate limits',
        'Throttling API calls to respect quotas',
        'Slowing batch size for memory management'
      ],
      prioritize: [
        'Prioritizing critical path tasks first',
        'Reordering queue by dependency depth',
        'Moving blocking task to front of queue'
      ]
    };

    const DECISION_DETAILS = {
      auto_verify: 'Automated verification passed all 47 checks including unit tests, integration tests, and static analysis. No manual review required based on policy thresholds.',
      route: 'Analysis of task requirements determined specialized handling needed. Routing based on agent capability matching and current workload distribution.',
      retry: 'Transient failure detected. Previous attempt showed intermittent behavior consistent with a flaky dependency. Retrying with incremental backoff strategy.',
      escalate: 'Issue severity exceeds automated handling threshold. Human oversight required per security policy before proceeding with changes.',
      spawn: 'Workload analysis indicates parallel execution would reduce completion time by approximately 60%. Spawning workers with isolated contexts.',
      tool_select: 'Evaluated available tools against task requirements. Selected tool provides best accuracy for current file types and analysis depth needed.',
      delegate: 'Current agent lacks specialized capability for this sub-task. Delegation to expert agent improves quality and reduces iteration cycles.',
      throttle: 'External API rate limit approaching threshold. Proactively reducing request frequency to avoid hard blocks and maintain steady progress.',
      prioritize: 'Dependency analysis revealed critical path optimization opportunity. Reordering execution queue to minimize overall completion time.'
    };

    function generateDecision(agentId) {
      const types = Object.keys(DECISION_TYPES);
      const type = types[Math.floor(Math.random() * types.length)];
      const summaries = DECISION_SUMMARIES[type];
      const summary = summaries[Math.floor(Math.random() * summaries.length)];

      const minutes = Math.floor(simState.tick / 60);
      const seconds = simState.tick % 60;
      const time = `${minutes}:${seconds.toString().padStart(2, '0')}`;

      const decision = {
        type,
        agentId,
        summary,
        detail: DECISION_DETAILS[type],
        confidence: 55 + Math.floor(Math.random() * 40),
        time,
        criteria: ['latency', 'accuracy', 'cost', 'coverage'].sort(() => Math.random() - 0.5).slice(0, 2 + Math.floor(Math.random() * 2)),
        alternatives: [
          { name: 'Alternative A', score: 30 + Math.floor(Math.random() * 40) },
          { name: 'Alternative B', score: 20 + Math.floor(Math.random() * 30) }
        ],
        policy: 'auto-' + ['verify', 'route', 'delegate'][Math.floor(Math.random() * 3)] + '-v2.1'
      };

      simState.decisions.push(decision);
      window._decisions = simState.decisions;

      const agent = simState.agents[agentId];
      if (agent) agent.decisions.push(decision);

      return decision;
    }

    // Agent status progression order based on dependencies
    function getAgentOrder(task) {
      const order = [];
      const visited = new Set();

      function visit(id) {
        if (visited.has(id)) return;
        visited.add(id);
        const agent = task.agents.find(a => a.id === id);
        if (!agent) return;
        // Visit parents first
        for (const other of task.agents) {
          if (other.children.includes(id)) {
            visit(other.id);
          }
        }
        order.push(id);
      }

      for (const agent of task.agents) {
        visit(agent.id);
      }

      return order;
    }

    function canStart(agentId) {
      const agent = simState.agents[agentId];
      if (!agent) return false;

      // Find the task
      const task = TASKS.find(t => t.id === agent.taskId);
      if (!task) return false;

      // Check all parents are completed
      for (const other of task.agents) {
        if (other.children.includes(agentId)) {
          const parentState = simState.agents[other.id];
          if (parentState.status !== 'completed') return false;
        }
      }

      return true;
    }

    function isRoot(agentId) {
      const agent = simState.agents[agentId];
      if (!agent) return false;
      const task = TASKS.find(t => t.id === agent.taskId);
      if (!task) return false;
      return !task.agents.some(a => a.children.includes(agentId));
    }

    function simulationTick() {
      if (!simState.running) return;

      simState.tick += simState.speed;

      for (const id of Object.keys(simState.agents)) {
        const agent = simState.agents[id];

        switch (agent.status) {
          case 'queued':
            // Root agents start first, others wait for parents
            if (isRoot(id)) {
              if (simState.tick > 5 + Math.random() * 30) {
                agent.status = 'running';
                agent.startedAt = simState.tick;
              }
            } else if (canStart(id)) {
              agent.status = 'running';
              agent.startedAt = simState.tick;
            }
            break;

          case 'running':
            // Progress
            const speed = (0.2 + Math.random() * 0.5) * simState.speed;
            agent.progress = Math.min(100, agent.progress + speed);
            agent.tokens += Math.floor(agent.tokenRate * speed * 0.02);
            agent.cost = agent.tokens * 0.000003;
            agent.messages += Math.random() < 0.05 * simState.speed ? 1 : 0;
            agent.turns += Math.random() < 0.02 * simState.speed ? 1 : 0;

            // Random decisions
            if (Math.random() < 0.003 * simState.speed) {
              generateDecision(id);
            }

            // Transition to verifying
            if (agent.progress >= 100) {
              agent.progress = 100;
              agent.status = 'verifying';
              agent.verificationScore = 0;
            }

            // Rare: failure
            if (Math.random() < 0.0005 * simState.speed && agent.progress > 30 && agent.progress < 90) {
              agent.status = 'failed';
              generateDecision(id);
            }

            // Rare: blocked
            if (Math.random() < 0.0003 * simState.speed && agent.progress > 20 && agent.progress < 70) {
              agent.status = 'blocked';
            }
            break;

          case 'verifying':
            agent.verificationScore += (0.5 + Math.random() * 1) * simState.speed;
            if (agent.verificationScore >= 100) {
              agent.verificationScore = 100;
              agent.verified = true;
              agent.status = 'completed';
              if (Math.random() < 0.5) generateDecision(id);
            }
            break;

          case 'blocked':
            // Unblock after some time
            if (Math.random() < 0.01 * simState.speed) {
              agent.status = 'running';
              generateDecision(id);
            }
            break;

          case 'failed':
            // Retry after delay
            if (Math.random() < 0.005 * simState.speed) {
              agent.status = 'running';
              agent.progress = Math.max(0, agent.progress - 20);
              generateDecision(id);
            }
            break;

          case 'completed':
            // Stay completed
            break;
        }
      }

      // Update global metrics
      updateMetrics();
    }

    function updateMetrics() {
      const agents = Object.values(simState.agents);
      const active = agents.filter(a => a.status === 'running' || a.status === 'verifying').length;
      const total = agents.length;
      const tokens = agents.reduce((sum, a) => sum + a.tokens, 0);
      const cost = agents.reduce((sum, a) => sum + a.cost, 0);

      document.getElementById('metric-active').textContent = active;
      document.getElementById('metric-total').textContent = total;
      document.getElementById('metric-tokens').textContent = formatNumber(tokens);
      document.getElementById('metric-cost').textContent = '$' + cost.toFixed(2);
      document.getElementById('metric-decisions').textContent = simState.decisions.length;
    }

    function formatNumber(n) {
      if (n >= 1000000) return (n / 1000000).toFixed(1) + 'M';
      if (n >= 1000) return (n / 1000).toFixed(1) + 'K';
      return n.toString();
    }

    // ========================================
    // RENDER LOOP
    // ========================================

    let lastRenderTime = 0;
    const RENDER_INTERVAL = 50; // ~20fps for SVG updates

    function renderLoop(timestamp) {
      if (timestamp - lastRenderTime >= RENDER_INTERVAL) {
        simulationTick();

        // Only do full re-render of nodes periodically
        renderEdges();
        renderNodes();
        renderParticles();
        renderDecisions();
        updateGroupHighlights();

        // Update detail panel if agent is selected
        if (simState.selectedAgent) {
          updateDetailPanel();
        }

        lastRenderTime = timestamp;
      }

      requestAnimationFrame(renderLoop);
    }

    // ========================================
    // CONTROLS
    // ========================================

    document.getElementById('sim-play').addEventListener('click', function() {
      simState.running = !simState.running;
      this.innerHTML = simState.running ? '&#9654;' : '&#9646;&#9646;';
      this.classList.toggle('active', simState.running);
    });

    document.getElementById('sim-fast').addEventListener('click', function() {
      if (simState.speed === 1) {
        simState.speed = 2;
        document.getElementById('speed-label').textContent = '2x';
        this.classList.add('active');
      } else if (simState.speed === 2) {
        simState.speed = 5;
        document.getElementById('speed-label').textContent = '5x';
      } else {
        simState.speed = 1;
        document.getElementById('speed-label').textContent = '1x';
        this.classList.remove('active');
      }
    });

    document.getElementById('sim-reset').addEventListener('click', function() {
      simState.tick = 0;
      simState.decisions = [];
      window._decisions = [];
      simState.selectedAgent = null;

      for (const id of Object.keys(simState.agents)) {
        const agent = simState.agents[id];
        agent.status = 'queued';
        agent.progress = 0;
        agent.tokens = 0;
        agent.cost = 0;
        agent.messages = 0;
        agent.turns = 0;
        agent.startedAt = null;
        agent.decisions = [];
        agent.verified = false;
        agent.verificationScore = 0;
      }

      deselectAgent();
      updateMetrics();
    });

    document.getElementById('decision-toggle').addEventListener('click', function() {
      simState.showDecisions = !simState.showDecisions;
      this.classList.toggle('active', simState.showDecisions);
    });

    // ========================================
    // INITIALIZATION
    // ========================================

    function init() {
      initAgentStates();
      renderGraph();
      buildFilterChips();
      requestAnimationFrame(renderLoop);

      // Re-layout on resize
      window.addEventListener('resize', () => {
        renderGraph();
        buildFilterChips();
      });
    }

    init();
  </script>
</body>
</html>
