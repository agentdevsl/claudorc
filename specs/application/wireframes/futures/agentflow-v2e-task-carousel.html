<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AgentFlow v2e â€” Task Carousel Topology | AgentPane</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@300;400;500;600&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    /* ========================================
       Reset & Foundation
       ======================================== */
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    html { -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; }
    ul, ol { list-style: none; }
    button { cursor: pointer; border: none; background: none; font: inherit; color: inherit; }
    input { font: inherit; color: inherit; }

    :root {
      --bg-canvas: #0d1117;
      --bg-default: #161b22;
      --bg-subtle: #1c2128;
      --bg-muted: #21262d;
      --bg-emphasis: #30363d;
      --fg-default: #e6edf3;
      --fg-muted: #8b949e;
      --fg-subtle: #6e7681;
      --fg-on-emphasis: #ffffff;
      --border-default: #30363d;
      --border-muted: #21262d;
      --accent-fg: #58a6ff;
      --accent-emphasis: #1f6feb;
      --accent-muted: rgba(56, 139, 253, 0.15);
      --success-fg: #3fb950;
      --danger-fg: #f85149;
      --attention-fg: #d29922;
      --done-fg: #a371f7;
      --font-sans: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif;
      --font-mono: 'Fira Code', 'SF Mono', Menlo, Consolas, monospace;
      --radius-sm: 4px;
      --radius: 6px;
      --radius-lg: 12px;
      --radius-full: 9999px;
      --duration-fast: 150ms;
      --duration-normal: 200ms;
      --duration-slow: 300ms;
      --easing: cubic-bezier(0.25, 1, 0.5, 1);

      --color-orchestrator: #FFD866;
      --color-planner: #A78BFA;
      --color-coder: #67E8F9;
      --color-reviewer: #C084FC;
      --color-tester: #FCA572;
      --color-scanner: #F87171;
      --color-deployer: #34D399;

      --status-completed: #A78BFA;
      --status-running: #34D399;
      --status-verifying: #FFD866;
      --status-blocked: #FCA572;
      --status-failed: #F87171;
      --status-queued: #475569;
    }

    body {
      font-family: var(--font-sans);
      font-size: 13px;
      color: var(--fg-default);
      background: var(--bg-canvas);
      height: 100vh;
      overflow: hidden;
    }

    /* Breathing grid background */
    @keyframes gridBreathe {
      0%, 100% { background-position: 0 0, 0 0; }
      50% { background-position: 4px 4px, 4px 4px; }
    }

    body::after {
      content: '';
      position: fixed;
      inset: 0;
      background-image:
        linear-gradient(rgba(88, 166, 255, 0.015) 1px, transparent 1px),
        linear-gradient(90deg, rgba(88, 166, 255, 0.015) 1px, transparent 1px);
      background-size: 32px 32px;
      pointer-events: none;
      z-index: 0;
      animation: gridBreathe 20s ease-in-out infinite;
    }

    body::before {
      content: '';
      position: fixed;
      inset: 0;
      background:
        radial-gradient(ellipse 900px 500px at 30% 30%, rgba(88, 166, 255, 0.03), transparent),
        radial-gradient(ellipse 700px 400px at 70% 70%, rgba(52, 211, 153, 0.02), transparent);
      pointer-events: none;
      z-index: 0;
    }

    /* ========================================
       Layout
       ======================================== */
    .page {
      display: flex;
      flex-direction: column;
      height: 100vh;
      position: relative;
      z-index: 1;
    }

    /* ========================================
       Header (48px)
       ======================================== */
    .header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 20px;
      height: 48px;
      border-bottom: 1px solid var(--border-default);
      background: rgba(13, 17, 23, 0.92);
      backdrop-filter: blur(12px);
      flex-shrink: 0;
      z-index: 50;
    }

    .header-left { display: flex; align-items: center; gap: 16px; }
    .header-center { display: flex; align-items: center; gap: 12px; }
    .header-right { display: flex; align-items: center; gap: 8px; }

    .logo {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 14px;
      font-weight: 600;
      color: var(--fg-default);
      letter-spacing: -0.02em;
    }

    .logo-icon {
      width: 24px; height: 24px;
      background: linear-gradient(135deg, var(--accent-fg), var(--done-fg));
      border-radius: 6px;
      display: flex; align-items: center; justify-content: center;
      font-size: 12px; color: white; font-weight: 700;
    }

    .logo-badge {
      font-size: 10px; padding: 2px 6px;
      background: var(--accent-muted);
      color: var(--accent-fg);
      border-radius: var(--radius-full);
      font-weight: 500;
    }

    .sim-controls {
      display: flex; align-items: center; gap: 6px;
      padding: 4px 8px;
      background: var(--bg-default);
      border: 1px solid var(--border-default);
      border-radius: var(--radius);
    }

    .sim-btn {
      display: flex; align-items: center; justify-content: center;
      width: 28px; height: 28px;
      border-radius: var(--radius-sm);
      transition: all var(--duration-fast) var(--easing);
      font-size: 14px;
    }
    .sim-btn:hover { background: var(--bg-subtle); }
    .sim-btn.active { background: var(--accent-muted); color: var(--accent-fg); }

    .speed-indicator {
      font-size: 11px; font-family: var(--font-mono);
      color: var(--fg-subtle); padding: 0 4px;
      min-width: 28px; text-align: center;
    }

    .metric-pill {
      display: flex; align-items: center; gap: 6px;
      padding: 4px 10px;
      background: var(--bg-default);
      border: 1px solid var(--border-default);
      border-radius: var(--radius-full);
      font-size: 11px; font-family: var(--font-mono);
    }
    .metric-pill .label { color: var(--fg-subtle); }
    .metric-pill .value { color: var(--fg-default); font-weight: 500; }
    .metric-pill .value.running { color: var(--status-running); }
    .metric-pill .value.cost { color: var(--color-orchestrator); }

    .decision-toggle {
      display: flex; align-items: center; gap: 6px;
      padding: 4px 10px;
      background: var(--bg-default);
      border: 1px solid var(--border-default);
      border-radius: var(--radius-full);
      font-size: 11px; cursor: pointer;
      transition: all var(--duration-fast) var(--easing);
    }
    .decision-toggle:hover { border-color: var(--fg-subtle); }
    .decision-toggle.active { border-color: var(--accent-fg); background: var(--accent-muted); }
    .decision-toggle .dot { width: 6px; height: 6px; border-radius: 50%; background: var(--fg-subtle); }
    .decision-toggle.active .dot { background: var(--accent-fg); }

    /* ========================================
       Task Strip (56px)
       ======================================== */
    .task-strip-container {
      flex-shrink: 0;
      border-bottom: 1px solid var(--border-default);
      background: rgba(13, 17, 23, 0.88);
      backdrop-filter: blur(8px);
      z-index: 40;
    }

    .task-strip {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 20px;
      overflow-x: auto;
      scrollbar-width: none;
      height: 56px;
    }
    .task-strip::-webkit-scrollbar { display: none; }

    .task-pill {
      flex-shrink: 0;
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 6px 14px;
      background: var(--bg-default);
      border: 1px solid var(--border-muted);
      border-radius: var(--radius-lg);
      cursor: pointer;
      transition: all 0.25s var(--easing);
      position: relative;
      min-width: 180px;
    }

    .task-pill:hover {
      border-color: var(--fg-subtle);
      background: var(--bg-subtle);
      transform: translateY(-1px);
    }

    .task-pill.active {
      border-color: var(--accent-fg);
      background: rgba(56, 139, 253, 0.08);
      transform: scale(1.02);
      box-shadow: 0 0 20px rgba(56, 139, 253, 0.1);
    }

    .task-pill.active::after {
      content: '';
      position: absolute;
      bottom: -9px;
      left: 50%;
      transform: translateX(-50%);
      width: 32px;
      height: 3px;
      background: var(--accent-fg);
      border-radius: var(--radius-full);
    }

    .task-pill-donut {
      position: relative;
      width: 28px; height: 28px;
      flex-shrink: 0;
    }

    .task-pill-donut svg { width: 28px; height: 28px; }

    .task-pill-donut .donut-pct {
      position: absolute;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 8px;
      font-family: var(--font-mono);
      font-weight: 600;
      color: var(--fg-muted);
    }

    .task-pill-info { flex: 1; min-width: 0; }

    .task-pill-name {
      font-size: 12px;
      font-weight: 600;
      color: var(--fg-default);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      line-height: 1.3;
    }

    .task-pill-meta {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 10px;
    }

    .task-pill-priority {
      font-family: var(--font-mono);
      font-weight: 600;
      font-size: 9px;
      padding: 1px 5px;
      border-radius: var(--radius-sm);
    }

    .task-pill-agents {
      display: flex;
      align-items: center;
      gap: 3px;
      font-family: var(--font-mono);
      color: var(--fg-subtle);
      font-size: 10px;
    }

    @keyframes agentPulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    .task-pill-agents .pulse-dot {
      width: 5px; height: 5px;
      border-radius: 50%;
      background: var(--status-running);
      animation: agentPulse 1.5s ease-in-out infinite;
    }

    .task-pill-kbd {
      position: absolute;
      top: 4px; right: 6px;
      font-size: 9px;
      font-family: var(--font-mono);
      color: var(--fg-subtle);
      opacity: 0.4;
    }

    /* ========================================
       Status Summary Strip
       ======================================== */
    .status-summary {
      display: flex;
      align-items: center;
      gap: 14px;
      padding: 4px 20px;
      background: rgba(22, 27, 34, 0.6);
      border-bottom: 1px solid var(--border-muted);
      font-size: 11px;
      color: var(--fg-muted);
      flex-shrink: 0;
      height: 24px;
    }

    .status-summary-item {
      display: flex;
      align-items: center;
      gap: 5px;
    }

    .status-summary-dot {
      width: 6px; height: 6px;
      border-radius: 50%;
    }

    .status-summary-label { font-family: var(--font-mono); font-size: 11px; }

    /* ========================================
       Main Canvas Area
       ======================================== */
    .main-area {
      flex: 1;
      display: flex;
      overflow: hidden;
      position: relative;
    }

    .canvas-area {
      flex: 1;
      position: relative;
      overflow: hidden;
      min-width: 0;
      transition: margin-right 0.3s var(--easing);
    }

    .canvas-area.panel-open { margin-right: 0; }

    .canvas-toolbar {
      position: absolute;
      top: 12px; left: 12px;
      display: flex; gap: 4px;
      z-index: 20;
      background: rgba(22, 27, 34, 0.9);
      backdrop-filter: blur(8px);
      border: 1px solid var(--border-default);
      border-radius: var(--radius);
      padding: 4px;
    }

    .canvas-toolbar button {
      display: flex; align-items: center; justify-content: center;
      width: 28px; height: 28px;
      border-radius: var(--radius-sm);
      font-size: 13px; color: var(--fg-muted);
      transition: all var(--duration-fast) var(--easing);
    }
    .canvas-toolbar button:hover { background: var(--bg-subtle); color: var(--fg-default); }
    .canvas-toolbar .separator { width: 1px; background: var(--border-default); margin: 2px; }

    .zoom-indicator {
      position: absolute;
      bottom: 12px; left: 12px;
      z-index: 20;
      font-size: 11px; font-family: var(--font-mono);
      color: var(--fg-subtle);
      background: rgba(22, 27, 34, 0.9);
      backdrop-filter: blur(8px);
      border: 1px solid var(--border-default);
      border-radius: var(--radius);
      padding: 4px 8px;
    }

    .canvas-legend {
      position: absolute;
      bottom: 12px; right: 12px;
      z-index: 20;
      display: flex; gap: 12px;
      padding: 6px 12px;
      background: rgba(22, 27, 34, 0.9);
      backdrop-filter: blur(8px);
      border: 1px solid var(--border-default);
      border-radius: var(--radius);
      font-size: 10px; color: var(--fg-subtle);
    }

    .legend-item { display: flex; align-items: center; gap: 4px; }
    .legend-dot { width: 8px; height: 8px; border-radius: 50%; }
    .legend-line { width: 16px; height: 2px; border-radius: 1px; }
    .legend-line.solid { background: var(--status-completed); }
    .legend-line.dashed { background: repeating-linear-gradient(90deg, var(--status-running) 0, var(--status-running) 4px, transparent 4px, transparent 7px); }
    .legend-line.dotted { background: repeating-linear-gradient(90deg, var(--fg-subtle) 0, var(--fg-subtle) 2px, transparent 2px, transparent 5px); }

    /* SVG Canvas */
    #topology-svg {
      width: 100%; height: 100%;
      cursor: grab;
    }
    #topology-svg.dragging { cursor: grabbing; }

    /* ========================================
       SVG Styles
       ======================================== */
    .edge-line {
      fill: none;
      stroke-width: 1.8;
    }
    .edge-line.completed { stroke: var(--status-completed); opacity: 0.5; }
    .edge-line.running {
      stroke: var(--status-running); opacity: 0.7;
      stroke-dasharray: 8 5;
    }
    .edge-line.pending { stroke: var(--fg-subtle); opacity: 0.25; stroke-dasharray: 3 5; }
    .edge-line.blocked { stroke: var(--status-blocked); opacity: 0.4; stroke-dasharray: 4 4; }
    .edge-line.failed { stroke: var(--status-failed); opacity: 0.5; }

    @keyframes dashFlow {
      to { stroke-dashoffset: -26; }
    }
    .edge-line.running { animation: dashFlow 1s linear infinite; }

    .agent-node {
      cursor: pointer;
      transition: transform 0.15s var(--easing);
    }
    .agent-node:hover { transform: scale(1.05); }
    .agent-node:hover .node-ring { opacity: 0.6; }

    .node-bg {
      stroke-width: 2.5;
      transition: all var(--duration-fast) var(--easing);
    }

    .node-ring {
      fill: none;
      stroke-width: 1.5;
      opacity: 0;
      transition: opacity var(--duration-fast) var(--easing);
    }

    .node-icon {
      font-size: 16px;
      text-anchor: middle;
      dominant-baseline: central;
      fill: var(--bg-canvas);
      font-weight: 700;
    }

    .node-label {
      font-family: var(--font-sans);
      font-size: 12px;
      font-weight: 500;
      fill: var(--fg-muted);
      text-anchor: middle;
    }

    .node-status-dot { stroke: var(--bg-canvas); stroke-width: 2.5; }

    .node-progress-ring {
      fill: none;
      stroke-width: 3;
      stroke-linecap: round;
    }

    .flow-particle { opacity: 0.9; }

    .agent-node.selected .node-ring { opacity: 1; stroke-width: 2.5; }
    .agent-node.selected .node-bg { stroke-width: 3.5; }

    @keyframes nodePulse {
      0%, 100% { opacity: 0.12; }
      50% { opacity: 0.28; }
    }
    .running-pulse { animation: nodePulse 2s ease-in-out infinite; }

    @keyframes spinRing {
      to { transform: rotate(360deg); }
    }
    .verifying-spin { animation: spinRing 2.5s linear infinite; transform-origin: center; }

    @keyframes selectionBounce {
      0% { r: 40; opacity: 0.8; }
      50% { r: 44; opacity: 1; }
      100% { r: 42; opacity: 0.9; }
    }

    .decision-badge { cursor: pointer; }
    .decision-badge-bg { rx: 4; ry: 4; stroke-width: 1; }
    .decision-badge-icon {
      font-size: 9px; text-anchor: middle;
      dominant-baseline: central; font-weight: 600;
    }

    @keyframes decisionPulse {
      0%, 100% { opacity: 0.6; }
      50% { opacity: 1; }
    }
    .decision-badge { animation: decisionPulse 2s ease-in-out infinite; }

    /* ========================================
       Slide-out Detail Panel (380px)
       ======================================== */
    .detail-panel {
      position: absolute;
      top: 0; right: 0; bottom: 0;
      width: 380px;
      background: rgba(22, 27, 34, 0.95);
      backdrop-filter: blur(16px);
      border-left: 1px solid var(--border-default);
      display: flex;
      flex-direction: column;
      z-index: 30;
      transform: translateX(100%);
      transition: transform 0.3s var(--easing);
      box-shadow: -8px 0 32px rgba(0,0,0,0.3);
    }

    .detail-panel.open { transform: translateX(0); }

    .panel-header {
      padding: 16px;
      background: rgba(13, 17, 23, 0.6);
      backdrop-filter: blur(12px);
      border-bottom: 1px solid var(--border-default);
      display: flex;
      align-items: flex-start;
      gap: 12px;
    }

    .panel-agent-icon {
      width: 44px; height: 44px;
      border-radius: 50%;
      display: flex; align-items: center; justify-content: center;
      font-size: 20px; font-weight: 700;
      color: var(--bg-canvas);
      flex-shrink: 0;
    }

    .panel-agent-info { flex: 1; min-width: 0; }
    .panel-agent-name {
      font-size: 15px; font-weight: 600;
      color: var(--fg-default);
      margin-bottom: 3px;
      white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
    }
    .panel-agent-meta { display: flex; align-items: center; gap: 8px; font-size: 11px; }
    .panel-agent-type { color: var(--fg-muted); text-transform: capitalize; }

    .panel-close {
      width: 28px; height: 28px;
      display: flex; align-items: center; justify-content: center;
      border-radius: var(--radius-sm);
      color: var(--fg-subtle); flex-shrink: 0;
      transition: all var(--duration-fast) var(--easing);
    }
    .panel-close:hover { background: var(--bg-subtle); color: var(--fg-default); }

    .status-badge {
      display: inline-flex; align-items: center; gap: 4px;
      padding: 2px 8px;
      border-radius: var(--radius-full);
      font-size: 11px; font-weight: 500;
    }
    .status-badge .dot { width: 6px; height: 6px; border-radius: 50%; }
    .status-badge.completed { background: rgba(167,139,250,0.15); color: #A78BFA; }
    .status-badge.completed .dot { background: #A78BFA; }
    .status-badge.running { background: rgba(52,211,153,0.15); color: #34D399; }
    .status-badge.running .dot { background: #34D399; }
    .status-badge.verifying { background: rgba(255,216,102,0.15); color: #FFD866; }
    .status-badge.verifying .dot { background: #FFD866; }
    .status-badge.blocked { background: rgba(252,165,114,0.15); color: #FCA572; }
    .status-badge.blocked .dot { background: #FCA572; }
    .status-badge.failed { background: rgba(248,113,113,0.15); color: #F87171; }
    .status-badge.failed .dot { background: #F87171; }
    .status-badge.queued { background: rgba(71,85,105,0.25); color: #8b949e; }
    .status-badge.queued .dot { background: #475569; }

    .panel-tabs {
      display: flex;
      border-bottom: 1px solid var(--border-muted);
      padding: 0 16px;
    }
    .panel-tab {
      padding: 8px 12px;
      font-size: 11px; font-weight: 500;
      color: var(--fg-subtle);
      border-bottom: 2px solid transparent;
      margin-bottom: -1px;
      transition: all var(--duration-fast) var(--easing);
    }
    .panel-tab:hover { color: var(--fg-muted); }
    .panel-tab.active { color: var(--fg-default); border-bottom-color: var(--accent-fg); }

    .panel-body {
      flex: 1;
      overflow-y: auto;
      overflow-x: hidden;
    }
    .panel-body::-webkit-scrollbar { width: 6px; }
    .panel-body::-webkit-scrollbar-track { background: transparent; }
    .panel-body::-webkit-scrollbar-thumb { background: var(--bg-emphasis); border-radius: 3px; }
    .panel-body::-webkit-scrollbar-thumb:hover { background: var(--fg-subtle); }

    .panel-tab-content { display: none; }
    .panel-tab-content.active { display: block; }

    .panel-section {
      padding: 12px 16px;
      border-bottom: 1px solid var(--border-muted);
    }
    .panel-section-title {
      font-size: 10px; font-weight: 600;
      color: var(--fg-subtle);
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin-bottom: 8px;
    }

    .stat-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
    .stat-item {
      padding: 8px;
      background: var(--bg-subtle);
      border-radius: var(--radius);
      border: 1px solid var(--border-muted);
    }
    .stat-label { font-size: 10px; color: var(--fg-subtle); margin-bottom: 2px; }
    .stat-value {
      font-size: 14px; font-weight: 600;
      font-family: var(--font-mono);
      color: var(--fg-default);
    }
    .stat-value.cost { color: var(--color-orchestrator); }

    .progress-bar-container {
      height: 6px;
      background: var(--bg-emphasis);
      border-radius: var(--radius-full);
      overflow: hidden;
      margin-top: 6px;
    }
    .progress-bar-fill {
      height: 100%;
      border-radius: var(--radius-full);
      transition: width 0.5s var(--easing);
    }

    .relationship-item { display: flex; align-items: center; gap: 8px; padding: 6px 0; }
    .relationship-dot { width: 8px; height: 8px; border-radius: 50%; flex-shrink: 0; }
    .relationship-name { font-size: 12px; color: var(--fg-default); flex: 1; }
    .relationship-status { font-size: 10px; color: var(--fg-subtle); }
    .relationship-arrow { font-size: 10px; color: var(--fg-subtle); margin-right: 2px; }

    .verification-status {
      display: flex; align-items: center; gap: 8px;
      padding: 8px 12px;
      background: var(--bg-subtle);
      border-radius: var(--radius);
      border: 1px solid var(--border-muted);
    }
    .verification-icon { font-size: 16px; }
    .verification-text { font-size: 12px; color: var(--fg-muted); }
    .verification-text strong { color: var(--fg-default); font-weight: 500; }

    .decision-feed-item {
      display: flex; gap: 8px; padding: 8px 0;
      cursor: pointer; border-radius: var(--radius-sm);
      transition: background var(--duration-fast) var(--easing);
    }
    .decision-feed-item:hover { background: var(--bg-subtle); margin: 0 -4px; padding: 8px 4px; }
    .decision-feed-icon {
      width: 24px; height: 24px;
      border-radius: var(--radius-sm);
      display: flex; align-items: center; justify-content: center;
      font-size: 12px; flex-shrink: 0;
    }
    .decision-feed-content { flex: 1; min-width: 0; }
    .decision-feed-type { font-size: 11px; font-weight: 600; margin-bottom: 1px; }
    .decision-feed-summary {
      font-size: 11px; color: var(--fg-muted);
      white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
    }
    .decision-feed-time {
      font-size: 10px; font-family: var(--font-mono);
      color: var(--fg-subtle); flex-shrink: 0;
    }

    .activity-item { display: flex; gap: 8px; padding: 6px 0; font-size: 11px; }
    .activity-time {
      font-family: var(--font-mono); color: var(--fg-subtle);
      flex-shrink: 0; font-size: 10px; padding-top: 1px;
    }
    .activity-text { color: var(--fg-muted); line-height: 1.4; }
    .activity-text strong { color: var(--fg-default); font-weight: 500; }

    /* ========================================
       Decision Popover
       ======================================== */
    .popover-overlay { position: fixed; inset: 0; z-index: 100; }
    .decision-popover {
      position: fixed; width: 340px;
      background: var(--bg-default);
      border: 1px solid var(--border-default);
      border-radius: var(--radius-lg);
      box-shadow: 0 16px 48px rgba(0,0,0,0.35);
      z-index: 101; overflow: hidden;
      animation: popoverIn 0.2s var(--easing);
    }
    @keyframes popoverIn {
      from { opacity: 0; transform: scale(0.95) translateY(-4px); }
      to { opacity: 1; transform: scale(1) translateY(0); }
    }
    .popover-header {
      padding: 12px 16px;
      border-bottom: 1px solid var(--border-muted);
      display: flex; align-items: center; gap: 8px;
    }
    .popover-icon {
      width: 28px; height: 28px;
      border-radius: var(--radius);
      display: flex; align-items: center; justify-content: center;
      font-size: 14px;
    }
    .popover-title { font-size: 13px; font-weight: 600; color: var(--fg-default); }
    .popover-subtitle { font-size: 11px; color: var(--fg-muted); }
    .popover-body { padding: 12px 16px; }
    .popover-section { margin-bottom: 12px; }
    .popover-section:last-child { margin-bottom: 0; }
    .popover-label {
      font-size: 10px; font-weight: 600;
      color: var(--fg-subtle);
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin-bottom: 4px;
    }
    .popover-text { font-size: 12px; color: var(--fg-muted); line-height: 1.5; }
    .confidence-bar-bg {
      height: 8px; background: var(--bg-emphasis);
      border-radius: var(--radius-full);
      overflow: hidden;
    }
    .confidence-bar-fill { height: 100%; border-radius: var(--radius-full); transition: width 0.5s var(--easing); }
    .confidence-markers { display: flex; justify-content: space-between; margin-top: 2px; }
    .confidence-marker { font-size: 9px; font-family: var(--font-mono); color: var(--fg-subtle); }
    .confidence-value { font-size: 13px; font-weight: 600; font-family: var(--font-mono); margin-bottom: 4px; }
    .popover-tag-list { display: flex; flex-wrap: wrap; gap: 4px; }
    .popover-tag {
      padding: 2px 8px; font-size: 10px;
      border-radius: var(--radius-full);
      background: var(--bg-emphasis); color: var(--fg-muted);
    }
    .popover-alternative {
      display: flex; align-items: center; justify-content: space-between;
      padding: 4px 0; font-size: 11px;
    }
    .popover-alternative-name { color: var(--fg-muted); }
    .popover-alternative-score { font-family: var(--font-mono); color: var(--fg-subtle); }
    .popover-footer {
      padding: 8px 16px 12px;
      display: flex; align-items: center; justify-content: space-between;
    }
    .popover-policy { font-size: 10px; color: var(--fg-subtle); font-family: var(--font-mono); }
    .override-btn {
      padding: 4px 12px; font-size: 11px; font-weight: 500;
      border-radius: var(--radius);
      border: 1px solid var(--border-default);
      color: var(--fg-muted); background: var(--bg-subtle);
      transition: all var(--duration-fast) var(--easing);
    }
    .override-btn:hover { border-color: var(--fg-subtle); color: var(--fg-default); }

    /* ========================================
       Tooltip
       ======================================== */
    .node-tooltip {
      position: fixed; pointer-events: none;
      z-index: 200;
      padding: 10px 12px;
      background: rgba(22, 27, 34, 0.95);
      backdrop-filter: blur(8px);
      border: 1px solid var(--border-default);
      border-radius: var(--radius);
      box-shadow: 0 8px 24px rgba(0,0,0,0.3);
      font-size: 11px; min-width: 180px;
      opacity: 0;
      transition: opacity var(--duration-fast) var(--easing);
    }
    .node-tooltip.visible { opacity: 1; }
    .tooltip-row { display: flex; justify-content: space-between; align-items: center; padding: 2px 0; }
    .tooltip-row .label { color: var(--fg-subtle); }
    .tooltip-row .value { color: var(--fg-default); font-weight: 500; font-family: var(--font-mono); }
    .tooltip-name {
      font-size: 12px; font-weight: 600;
      color: var(--fg-default);
      margin-bottom: 4px; padding-bottom: 4px;
      border-bottom: 1px solid var(--border-muted);
    }
    .tooltip-progress {
      margin-top: 4px; height: 3px;
      background: var(--bg-emphasis);
      border-radius: var(--radius-full);
      overflow: hidden;
    }
    .tooltip-progress-fill { height: 100%; border-radius: var(--radius-full); }

    /* ========================================
       Keyboard hint
       ======================================== */
    .kbd-hint {
      position: absolute;
      bottom: 12px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 20;
      display: flex;
      gap: 16px;
      padding: 5px 14px;
      background: rgba(22, 27, 34, 0.85);
      backdrop-filter: blur(8px);
      border: 1px solid var(--border-muted);
      border-radius: var(--radius);
      font-size: 10px;
      color: var(--fg-subtle);
    }
    .kbd-hint kbd {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      min-width: 18px;
      height: 18px;
      padding: 0 4px;
      background: var(--bg-emphasis);
      border: 1px solid var(--border-default);
      border-radius: 3px;
      font-family: var(--font-mono);
      font-size: 9px;
      color: var(--fg-muted);
    }

    .hidden { display: none !important; }
  </style>
</head>
<body>
  <div class="page">
    <!-- Header -->
    <header class="header">
      <div class="header-left">
        <div class="logo">
          <div class="logo-icon">A</div>
          AgentFlow
          <span class="logo-badge">CAROUSEL</span>
        </div>
      </div>
      <div class="header-center">
        <div class="sim-controls">
          <button class="sim-btn" id="sim-reset" title="Reset"><span style="font-size:12px">&#8634;</span></button>
          <button class="sim-btn active" id="sim-play" title="Play/Pause">&#9654;</button>
          <button class="sim-btn" id="sim-fast" title="Fast Forward">&#9654;&#9654;</button>
          <span class="speed-indicator" id="speed-label">1x</span>
        </div>
        <div class="metric-pill">
          <span class="label">Agents</span>
          <span class="value running" id="metric-active">0</span>
          <span class="label">/</span>
          <span class="value" id="metric-total">33</span>
        </div>
        <div class="metric-pill">
          <span class="label">Tokens</span>
          <span class="value" id="metric-tokens">0</span>
        </div>
        <div class="metric-pill">
          <span class="label">Cost</span>
          <span class="value cost" id="metric-cost">$0.00</span>
        </div>
        <div class="metric-pill">
          <span class="label">Decisions</span>
          <span class="value" id="metric-decisions">0</span>
        </div>
      </div>
      <div class="header-right">
        <div class="decision-toggle active" id="decision-toggle">
          <span class="dot"></span>
          <span>Decisions</span>
        </div>
      </div>
    </header>

    <!-- Task Strip -->
    <div class="task-strip-container">
      <div class="task-strip" id="task-strip"></div>
    </div>

    <!-- Status Summary -->
    <div class="status-summary" id="status-summary"></div>

    <!-- Main Canvas -->
    <div class="main-area">
      <div class="canvas-area" id="canvas-area">
        <div class="canvas-toolbar">
          <button title="Zoom In" onclick="zoomIn()">+</button>
          <button title="Zoom Out" onclick="zoomOut()">&minus;</button>
          <button title="Fit View" onclick="fitView()">&#9724;</button>
          <div class="separator"></div>
          <button title="Center" onclick="centerView()">&#8982;</button>
        </div>

        <div class="zoom-indicator" id="zoom-label">100%</div>

        <div class="canvas-legend">
          <div class="legend-item"><div class="legend-line solid"></div> Completed</div>
          <div class="legend-item"><div class="legend-line dashed"></div> Active</div>
          <div class="legend-item"><div class="legend-line dotted"></div> Pending</div>
          <div class="legend-item"><div class="legend-dot" style="background:var(--color-orchestrator)"></div> Orch</div>
          <div class="legend-item"><div class="legend-dot" style="background:var(--color-coder)"></div> Coder</div>
          <div class="legend-item"><div class="legend-dot" style="background:var(--color-reviewer)"></div> Review</div>
          <div class="legend-item"><div class="legend-dot" style="background:var(--color-tester)"></div> Test</div>
        </div>

        <div class="kbd-hint">
          <span><kbd>&larr;</kbd> <kbd>&rarr;</kbd> Switch task</span>
          <span><kbd>1</kbd>-<kbd>6</kbd> Jump to task</span>
          <span><kbd>Esc</kbd> Close panel</span>
        </div>

        <svg id="topology-svg" xmlns="http://www.w3.org/2000/svg">
          <defs>
            <marker id="arrowhead" markerWidth="8" markerHeight="6" refX="7" refY="3" orient="auto" markerUnits="userSpaceOnUse">
              <polygon points="0 0, 8 3, 0 6" fill="#6e7681" opacity="0.6"/>
            </marker>
            <marker id="arrowhead-active" markerWidth="8" markerHeight="6" refX="7" refY="3" orient="auto" markerUnits="userSpaceOnUse">
              <polygon points="0 0, 8 3, 0 6" fill="#34D399" opacity="0.7"/>
            </marker>
            <marker id="arrowhead-completed" markerWidth="8" markerHeight="6" refX="7" refY="3" orient="auto" markerUnits="userSpaceOnUse">
              <polygon points="0 0, 8 3, 0 6" fill="#A78BFA" opacity="0.5"/>
            </marker>
            <filter id="glow-running" x="-50%" y="-50%" width="200%" height="200%">
              <feGaussianBlur stdDeviation="6" result="blur"/>
              <feFlood flood-color="#34D399" flood-opacity="0.35" result="color"/>
              <feComposite in="color" in2="blur" operator="in" result="glow"/>
              <feMerge><feMergeNode in="glow"/><feMergeNode in="SourceGraphic"/></feMerge>
            </filter>
            <filter id="glow-verifying" x="-50%" y="-50%" width="200%" height="200%">
              <feGaussianBlur stdDeviation="5" result="blur"/>
              <feFlood flood-color="#FFD866" flood-opacity="0.3" result="color"/>
              <feComposite in="color" in2="blur" operator="in" result="glow"/>
              <feMerge><feMergeNode in="glow"/><feMergeNode in="SourceGraphic"/></feMerge>
            </filter>
            <!-- Agent type glows -->
            <filter id="glow-orchestrator" x="-50%" y="-50%" width="200%" height="200%">
              <feGaussianBlur stdDeviation="4" result="blur"/>
              <feFlood flood-color="#FFD866" flood-opacity="0.2" result="color"/>
              <feComposite in="color" in2="blur" operator="in" result="glow"/>
              <feMerge><feMergeNode in="glow"/><feMergeNode in="SourceGraphic"/></feMerge>
            </filter>
            <filter id="glow-planner" x="-50%" y="-50%" width="200%" height="200%">
              <feGaussianBlur stdDeviation="4" result="blur"/>
              <feFlood flood-color="#A78BFA" flood-opacity="0.2" result="color"/>
              <feComposite in="color" in2="blur" operator="in" result="glow"/>
              <feMerge><feMergeNode in="glow"/><feMergeNode in="SourceGraphic"/></feMerge>
            </filter>
            <filter id="glow-coder" x="-50%" y="-50%" width="200%" height="200%">
              <feGaussianBlur stdDeviation="4" result="blur"/>
              <feFlood flood-color="#67E8F9" flood-opacity="0.2" result="color"/>
              <feComposite in="color" in2="blur" operator="in" result="glow"/>
              <feMerge><feMergeNode in="glow"/><feMergeNode in="SourceGraphic"/></feMerge>
            </filter>
            <filter id="glow-reviewer" x="-50%" y="-50%" width="200%" height="200%">
              <feGaussianBlur stdDeviation="4" result="blur"/>
              <feFlood flood-color="#C084FC" flood-opacity="0.2" result="color"/>
              <feComposite in="color" in2="blur" operator="in" result="glow"/>
              <feMerge><feMergeNode in="glow"/><feMergeNode in="SourceGraphic"/></feMerge>
            </filter>
            <filter id="glow-tester" x="-50%" y="-50%" width="200%" height="200%">
              <feGaussianBlur stdDeviation="4" result="blur"/>
              <feFlood flood-color="#FCA572" flood-opacity="0.2" result="color"/>
              <feComposite in="color" in2="blur" operator="in" result="glow"/>
              <feMerge><feMergeNode in="glow"/><feMergeNode in="SourceGraphic"/></feMerge>
            </filter>
            <filter id="glow-scanner" x="-50%" y="-50%" width="200%" height="200%">
              <feGaussianBlur stdDeviation="4" result="blur"/>
              <feFlood flood-color="#F87171" flood-opacity="0.2" result="color"/>
              <feComposite in="color" in2="blur" operator="in" result="glow"/>
              <feMerge><feMergeNode in="glow"/><feMergeNode in="SourceGraphic"/></feMerge>
            </filter>
            <!-- Gradient defs will be added dynamically -->
          </defs>
          <g id="svg-root">
            <g id="edges-layer"></g>
            <g id="particles-layer"></g>
            <g id="nodes-layer"></g>
            <g id="decisions-layer"></g>
          </g>
        </svg>
      </div>

      <!-- Detail Panel (slide-out) -->
      <div class="detail-panel" id="detail-panel">
        <div class="panel-header" id="panel-header"></div>
        <div class="panel-tabs" id="panel-tabs">
          <button class="panel-tab active" data-tab="details">Details</button>
          <button class="panel-tab" data-tab="decisions">Decisions</button>
          <button class="panel-tab" data-tab="activity">Activity</button>
        </div>
        <div class="panel-body">
          <div class="panel-tab-content active" id="tab-details"></div>
          <div class="panel-tab-content" id="tab-decisions"></div>
          <div class="panel-tab-content" id="tab-activity"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Tooltip -->
  <div class="node-tooltip" id="node-tooltip"></div>

  <!-- Decision popover container -->
  <div id="popover-container"></div>

  <script>
    // ========================================
    // DATA MODEL
    // ========================================

    const AGENT_TYPES = {
      orchestrator: { icon: '&#9670;', symbol: '\u25C6', color: '#FFD866', label: 'Orchestrator' },
      planner:      { icon: '&#9679;', symbol: '\u25CF', color: '#A78BFA', label: 'Planner' },
      coder:        { icon: '&#9677;', symbol: '\u25CD', color: '#67E8F9', label: 'Coder' },
      reviewer:     { icon: '&#9733;', symbol: '\u2605', color: '#C084FC', label: 'Reviewer' },
      tester:       { icon: '&#9635;', symbol: '\u25A3', color: '#FCA572', label: 'Tester' },
      scanner:      { icon: '&#9651;', symbol: '\u25B3', color: '#F87171', label: 'Scanner' },
      deployer:     { icon: '&#9654;', symbol: '\u25B6', color: '#34D399', label: 'Deployer' }
    };

    const STATUS_COLORS = {
      completed: '#A78BFA',
      running:   '#34D399',
      verifying: '#FFD866',
      blocked:   '#FCA572',
      failed:    '#F87171',
      queued:    '#475569'
    };

    const DECISION_TYPES = {
      auto_verify:  { icon: '\u26A1', color: '#34D399', label: 'Auto Verify' },
      route:        { icon: '\u2461', color: '#67E8F9', label: 'Route' },
      retry:        { icon: '\u21BB', color: '#FCA572', label: 'Retry' },
      escalate:     { icon: '\u25B2', color: '#F87171', label: 'Escalate' },
      spawn:        { icon: '\u25C7', color: '#A78BFA', label: 'Spawn' },
      tool_select:  { icon: '\u2699', color: '#FFD866', label: 'Tool Select' },
      delegate:     { icon: '\u2192', color: '#67E8F9', label: 'Delegate' },
      throttle:     { icon: '\u25D1', color: '#FCA572', label: 'Throttle' },
      prioritize:   { icon: '\u2605', color: '#FFD866', label: 'Prioritize' }
    };

    const TASKS = [
      {
        id: 'api-platform', name: 'API Platform v2', priority: 'P0', priorityColor: '#F87171',
        agents: [
          { id: 'ap-orch', name: 'API Orchestrator', type: 'orchestrator', children: ['ap-plan'] },
          { id: 'ap-plan', name: 'API Planner', type: 'planner', children: ['ap-code1', 'ap-code2', 'ap-code3'] },
          { id: 'ap-code1', name: 'Routes Coder', type: 'coder', children: ['ap-rev1'] },
          { id: 'ap-code2', name: 'Models Coder', type: 'coder', children: ['ap-rev1'] },
          { id: 'ap-code3', name: 'Middleware Coder', type: 'coder', children: ['ap-rev2'] },
          { id: 'ap-rev1', name: 'API Reviewer', type: 'reviewer', children: ['ap-test1'] },
          { id: 'ap-rev2', name: 'Security Reviewer', type: 'reviewer', children: ['ap-test2'] },
          { id: 'ap-test1', name: 'Integration Tester', type: 'tester', children: ['ap-scan'] },
          { id: 'ap-test2', name: 'Security Tester', type: 'tester', children: ['ap-scan'] },
          { id: 'ap-scan', name: 'Vuln Scanner', type: 'scanner', children: [] }
        ]
      },
      {
        id: 'auth-migration', name: 'Auth Migration', priority: 'P0', priorityColor: '#F87171',
        agents: [
          { id: 'am-orch', name: 'Auth Orchestrator', type: 'orchestrator', children: ['am-code1'] },
          { id: 'am-code1', name: 'OAuth Coder', type: 'coder', children: ['am-code2'] },
          { id: 'am-code2', name: 'Session Coder', type: 'coder', children: ['am-rev'] },
          { id: 'am-rev', name: 'Auth Reviewer', type: 'reviewer', children: ['am-test'] },
          { id: 'am-test', name: 'Auth Tester', type: 'tester', children: [] }
        ]
      },
      {
        id: 'terraform-refactor', name: 'Terraform Refactor', priority: 'P1', priorityColor: '#FFD866',
        agents: [
          { id: 'tf-orch', name: 'TF Orchestrator', type: 'orchestrator', children: ['tf-plan'] },
          { id: 'tf-plan', name: 'TF Planner', type: 'planner', children: ['tf-code1', 'tf-code2'] },
          { id: 'tf-code1', name: 'Module Coder', type: 'coder', children: ['tf-rev'] },
          { id: 'tf-code2', name: 'State Coder', type: 'coder', children: ['tf-rev'] },
          { id: 'tf-rev', name: 'TF Reviewer', type: 'reviewer', children: ['tf-test'] },
          { id: 'tf-test', name: 'TF Tester', type: 'tester', children: [] }
        ]
      },
      {
        id: 'dashboard-redesign', name: 'Dashboard Redesign', priority: 'P1', priorityColor: '#FFD866',
        agents: [
          { id: 'dr-orch', name: 'UI Orchestrator', type: 'orchestrator', children: ['dr-code1', 'dr-code2'] },
          { id: 'dr-code1', name: 'Components Coder', type: 'coder', children: ['dr-rev'] },
          { id: 'dr-code2', name: 'Layout Coder', type: 'coder', children: ['dr-rev'] },
          { id: 'dr-rev', name: 'UI Reviewer', type: 'reviewer', children: ['dr-test'] },
          { id: 'dr-test', name: 'Visual Tester', type: 'tester', children: [] }
        ]
      },
      {
        id: 'data-pipeline', name: 'Data Pipeline ETL', priority: 'P0', priorityColor: '#F87171',
        agents: [
          { id: 'dp-orch', name: 'ETL Orchestrator', type: 'orchestrator', children: ['dp-code1'] },
          { id: 'dp-code1', name: 'Extract Coder', type: 'coder', children: ['dp-code2'] },
          { id: 'dp-code2', name: 'Transform Coder', type: 'coder', children: ['dp-code3'] },
          { id: 'dp-code3', name: 'Load Coder', type: 'coder', children: ['dp-test'] },
          { id: 'dp-test', name: 'Pipeline Tester', type: 'tester', children: [] }
        ]
      },
      {
        id: 'ci-optimization', name: 'CI Optimization', priority: 'P2', priorityColor: '#8b949e',
        agents: [
          { id: 'ci-code', name: 'CI Coder', type: 'coder', children: ['ci-test'] },
          { id: 'ci-test', name: 'CI Tester', type: 'tester', children: [] }
        ]
      }
    ];

    // ========================================
    // SIMULATION STATE
    // ========================================

    let simState = {
      running: true,
      speed: 1,
      tick: 0,
      agents: {},
      decisions: [],
      totalTokens: 0,
      totalCost: 0,
      selectedAgent: null,
      hoveredAgent: null,
      showDecisions: true,
      selectedTaskIndex: 0,
      zoom: 1,
      panX: 0,
      panY: 0,
      viewBox: { x: 0, y: 0, w: 0, h: 0 }
    };

    function initAgentStates() {
      for (const task of TASKS) {
        for (const agent of task.agents) {
          simState.agents[agent.id] = {
            ...agent,
            taskId: task.id,
            taskName: task.name,
            status: 'queued',
            progress: 0,
            tokens: 0,
            cost: 0,
            messages: 0,
            turns: 0,
            startedAt: null,
            decisions: [],
            verified: false,
            verificationScore: 0,
            x: 0, y: 0,
            radius: 32,
            targetProgress: 0,
            tokenRate: 800 + Math.random() * 2000
          };
        }
      }
    }

    // ========================================
    // TASK STRIP
    // ========================================

    function getTaskCompletion(task) {
      let total = 0, completed = 0, progressSum = 0;
      for (const a of task.agents) {
        const s = simState.agents[a.id];
        total++;
        if (s && s.status === 'completed') completed++;
        if (s) progressSum += s.progress;
      }
      return {
        pct: total > 0 ? Math.round(progressSum / total) : 0,
        completed,
        total
      };
    }

    function getTaskActiveCount(task) {
      let active = 0;
      for (const a of task.agents) {
        const s = simState.agents[a.id];
        if (s && (s.status === 'running' || s.status === 'verifying')) active++;
      }
      return active;
    }

    function getTaskStatusCounts(task) {
      const counts = { running: 0, completed: 0, queued: 0, verifying: 0, blocked: 0, failed: 0 };
      for (const a of task.agents) {
        const s = simState.agents[a.id];
        if (s) counts[s.status] = (counts[s.status] || 0) + 1;
      }
      return counts;
    }

    function renderTaskStrip() {
      const strip = document.getElementById('task-strip');
      strip.innerHTML = '';

      TASKS.forEach((task, i) => {
        const comp = getTaskCompletion(task);
        const active = getTaskActiveCount(task);

        const pill = document.createElement('div');
        pill.className = `task-pill ${i === simState.selectedTaskIndex ? 'active' : ''}`;
        pill.setAttribute('data-index', i);

        // Donut chart SVG
        const r = 10, c = 2 * Math.PI * r;
        const pctOffset = c * (1 - comp.pct / 100);

        pill.innerHTML = `
          <div class="task-pill-donut">
            <svg viewBox="0 0 28 28">
              <circle cx="14" cy="14" r="${r}" fill="none" stroke="#21262d" stroke-width="3"/>
              <circle cx="14" cy="14" r="${r}" fill="none"
                stroke="${comp.pct >= 100 ? '#A78BFA' : '#58a6ff'}"
                stroke-width="3" stroke-linecap="round"
                stroke-dasharray="${c}" stroke-dashoffset="${pctOffset}"
                transform="rotate(-90 14 14)"
                style="transition: stroke-dashoffset 0.5s ease"/>
            </svg>
            <div class="donut-pct">${comp.pct}</div>
          </div>
          <div class="task-pill-info">
            <div class="task-pill-name">${task.name}</div>
            <div class="task-pill-meta">
              <span class="task-pill-priority" style="background:${task.priorityColor}22;color:${task.priorityColor}">${task.priority}</span>
              <span class="task-pill-agents">
                ${active > 0 ? '<span class="pulse-dot"></span>' : ''}
                ${active > 0 ? active + ' active' : comp.completed + '/' + comp.total}
              </span>
            </div>
          </div>
          <span class="task-pill-kbd">${i + 1}</span>
        `;

        pill.addEventListener('click', () => selectTask(i));
        strip.appendChild(pill);
      });
    }

    function updateTaskPills() {
      const pills = document.querySelectorAll('.task-pill');
      pills.forEach((pill, i) => {
        const task = TASKS[i];
        const comp = getTaskCompletion(task);
        const active = getTaskActiveCount(task);

        // Update active class
        pill.className = `task-pill ${i === simState.selectedTaskIndex ? 'active' : ''}`;

        // Update donut
        const r = 10, c = 2 * Math.PI * r;
        const pctOffset = c * (1 - comp.pct / 100);
        const donutCircle = pill.querySelector('.task-pill-donut svg circle:nth-child(2)');
        if (donutCircle) {
          donutCircle.setAttribute('stroke-dashoffset', pctOffset);
          donutCircle.setAttribute('stroke', comp.pct >= 100 ? '#A78BFA' : '#58a6ff');
        }
        const pctText = pill.querySelector('.donut-pct');
        if (pctText) pctText.textContent = comp.pct;

        // Update agents info
        const agentsSpan = pill.querySelector('.task-pill-agents');
        if (agentsSpan) {
          agentsSpan.innerHTML = `
            ${active > 0 ? '<span class="pulse-dot"></span>' : ''}
            ${active > 0 ? active + ' active' : comp.completed + '/' + comp.total}
          `;
        }
      });
    }

    function updateStatusSummary() {
      const task = TASKS[simState.selectedTaskIndex];
      const counts = getTaskStatusCounts(task);
      const el = document.getElementById('status-summary');

      const items = [];
      if (counts.running > 0) items.push(`<span class="status-summary-item"><span class="status-summary-dot" style="background:#34D399"></span><span class="status-summary-label">${counts.running} running</span></span>`);
      if (counts.verifying > 0) items.push(`<span class="status-summary-item"><span class="status-summary-dot" style="background:#FFD866"></span><span class="status-summary-label">${counts.verifying} verifying</span></span>`);
      if (counts.completed > 0) items.push(`<span class="status-summary-item"><span class="status-summary-dot" style="background:#A78BFA"></span><span class="status-summary-label">${counts.completed} completed</span></span>`);
      if (counts.queued > 0) items.push(`<span class="status-summary-item"><span class="status-summary-dot" style="background:#475569"></span><span class="status-summary-label">${counts.queued} queued</span></span>`);
      if (counts.blocked > 0) items.push(`<span class="status-summary-item"><span class="status-summary-dot" style="background:#FCA572"></span><span class="status-summary-label">${counts.blocked} blocked</span></span>`);
      if (counts.failed > 0) items.push(`<span class="status-summary-item"><span class="status-summary-dot" style="background:#F87171"></span><span class="status-summary-label">${counts.failed} failed</span></span>`);

      el.innerHTML = `<span style="font-weight:500;color:var(--fg-default);font-size:11px">${task.name}</span>` +
        '<span style="color:var(--border-default)">|</span>' +
        items.join('<span style="color:var(--border-default)">&middot;</span>');
    }

    function selectTask(index) {
      if (index < 0 || index >= TASKS.length) return;
      simState.selectedTaskIndex = index;
      simState.panX = 0;
      simState.panY = 0;
      simState.zoom = 1;
      deselectAgent();
      renderCurrentTaskTopology();
      updateTaskPills();
      updateStatusSummary();
      document.getElementById('zoom-label').textContent = '100%';

      // Scroll pill into view
      const pills = document.querySelectorAll('.task-pill');
      if (pills[index]) {
        pills[index].scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' });
      }
    }

    // ========================================
    // GRAPH LAYOUT (single task, full canvas)
    // ========================================

    function computeSingleTaskLayout(task) {
      const svg = document.getElementById('topology-svg');
      const rect = svg.getBoundingClientRect();
      const canvasW = rect.width;
      const canvasH = rect.height;

      // Build layers using BFS
      const layers = [];
      const visited = new Set();
      const roots = task.agents.filter(a => {
        return !task.agents.some(other => other.children.includes(a.id));
      });

      let currentLayer = roots.map(a => a.id);
      while (currentLayer.length > 0) {
        const layer = currentLayer.filter(id => !visited.has(id));
        if (layer.length === 0) break;
        layers.push(layer);
        layer.forEach(id => visited.add(id));
        const nextLayer = [];
        for (const id of layer) {
          const agent = task.agents.find(a => a.id === id);
          if (agent) {
            for (const childId of agent.children) {
              if (!visited.has(childId)) nextLayer.push(childId);
            }
          }
        }
        currentLayer = nextLayer;
      }

      for (const agent of task.agents) {
        if (!visited.has(agent.id)) {
          if (layers.length === 0) layers.push([]);
          layers[layers.length - 1].push(agent.id);
        }
      }

      // Use generous spacing since we have the full canvas
      const nodeSpacingX = Math.max(140, Math.min(220, canvasW / (Math.max(...layers.map(l => l.length)) + 1)));
      const nodeSpacingY = Math.max(120, Math.min(180, canvasH / (layers.length + 1)));

      const centerX = canvasW / 2;
      const startY = 80;

      for (let li = 0; li < layers.length; li++) {
        const layer = layers[li];
        const layerWidth = (layer.length - 1) * nodeSpacingX;
        const layerStartX = centerX - layerWidth / 2;

        for (let ni = 0; ni < layer.length; ni++) {
          const agentId = layer[ni];
          const s = simState.agents[agentId];
          if (s) {
            s.x = layerStartX + ni * nodeSpacingX;
            s.y = startY + li * nodeSpacingY;
          }
        }
      }

      return layers;
    }

    // ========================================
    // SVG RENDERING
    // ========================================

    function renderCurrentTaskTopology() {
      const task = TASKS[simState.selectedTaskIndex];
      computeSingleTaskLayout(task);
      renderEdges(task);
      renderNodes(task);
      renderParticles(task);
      renderDecisions(task);
      updateViewBox();
    }

    function renderEdges(task) {
      const layer = document.getElementById('edges-layer');
      layer.innerHTML = '';

      for (const agent of task.agents) {
        for (const childId of agent.children) {
          const parent = simState.agents[agent.id];
          const child = simState.agents[childId];
          if (!parent || !child) continue;

          // Create gradient for edge
          const gradId = `grad-${agent.id}-${childId}`;
          let defs = document.querySelector('#topology-svg defs');
          // Remove old gradient if exists
          const existing = defs.querySelector(`#${gradId}`);
          if (existing) existing.remove();

          const parentColor = AGENT_TYPES[parent.type].color;
          const childColor = AGENT_TYPES[child.type].color;

          const grad = document.createElementNS('http://www.w3.org/2000/svg', 'linearGradient');
          grad.setAttribute('id', gradId);
          grad.setAttribute('gradientUnits', 'userSpaceOnUse');
          grad.setAttribute('x1', parent.x);
          grad.setAttribute('y1', parent.y);
          grad.setAttribute('x2', child.x);
          grad.setAttribute('y2', child.y);

          const stop1 = document.createElementNS('http://www.w3.org/2000/svg', 'stop');
          stop1.setAttribute('offset', '0%');
          stop1.setAttribute('stop-color', parentColor);
          const stop2 = document.createElementNS('http://www.w3.org/2000/svg', 'stop');
          stop2.setAttribute('offset', '100%');
          stop2.setAttribute('stop-color', childColor);
          grad.appendChild(stop1);
          grad.appendChild(stop2);
          defs.appendChild(grad);

          const edge = document.createElementNS('http://www.w3.org/2000/svg', 'path');
          const dy = child.y - parent.y;
          const cpOffset = dy * 0.4;
          const d = `M ${parent.x} ${parent.y + parent.radius + 2} C ${parent.x} ${parent.y + parent.radius + cpOffset}, ${child.x} ${child.y - parent.radius - cpOffset}, ${child.x} ${child.y - child.radius - 8}`;

          edge.setAttribute('d', d);
          edge.setAttribute('data-from', agent.id);
          edge.setAttribute('data-to', childId);

          let edgeStatus = 'pending';
          if (parent.status === 'completed' && (child.status === 'completed' || child.status === 'running' || child.status === 'verifying')) {
            edgeStatus = 'completed';
          } else if (parent.status === 'running' || child.status === 'running') {
            edgeStatus = 'running';
          } else if (parent.status === 'blocked' || child.status === 'blocked') {
            edgeStatus = 'blocked';
          } else if (parent.status === 'failed') {
            edgeStatus = 'failed';
          }

          edge.setAttribute('class', `edge-line ${edgeStatus}`);

          // Use gradient for non-status edges or running edges
          if (edgeStatus === 'running' || edgeStatus === 'completed') {
            edge.style.stroke = `url(#${gradId})`;
            edge.style.opacity = edgeStatus === 'running' ? '0.7' : '0.45';
          }

          if (edgeStatus === 'running') {
            edge.setAttribute('marker-end', 'url(#arrowhead-active)');
          } else if (edgeStatus === 'completed') {
            edge.setAttribute('marker-end', 'url(#arrowhead-completed)');
          } else {
            edge.setAttribute('marker-end', 'url(#arrowhead)');
          }

          layer.appendChild(edge);
        }
      }
    }

    function renderNodes(task) {
      const layer = document.getElementById('nodes-layer');
      layer.innerHTML = '';

      for (const agentDef of task.agents) {
        const agent = simState.agents[agentDef.id];
        if (!agent) continue;

        const typeInfo = AGENT_TYPES[agent.type];
        const statusColor = STATUS_COLORS[agent.status] || STATUS_COLORS.queued;
        const nodeR = 32;
        agent.radius = nodeR;

        const g = document.createElementNS('http://www.w3.org/2000/svg', 'g');
        g.setAttribute('class', `agent-node ${simState.selectedAgent === agent.id ? 'selected' : ''}`);
        g.setAttribute('data-id', agent.id);
        g.setAttribute('transform', `translate(${agent.x}, ${agent.y})`);

        // Running pulse glow
        if (agent.status === 'running') {
          const pulse = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
          pulse.setAttribute('cx', 0);
          pulse.setAttribute('cy', 0);
          pulse.setAttribute('r', nodeR + 8);
          pulse.setAttribute('fill', statusColor);
          pulse.setAttribute('class', 'running-pulse');
          pulse.setAttribute('opacity', '0.15');
          g.appendChild(pulse);
        }

        // Subtle type-color ambient glow
        const ambientGlow = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
        ambientGlow.setAttribute('cx', 0);
        ambientGlow.setAttribute('cy', 0);
        ambientGlow.setAttribute('r', nodeR + 4);
        ambientGlow.setAttribute('fill', 'none');
        ambientGlow.setAttribute('filter', `url(#glow-${agent.type})`);
        ambientGlow.setAttribute('stroke', typeInfo.color);
        ambientGlow.setAttribute('stroke-width', '1');
        ambientGlow.setAttribute('opacity', '0.5');
        g.appendChild(ambientGlow);

        // Progress ring (background)
        const ringBgR = nodeR + 5;
        const ringBg = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
        ringBg.setAttribute('cx', 0);
        ringBg.setAttribute('cy', 0);
        ringBg.setAttribute('r', ringBgR);
        ringBg.setAttribute('fill', 'none');
        ringBg.setAttribute('stroke', '#21262d');
        ringBg.setAttribute('stroke-width', '3');
        g.appendChild(ringBg);

        // Progress ring (fill)
        const circumference = 2 * Math.PI * ringBgR;
        const progressPct = agent.progress / 100;
        const ring = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
        ring.setAttribute('cx', 0);
        ring.setAttribute('cy', 0);
        ring.setAttribute('r', ringBgR);
        ring.setAttribute('class', `node-progress-ring ${agent.status === 'verifying' ? 'verifying-spin' : ''}`);
        ring.setAttribute('stroke', agent.status === 'completed' ? statusColor : typeInfo.color);
        ring.setAttribute('stroke-dasharray', `${circumference * progressPct} ${circumference * (1 - progressPct)}`);
        ring.setAttribute('transform', 'rotate(-90)');
        ring.setAttribute('opacity', '0.7');
        g.appendChild(ring);

        // Selection ring
        const selRing = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
        selRing.setAttribute('cx', 0);
        selRing.setAttribute('cy', 0);
        selRing.setAttribute('r', nodeR + 10);
        selRing.setAttribute('stroke', typeInfo.color);
        selRing.setAttribute('class', 'node-ring');
        selRing.setAttribute('stroke-dasharray', '4 3');
        g.appendChild(selRing);

        // Main circle
        const circle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
        circle.setAttribute('cx', 0);
        circle.setAttribute('cy', 0);
        circle.setAttribute('r', nodeR);
        circle.setAttribute('fill', typeInfo.color);
        circle.setAttribute('stroke', statusColor);
        circle.setAttribute('class', 'node-bg');
        if (agent.status === 'running') circle.setAttribute('filter', 'url(#glow-running)');
        if (agent.status === 'verifying') circle.setAttribute('filter', 'url(#glow-verifying)');
        g.appendChild(circle);

        // Icon
        const icon = document.createElementNS('http://www.w3.org/2000/svg', 'text');
        icon.setAttribute('x', 0);
        icon.setAttribute('y', 0);
        icon.setAttribute('class', 'node-icon');
        icon.setAttribute('font-size', '18');
        icon.textContent = typeInfo.symbol;
        g.appendChild(icon);

        // Status dot
        const statusDot = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
        statusDot.setAttribute('cx', nodeR * 0.7);
        statusDot.setAttribute('cy', -nodeR * 0.7);
        statusDot.setAttribute('r', 5);
        statusDot.setAttribute('class', 'node-status-dot');
        statusDot.setAttribute('fill', statusColor);
        g.appendChild(statusDot);

        // Name label
        const label = document.createElementNS('http://www.w3.org/2000/svg', 'text');
        label.setAttribute('x', 0);
        label.setAttribute('y', nodeR + 18);
        label.setAttribute('class', 'node-label');
        label.textContent = agent.name;
        g.appendChild(label);

        // Small progress text
        if (agent.status !== 'queued' && agent.status !== 'completed') {
          const pctLabel = document.createElementNS('http://www.w3.org/2000/svg', 'text');
          pctLabel.setAttribute('x', 0);
          pctLabel.setAttribute('y', nodeR + 30);
          pctLabel.setAttribute('text-anchor', 'middle');
          pctLabel.setAttribute('font-family', 'var(--font-mono)');
          pctLabel.setAttribute('font-size', '10');
          pctLabel.setAttribute('fill', statusColor);
          pctLabel.setAttribute('opacity', '0.8');
          pctLabel.textContent = Math.round(agent.progress) + '%';
          g.appendChild(pctLabel);
        }

        // Events
        g.addEventListener('mouseenter', (e) => showTooltip(agent.id, e));
        g.addEventListener('mouseleave', hideTooltip);
        g.addEventListener('click', (e) => { e.stopPropagation(); selectAgent(agent.id); });

        layer.appendChild(g);
      }
    }

    function renderParticles(task) {
      const layer = document.getElementById('particles-layer');
      layer.innerHTML = '';

      for (const agent of task.agents) {
        const parent = simState.agents[agent.id];
        if (!parent || (parent.status !== 'running' && parent.status !== 'completed')) continue;

        for (const childId of agent.children) {
          const child = simState.agents[childId];
          if (!child || child.status !== 'running') continue;

          const parentColor = AGENT_TYPES[parent.type].color;
          const childColor = AGENT_TYPES[child.type].color;

          const numParticles = 4;
          for (let i = 0; i < numParticles; i++) {
            const t = ((simState.tick * 0.015 * simState.speed + i / numParticles) % 1);

            // Bezier interpolation matching edge curve
            const p0y = parent.y + parent.radius + 2;
            const p3y = child.y - child.radius - 8;
            const dy = child.y - parent.y;
            const cpOffset = dy * 0.4;
            const cp1x = parent.x, cp1y = parent.y + parent.radius + cpOffset;
            const cp2x = child.x, cp2y = child.y - parent.radius - cpOffset;

            const mt = 1 - t;
            const x = mt*mt*mt*parent.x + 3*mt*mt*t*cp1x + 3*mt*t*t*cp2x + t*t*t*child.x;
            const y = mt*mt*mt*p0y + 3*mt*mt*t*cp1y + 3*mt*t*t*cp2y + t*t*t*p3y;

            // Interpolate color
            const particle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
            particle.setAttribute('cx', x);
            particle.setAttribute('cy', y);
            particle.setAttribute('class', 'flow-particle');
            particle.setAttribute('fill', t < 0.5 ? parentColor : childColor);
            particle.setAttribute('r', 2.5 + Math.sin(t * Math.PI) * 2);
            particle.setAttribute('opacity', 0.3 + Math.sin(t * Math.PI) * 0.55);
            layer.appendChild(particle);
          }
        }
      }
    }

    function renderDecisions(task) {
      const layer = document.getElementById('decisions-layer');
      layer.innerHTML = '';

      if (!simState.showDecisions) return;

      const taskAgentIds = new Set(task.agents.map(a => a.id));

      for (const decision of simState.decisions) {
        if (!taskAgentIds.has(decision.agentId)) continue;

        const agent = simState.agents[decision.agentId];
        if (!agent) continue;

        const dt = DECISION_TYPES[decision.type];
        if (!dt) continue;

        const g = document.createElementNS('http://www.w3.org/2000/svg', 'g');
        g.setAttribute('class', 'decision-badge');
        g.setAttribute('transform', `translate(${agent.x + agent.radius + 8}, ${agent.y - agent.radius - 4})`);

        const bg = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
        bg.setAttribute('x', -10);
        bg.setAttribute('y', -10);
        bg.setAttribute('width', 20);
        bg.setAttribute('height', 20);
        bg.setAttribute('class', 'decision-badge-bg');
        bg.setAttribute('fill', dt.color + '22');
        bg.setAttribute('stroke', dt.color + '66');
        g.appendChild(bg);

        const icon = document.createElementNS('http://www.w3.org/2000/svg', 'text');
        icon.setAttribute('x', 0);
        icon.setAttribute('y', 1);
        icon.setAttribute('class', 'decision-badge-icon');
        icon.setAttribute('fill', dt.color);
        icon.textContent = dt.icon;
        g.appendChild(icon);

        g.addEventListener('click', (e) => {
          e.stopPropagation();
          showDecisionPopover(decision, e);
        });

        layer.appendChild(g);
      }
    }

    // ========================================
    // VIEW CONTROLS
    // ========================================

    function updateViewBox() {
      const svg = document.getElementById('topology-svg');
      const rect = svg.getBoundingClientRect();
      const task = TASKS[simState.selectedTaskIndex];

      let minX = Infinity, minY = Infinity, maxX = -Infinity, maxY = -Infinity;
      for (const a of task.agents) {
        const s = simState.agents[a.id];
        if (s) {
          minX = Math.min(minX, s.x - 60);
          minY = Math.min(minY, s.y - 60);
          maxX = Math.max(maxX, s.x + 60);
          maxY = Math.max(maxY, s.y + 60);
        }
      }

      if (minX === Infinity) { minX = 0; minY = 0; maxX = rect.width; maxY = rect.height; }

      const contentW = maxX - minX + 80;
      const contentH = maxY - minY + 80;
      const cx = minX - 40 + contentW / 2;
      const cy = minY - 40 + contentH / 2;

      const vw = rect.width / simState.zoom;
      const vh = rect.height / simState.zoom;

      simState.viewBox = {
        x: cx - vw / 2 + simState.panX,
        y: cy - vh / 2 + simState.panY,
        w: vw,
        h: vh
      };

      svg.setAttribute('viewBox', `${simState.viewBox.x} ${simState.viewBox.y} ${simState.viewBox.w} ${simState.viewBox.h}`);
    }

    function zoomIn() {
      simState.zoom = Math.min(3, simState.zoom * 1.2);
      updateViewBox();
      document.getElementById('zoom-label').textContent = Math.round(simState.zoom * 100) + '%';
    }

    function zoomOut() {
      simState.zoom = Math.max(0.3, simState.zoom / 1.2);
      updateViewBox();
      document.getElementById('zoom-label').textContent = Math.round(simState.zoom * 100) + '%';
    }

    function fitView() {
      simState.zoom = 1;
      simState.panX = 0;
      simState.panY = 0;
      updateViewBox();
      document.getElementById('zoom-label').textContent = '100%';
    }

    function centerView() {
      simState.panX = 0;
      simState.panY = 0;
      updateViewBox();
    }

    // Pan & zoom
    (function setupCanvasInteraction() {
      const svg = document.getElementById('topology-svg');
      let isPanning = false;
      let startX, startY;

      svg.addEventListener('mousedown', (e) => {
        if (e.target === svg || e.target.tagName === 'svg') {
          isPanning = true;
          startX = e.clientX;
          startY = e.clientY;
          svg.classList.add('dragging');
        }
      });

      window.addEventListener('mousemove', (e) => {
        if (!isPanning) return;
        const dx = (e.clientX - startX) / simState.zoom;
        const dy = (e.clientY - startY) / simState.zoom;
        simState.panX -= dx;
        simState.panY -= dy;
        startX = e.clientX;
        startY = e.clientY;
        updateViewBox();
      });

      window.addEventListener('mouseup', () => {
        isPanning = false;
        svg.classList.remove('dragging');
      });

      svg.addEventListener('wheel', (e) => {
        e.preventDefault();
        const delta = e.deltaY > 0 ? 0.9 : 1.1;
        simState.zoom = Math.min(3, Math.max(0.3, simState.zoom * delta));
        updateViewBox();
        document.getElementById('zoom-label').textContent = Math.round(simState.zoom * 100) + '%';
      }, { passive: false });

      svg.addEventListener('click', (e) => {
        if (e.target === svg || e.target.tagName === 'svg') {
          deselectAgent();
        }
      });
    })();

    // ========================================
    // TOOLTIP
    // ========================================

    function showTooltip(agentId, event) {
      if (simState.selectedAgent === agentId) return;
      simState.hoveredAgent = agentId;
      const agent = simState.agents[agentId];
      const typeInfo = AGENT_TYPES[agent.type];
      const statusColor = STATUS_COLORS[agent.status];
      const tooltip = document.getElementById('node-tooltip');

      tooltip.innerHTML = `
        <div class="tooltip-name" style="color:${typeInfo.color}">${agent.name}</div>
        <div class="tooltip-row"><span class="label">Type</span><span class="value" style="color:${typeInfo.color};font-family:var(--font-sans)">${typeInfo.label}</span></div>
        <div class="tooltip-row"><span class="label">Status</span><span class="value" style="color:${statusColor};font-family:var(--font-sans)">${agent.status}</span></div>
        <div class="tooltip-row"><span class="label">Progress</span><span class="value">${Math.round(agent.progress)}%</span></div>
        <div class="tooltip-row"><span class="label">Tokens</span><span class="value">${formatNumber(agent.tokens)}</span></div>
        <div class="tooltip-row"><span class="label">Cost</span><span class="value" style="color:#FFD866">$${agent.cost.toFixed(2)}</span></div>
        <div class="tooltip-progress"><div class="tooltip-progress-fill" style="width:${agent.progress}%;background:${statusColor}"></div></div>
      `;

      const nodeEl = event.target.closest('.agent-node');
      if (nodeEl) {
        const rect = nodeEl.getBoundingClientRect();
        tooltip.style.left = (rect.right + 12) + 'px';
        tooltip.style.top = rect.top + 'px';
      }
      tooltip.classList.add('visible');
    }

    function hideTooltip() {
      simState.hoveredAgent = null;
      document.getElementById('node-tooltip').classList.remove('visible');
    }

    // ========================================
    // AGENT SELECTION & DETAIL PANEL
    // ========================================

    function selectAgent(agentId) {
      simState.selectedAgent = agentId;
      hideTooltip();
      updateNodeSelectionClasses();
      updateDetailPanel();
      document.getElementById('detail-panel').classList.add('open');
    }

    function deselectAgent() {
      simState.selectedAgent = null;
      updateNodeSelectionClasses();
      document.getElementById('detail-panel').classList.remove('open');
    }

    function updateNodeSelectionClasses() {
      document.querySelectorAll('.agent-node').forEach(node => {
        node.classList.toggle('selected', node.getAttribute('data-id') === simState.selectedAgent);
      });
    }

    function updateDetailPanel() {
      const agent = simState.agents[simState.selectedAgent];
      if (!agent) return;

      const typeInfo = AGENT_TYPES[agent.type];
      const statusColor = STATUS_COLORS[agent.status];

      document.getElementById('panel-header').innerHTML = `
        <div class="panel-agent-icon" style="background:${typeInfo.color}">${typeInfo.symbol}</div>
        <div class="panel-agent-info">
          <div class="panel-agent-name">${agent.name}</div>
          <div class="panel-agent-meta">
            <span class="panel-agent-type" style="color:${typeInfo.color}">${typeInfo.label}</span>
            <span class="status-badge ${agent.status}"><span class="dot"></span>${agent.status}</span>
          </div>
        </div>
        <button class="panel-close" onclick="deselectAgent()">&times;</button>
      `;

      updateDetailsTab(agent, typeInfo, statusColor);
      updateDecisionsTab(agent);
      updateActivityTab(agent);
    }

    function updateDetailsTab(agent, typeInfo, statusColor) {
      const task = TASKS.find(t => t.id === agent.taskId);
      let parentAgent = null;
      const childAgents = [];
      if (task) {
        for (const a of task.agents) {
          if (a.children.includes(agent.id)) parentAgent = simState.agents[a.id];
          if (agent.children.includes(a.id)) childAgents.push(simState.agents[a.id]);
        }
      }

      document.getElementById('tab-details').innerHTML = `
        <div class="panel-section">
          <div class="panel-section-title">Task</div>
          <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px">
            <span style="font-size:12px;font-weight:500;color:var(--fg-default)">${agent.taskName}</span>
            <span style="font-size:10px;font-family:var(--font-mono);color:${task ? task.priorityColor : '#8b949e'}">${task ? task.priority : ''}</span>
          </div>
        </div>
        <div class="panel-section">
          <div class="panel-section-title">Progress</div>
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px">
            <span style="font-size:20px;font-weight:600;font-family:var(--font-mono);color:${statusColor}">${Math.round(agent.progress)}%</span>
            <span style="font-size:11px;color:var(--fg-subtle)">${agent.turns} turns</span>
          </div>
          <div class="progress-bar-container">
            <div class="progress-bar-fill" style="width:${agent.progress}%;background:${statusColor}"></div>
          </div>
        </div>
        <div class="panel-section">
          <div class="panel-section-title">Metrics</div>
          <div class="stat-grid">
            <div class="stat-item"><div class="stat-label">Tokens</div><div class="stat-value">${formatNumber(agent.tokens)}</div></div>
            <div class="stat-item"><div class="stat-label">Cost</div><div class="stat-value cost">$${agent.cost.toFixed(2)}</div></div>
            <div class="stat-item"><div class="stat-label">Messages</div><div class="stat-value">${agent.messages}</div></div>
            <div class="stat-item"><div class="stat-label">Turns</div><div class="stat-value">${agent.turns}</div></div>
          </div>
        </div>
        <div class="panel-section">
          <div class="panel-section-title">Verification</div>
          <div class="verification-status">
            ${agent.verified
              ? '<span class="verification-icon" style="color:var(--status-completed)">\u2713</span><span class="verification-text"><strong>Verified</strong> - Score ' + agent.verificationScore + '%</span>'
              : agent.status === 'verifying'
                ? '<span class="verification-icon" style="color:var(--status-verifying)">\u23F3</span><span class="verification-text"><strong>Verifying</strong> - ' + Math.round(agent.verificationScore) + '% checked</span>'
                : '<span class="verification-icon" style="color:var(--fg-subtle)">\u25CB</span><span class="verification-text">Not yet verified</span>'
            }
          </div>
        </div>
        <div class="panel-section">
          <div class="panel-section-title">Relationships</div>
          ${parentAgent ? `
            <div class="relationship-item">
              <span class="relationship-arrow">\u2190</span>
              <span class="relationship-dot" style="background:${AGENT_TYPES[parentAgent.type].color}"></span>
              <span class="relationship-name">${parentAgent.name}</span>
              <span class="relationship-status" style="color:${STATUS_COLORS[parentAgent.status]}">${parentAgent.status}</span>
            </div>
          ` : ''}
          ${childAgents.map(c => `
            <div class="relationship-item">
              <span class="relationship-arrow">\u2192</span>
              <span class="relationship-dot" style="background:${AGENT_TYPES[c.type].color}"></span>
              <span class="relationship-name">${c.name}</span>
              <span class="relationship-status" style="color:${STATUS_COLORS[c.status]}">${c.status}</span>
            </div>
          `).join('')}
          ${!parentAgent && childAgents.length === 0 ? '<div style="font-size:11px;color:var(--fg-subtle)">No connections</div>' : ''}
        </div>
      `;
    }

    function updateDecisionsTab(agent) {
      const agentDecisions = simState.decisions.filter(d => d.agentId === agent.id);
      if (agentDecisions.length === 0) {
        document.getElementById('tab-decisions').innerHTML = `
          <div class="panel-section" style="text-align:center;padding:32px 16px">
            <div style="font-size:24px;opacity:0.3;margin-bottom:8px">\u26A1</div>
            <div style="font-size:12px;color:var(--fg-subtle)">No decisions yet</div>
          </div>
        `;
        return;
      }

      document.getElementById('tab-decisions').innerHTML = `<div class="panel-section">
        <div class="panel-section-title">Recent Decisions (${agentDecisions.length})</div>
        ${agentDecisions.slice(-10).reverse().map(d => {
          const dt = DECISION_TYPES[d.type];
          return `
            <div class="decision-feed-item" onclick="showDecisionPopover(window._decisions[${simState.decisions.indexOf(d)}], event)">
              <div class="decision-feed-icon" style="background:${dt.color}22;color:${dt.color}">${dt.icon}</div>
              <div class="decision-feed-content">
                <div class="decision-feed-type" style="color:${dt.color}">${dt.label}</div>
                <div class="decision-feed-summary">${d.summary}</div>
              </div>
              <div class="decision-feed-time">${d.time}</div>
            </div>
          `;
        }).join('')}
      </div>`;
    }

    function updateActivityTab(agent) {
      const activities = generateActivityLog(agent);
      document.getElementById('tab-activity').innerHTML = `
        <div class="panel-section">
          <div class="panel-section-title">Activity Log</div>
          ${activities.map(a => `
            <div class="activity-item">
              <span class="activity-time">${a.time}</span>
              <span class="activity-text">${a.text}</span>
            </div>
          `).join('')}
        </div>
      `;
    }

    function generateActivityLog(agent) {
      const logs = [];
      if (agent.status !== 'queued') logs.push({ time: '0:00', text: '<strong>Started</strong> - Agent initialized' });
      if (agent.progress > 10) logs.push({ time: '0:15', text: 'Scanning workspace files' });
      if (agent.progress > 25) logs.push({ time: '0:32', text: '<strong>Planning</strong> - Analyzing dependencies' });
      if (agent.progress > 40) logs.push({ time: '1:05', text: `Writing code in <strong>${agent.name.split(' ')[0].toLowerCase()}</strong> module` });
      if (agent.progress > 60) logs.push({ time: '2:10', text: 'Running <strong>tests</strong> - 12/15 passing' });
      if (agent.progress > 80) logs.push({ time: '3:20', text: 'Code review cycle completed' });
      if (agent.status === 'completed') logs.push({ time: '4:00', text: '<strong>Completed</strong> - All checks passed' });
      if (agent.status === 'failed') logs.push({ time: '2:45', text: '<strong>Failed</strong> - Build error in test suite' });
      return logs.reverse();
    }

    // ========================================
    // DECISION POPOVER
    // ========================================

    window._decisions = [];

    function showDecisionPopover(decision, event) {
      const dt = DECISION_TYPES[decision.type];
      const agent = simState.agents[decision.agentId];
      const container = document.getElementById('popover-container');
      const confColor = decision.confidence >= 85 ? '#34D399' : decision.confidence >= 60 ? '#FFD866' : '#F87171';

      container.innerHTML = `
        <div class="popover-overlay" onclick="closePopover()"></div>
        <div class="decision-popover" style="left:${Math.min(event.clientX + 10, window.innerWidth - 360)}px;top:${Math.min(event.clientY - 20, window.innerHeight - 400)}px">
          <div class="popover-header">
            <div class="popover-icon" style="background:${dt.color}22;color:${dt.color}">${dt.icon}</div>
            <div>
              <div class="popover-title">${dt.label}</div>
              <div class="popover-subtitle">${agent ? agent.name : 'Unknown'} &middot; ${decision.time}</div>
            </div>
          </div>
          <div class="popover-body">
            <div class="popover-section">
              <div class="popover-label">Summary</div>
              <div class="popover-text">${decision.summary}</div>
            </div>
            <div class="popover-section">
              <div class="popover-label">Detail</div>
              <div class="popover-text">${decision.detail}</div>
            </div>
            <div class="popover-section">
              <div class="popover-label">Confidence</div>
              <div class="confidence-value" style="color:${confColor}">${decision.confidence}%</div>
              <div class="confidence-bar-bg">
                <div class="confidence-bar-fill" style="width:${decision.confidence}%;background:${confColor}"></div>
              </div>
              <div class="confidence-markers">
                <span class="confidence-marker">0</span>
                <span class="confidence-marker" style="color:${decision.confidence >= 60 ? '#FFD866' : 'var(--fg-subtle)'}">60</span>
                <span class="confidence-marker" style="color:${decision.confidence >= 85 ? '#34D399' : 'var(--fg-subtle)'}">85</span>
                <span class="confidence-marker">100</span>
              </div>
            </div>
            <div class="popover-section">
              <div class="popover-label">Criteria</div>
              <div class="popover-tag-list">
                ${decision.criteria.map(c => `<span class="popover-tag">${c}</span>`).join('')}
              </div>
            </div>
            <div class="popover-section">
              <div class="popover-label">Alternatives</div>
              ${decision.alternatives.map(a => `
                <div class="popover-alternative">
                  <span class="popover-alternative-name">${a.name}</span>
                  <span class="popover-alternative-score">${a.score}%</span>
                </div>
              `).join('')}
            </div>
          </div>
          <div class="popover-footer">
            <span class="popover-policy">${decision.policy}</span>
            <button class="override-btn" onclick="closePopover()">Override</button>
          </div>
        </div>
      `;
    }

    function closePopover() {
      document.getElementById('popover-container').innerHTML = '';
    }

    // ========================================
    // PANEL TAB SWITCHING
    // ========================================

    document.querySelectorAll('.panel-tab').forEach(tab => {
      tab.addEventListener('click', () => {
        document.querySelectorAll('.panel-tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.panel-tab-content').forEach(c => c.classList.remove('active'));
        tab.classList.add('active');
        document.getElementById(`tab-${tab.dataset.tab}`).classList.add('active');
      });
    });

    // ========================================
    // SIMULATION ENGINE
    // ========================================

    const DECISION_SUMMARIES = {
      auto_verify: ['All tests passing, auto-approving changes', 'Code coverage above threshold, verification passed', 'Lint and type checks clean, auto-verified'],
      route: ['Routing to specialized coder for database module', 'Delegating UI components to frontend specialist', 'Assigning infrastructure task to DevOps agent'],
      retry: ['Test flake detected, retrying with fresh context', 'Build timeout, retrying with extended limits', 'Network error during API call, attempting retry'],
      escalate: ['Critical security finding requires human review', 'Breaking change detected, escalating to architect', 'Resource limit exceeded, needs manual intervention'],
      spawn: ['Spawning parallel workers for batch processing', 'Creating sub-agent for isolated module testing', 'Forking agent for concurrent API development'],
      tool_select: ['Selected grep for codebase search over AST', 'Choosing TypeScript compiler API for type analysis', 'Using Docker SDK for container management'],
      delegate: ['Delegating review to specialized reviewer agent', 'Passing security scan to dedicated scanner', 'Handing off deployment to deployer agent'],
      throttle: ['Reducing concurrency due to rate limits', 'Throttling API calls to respect quotas', 'Slowing batch size for memory management'],
      prioritize: ['Prioritizing critical path tasks first', 'Reordering queue by dependency depth', 'Moving blocking task to front of queue']
    };

    const DECISION_DETAILS = {
      auto_verify: 'Automated verification passed all 47 checks including unit tests, integration tests, and static analysis. No manual review required based on policy thresholds.',
      route: 'Analysis of task requirements determined specialized handling needed. Routing based on agent capability matching and current workload distribution.',
      retry: 'Transient failure detected. Previous attempt showed intermittent behavior consistent with a flaky dependency. Retrying with incremental backoff strategy.',
      escalate: 'Issue severity exceeds automated handling threshold. Human oversight required per security policy before proceeding with changes.',
      spawn: 'Workload analysis indicates parallel execution would reduce completion time by approximately 60%. Spawning workers with isolated contexts.',
      tool_select: 'Evaluated available tools against task requirements. Selected tool provides best accuracy for current file types and analysis depth needed.',
      delegate: 'Current agent lacks specialized capability for this sub-task. Delegation to expert agent improves quality and reduces iteration cycles.',
      throttle: 'External API rate limit approaching threshold. Proactively reducing request frequency to avoid hard blocks and maintain steady progress.',
      prioritize: 'Dependency analysis revealed critical path optimization opportunity. Reordering execution queue to minimize overall completion time.'
    };

    function generateDecision(agentId) {
      const types = Object.keys(DECISION_TYPES);
      const type = types[Math.floor(Math.random() * types.length)];
      const summaries = DECISION_SUMMARIES[type];
      const summary = summaries[Math.floor(Math.random() * summaries.length)];

      const minutes = Math.floor(simState.tick / 60);
      const seconds = Math.floor(simState.tick % 60);
      const time = `${minutes}:${seconds.toString().padStart(2, '0')}`;

      const decision = {
        type, agentId, summary,
        detail: DECISION_DETAILS[type],
        confidence: 55 + Math.floor(Math.random() * 40),
        time,
        criteria: ['latency', 'accuracy', 'cost', 'coverage'].sort(() => Math.random() - 0.5).slice(0, 2 + Math.floor(Math.random() * 2)),
        alternatives: [
          { name: 'Alternative A', score: 30 + Math.floor(Math.random() * 40) },
          { name: 'Alternative B', score: 20 + Math.floor(Math.random() * 30) }
        ],
        policy: 'auto-' + ['verify', 'route', 'delegate'][Math.floor(Math.random() * 3)] + '-v2.1'
      };

      simState.decisions.push(decision);
      window._decisions = simState.decisions;

      const agent = simState.agents[agentId];
      if (agent) agent.decisions.push(decision);
      return decision;
    }

    function canStart(agentId) {
      const agent = simState.agents[agentId];
      if (!agent) return false;
      const task = TASKS.find(t => t.id === agent.taskId);
      if (!task) return false;
      for (const other of task.agents) {
        if (other.children.includes(agentId)) {
          if (simState.agents[other.id].status !== 'completed') return false;
        }
      }
      return true;
    }

    function isRoot(agentId) {
      const agent = simState.agents[agentId];
      if (!agent) return false;
      const task = TASKS.find(t => t.id === agent.taskId);
      if (!task) return false;
      return !task.agents.some(a => a.children.includes(agentId));
    }

    function simulationTick() {
      if (!simState.running) return;
      simState.tick += simState.speed;

      for (const id of Object.keys(simState.agents)) {
        const agent = simState.agents[id];

        switch (agent.status) {
          case 'queued':
            if (isRoot(id)) {
              if (simState.tick > 5 + Math.random() * 30) {
                agent.status = 'running';
                agent.startedAt = simState.tick;
              }
            } else if (canStart(id)) {
              agent.status = 'running';
              agent.startedAt = simState.tick;
            }
            break;

          case 'running':
            const speed = (0.2 + Math.random() * 0.5) * simState.speed;
            agent.progress = Math.min(100, agent.progress + speed);
            agent.tokens += Math.floor(agent.tokenRate * speed * 0.02);
            agent.cost = agent.tokens * 0.000003;
            agent.messages += Math.random() < 0.05 * simState.speed ? 1 : 0;
            agent.turns += Math.random() < 0.02 * simState.speed ? 1 : 0;
            if (Math.random() < 0.003 * simState.speed) generateDecision(id);
            if (agent.progress >= 100) {
              agent.progress = 100;
              agent.status = 'verifying';
              agent.verificationScore = 0;
            }
            if (Math.random() < 0.0005 * simState.speed && agent.progress > 30 && agent.progress < 90) {
              agent.status = 'failed';
              generateDecision(id);
            }
            if (Math.random() < 0.0003 * simState.speed && agent.progress > 20 && agent.progress < 70) {
              agent.status = 'blocked';
            }
            break;

          case 'verifying':
            agent.verificationScore += (0.5 + Math.random() * 1) * simState.speed;
            if (agent.verificationScore >= 100) {
              agent.verificationScore = 100;
              agent.verified = true;
              agent.status = 'completed';
              if (Math.random() < 0.5) generateDecision(id);
            }
            break;

          case 'blocked':
            if (Math.random() < 0.01 * simState.speed) {
              agent.status = 'running';
              generateDecision(id);
            }
            break;

          case 'failed':
            if (Math.random() < 0.005 * simState.speed) {
              agent.status = 'running';
              agent.progress = Math.max(0, agent.progress - 20);
              generateDecision(id);
            }
            break;
        }
      }

      updateGlobalMetrics();
    }

    function updateGlobalMetrics() {
      const agents = Object.values(simState.agents);
      const active = agents.filter(a => a.status === 'running' || a.status === 'verifying').length;
      const total = agents.length;
      const tokens = agents.reduce((sum, a) => sum + a.tokens, 0);
      const cost = agents.reduce((sum, a) => sum + a.cost, 0);

      document.getElementById('metric-active').textContent = active;
      document.getElementById('metric-total').textContent = total;
      document.getElementById('metric-tokens').textContent = formatNumber(tokens);
      document.getElementById('metric-cost').textContent = '$' + cost.toFixed(2);
      document.getElementById('metric-decisions').textContent = simState.decisions.length;
    }

    function formatNumber(n) {
      if (n >= 1000000) return (n / 1000000).toFixed(1) + 'M';
      if (n >= 1000) return (n / 1000).toFixed(1) + 'K';
      return n.toString();
    }

    // ========================================
    // RENDER LOOP
    // ========================================

    let lastRenderTime = 0;
    const RENDER_INTERVAL = 50;

    function renderLoop(timestamp) {
      if (timestamp - lastRenderTime >= RENDER_INTERVAL) {
        simulationTick();

        const task = TASKS[simState.selectedTaskIndex];
        renderEdges(task);
        renderNodes(task);
        renderParticles(task);
        renderDecisions(task);
        updateTaskPills();
        updateStatusSummary();

        if (simState.selectedAgent) {
          updateDetailPanel();
        }

        lastRenderTime = timestamp;
      }
      requestAnimationFrame(renderLoop);
    }

    // ========================================
    // KEYBOARD NAVIGATION
    // ========================================

    document.addEventListener('keydown', (e) => {
      if (e.key === 'ArrowLeft') {
        e.preventDefault();
        selectTask(simState.selectedTaskIndex - 1);
      } else if (e.key === 'ArrowRight') {
        e.preventDefault();
        selectTask(simState.selectedTaskIndex + 1);
      } else if (e.key === 'Escape') {
        deselectAgent();
        closePopover();
      } else if (e.key >= '1' && e.key <= '6') {
        selectTask(parseInt(e.key) - 1);
      }
    });

    // ========================================
    // CONTROLS
    // ========================================

    document.getElementById('sim-play').addEventListener('click', function() {
      simState.running = !simState.running;
      this.innerHTML = simState.running ? '&#9654;' : '&#9646;&#9646;';
      this.classList.toggle('active', simState.running);
    });

    document.getElementById('sim-fast').addEventListener('click', function() {
      if (simState.speed === 1) {
        simState.speed = 2;
        document.getElementById('speed-label').textContent = '2x';
        this.classList.add('active');
      } else if (simState.speed === 2) {
        simState.speed = 5;
        document.getElementById('speed-label').textContent = '5x';
      } else {
        simState.speed = 1;
        document.getElementById('speed-label').textContent = '1x';
        this.classList.remove('active');
      }
    });

    document.getElementById('sim-reset').addEventListener('click', function() {
      simState.tick = 0;
      simState.decisions = [];
      window._decisions = [];
      simState.selectedAgent = null;

      for (const id of Object.keys(simState.agents)) {
        const agent = simState.agents[id];
        agent.status = 'queued';
        agent.progress = 0;
        agent.tokens = 0;
        agent.cost = 0;
        agent.messages = 0;
        agent.turns = 0;
        agent.startedAt = null;
        agent.decisions = [];
        agent.verified = false;
        agent.verificationScore = 0;
      }

      deselectAgent();
      updateGlobalMetrics();
    });

    document.getElementById('decision-toggle').addEventListener('click', function() {
      simState.showDecisions = !simState.showDecisions;
      this.classList.toggle('active', simState.showDecisions);
    });

    // ========================================
    // INITIALIZATION
    // ========================================

    function init() {
      initAgentStates();
      renderTaskStrip();
      updateStatusSummary();
      renderCurrentTaskTopology();
      requestAnimationFrame(renderLoop);

      window.addEventListener('resize', () => {
        renderCurrentTaskTopology();
      });
    }

    init();
  </script>
</body>
</html>
