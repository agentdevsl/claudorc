<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AgentPane — Architecture &amp; Data Flow</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@300;400;500;600&display=swap" rel="stylesheet">
  <link href="https://api.fontshare.com/v2/css?f[]=mona-sans@400,500,600,700&display=swap" rel="stylesheet">
  <style>
    /* ========================================
       Reset
       ======================================== */
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    html { -webkit-font-smoothing: antialiased; }
    ul, ol { list-style: none; }
    button { cursor: pointer; border: none; background: none; font: inherit; }

    :root {
      --bg-canvas: #0a0e14;
      --bg-default: #131920;
      --bg-subtle: #1a2230;
      --bg-muted: #21293a;
      --bg-emphasis: #2d3750;
      --border-default: #2a3445;
      --fg-default: #e2eaf4;
      --fg-muted: #7b8da6;
      --fg-subtle: #566580;
      --accent-fg: #58a6ff;
      --success-fg: #3fb950;
      --success-dim: #1a4028;
      --danger-fg: #f85149;
      --attention-fg: #d29922;
      --done-fg: #a371f7;
      --docker-fg: #3fb950;
      --cli-fg: #58a6ff;
      --event-fg: #e8883a;
      --sdk-fg: #f778ba;
      --font-sans: 'Mona Sans', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      --font-mono: 'Fira Code', 'SF Mono', Menlo, Consolas, monospace;
      --radius: 6px;
      --radius-lg: 10px;
    }

    body {
      font-family: var(--font-sans);
      font-size: 13px;
      color: var(--fg-default);
      background: var(--bg-canvas);
      height: 100vh;
      overflow: hidden;
    }

    /* Background atmosphere */
    body::before {
      content: '';
      position: fixed;
      inset: 0;
      background:
        radial-gradient(ellipse 800px 500px at 20% 25%, rgba(88, 166, 255, 0.035), transparent),
        radial-gradient(ellipse 600px 400px at 80% 65%, rgba(63, 185, 80, 0.025), transparent),
        radial-gradient(ellipse 500px 350px at 50% 85%, rgba(247, 120, 186, 0.02), transparent);
      pointer-events: none;
      z-index: 0;
    }

    body::after {
      content: '';
      position: fixed;
      inset: 0;
      background-image:
        linear-gradient(rgba(88, 166, 255, 0.018) 1px, transparent 1px),
        linear-gradient(90deg, rgba(88, 166, 255, 0.018) 1px, transparent 1px);
      background-size: 48px 48px;
      pointer-events: none;
      z-index: 0;
    }

    /* ========================================
       Layout
       ======================================== */
    .page {
      display: flex;
      flex-direction: column;
      height: 100vh;
      position: relative;
      z-index: 1;
    }

    .header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 14px 24px;
      border-bottom: 1px solid var(--border-default);
      background: rgba(10, 14, 20, 0.85);
      backdrop-filter: blur(12px);
      flex-shrink: 0;
      z-index: 10;
    }

    .header-left { display: flex; align-items: center; gap: 14px; }

    .logo-mark {
      width: 28px; height: 28px;
      border-radius: 7px;
      background: linear-gradient(135deg, var(--accent-fg), var(--done-fg));
      display: grid; place-items: center;
      font-weight: 700; font-size: 12px; color: #fff;
    }

    .header h1 {
      font-size: 14px; font-weight: 600;
      letter-spacing: -0.02em;
    }
    .header h1 span { color: var(--fg-muted); font-weight: 400; margin-left: 8px; }

    .legend {
      display: flex; gap: 20px;
      font-size: 10px; font-family: var(--font-mono);
      text-transform: uppercase; letter-spacing: 0.06em;
    }
    .legend-item { display: flex; align-items: center; gap: 7px; color: var(--fg-muted); }
    .legend-dot { width: 7px; height: 7px; border-radius: 50%; }
    .legend-dot.docker { background: var(--docker-fg); box-shadow: 0 0 6px rgba(63,185,80,0.4); }
    .legend-dot.cli { background: var(--cli-fg); box-shadow: 0 0 6px rgba(88,166,255,0.4); }
    .legend-dot.events { background: var(--event-fg); box-shadow: 0 0 6px rgba(232,136,58,0.4); }
    .legend-dot.data { background: var(--done-fg); box-shadow: 0 0 6px rgba(163,113,247,0.4); }

    /* ========================================
       Canvas
       ======================================== */
    .canvas-wrap {
      flex: 1;
      position: relative;
      overflow: hidden;
    }

    /* SVG connections layer - exactly overlays the nodes */
    #conn-svg {
      position: absolute;
      inset: 0;
      width: 100%;
      height: 100%;
      z-index: 1;
      pointer-events: none;
    }

    /* Nodes layer */
    .nodes-layer {
      position: absolute;
      inset: 0;
      z-index: 2;
    }

    /* ========================================
       Nodes
       ======================================== */
    .node {
      position: absolute;
      border: 1px solid var(--border-default);
      border-radius: var(--radius-lg);
      background: var(--bg-default);
      transition: border-color 0.25s, box-shadow 0.25s;
      cursor: default;
      /* Each node gets a data-id for JS connection lookup */
    }
    .node:hover {
      border-color: var(--fg-subtle);
      box-shadow: 0 4px 24px rgba(0,0,0,0.35);
    }

    .node-hdr {
      display: flex; align-items: center; gap: 8px;
      padding: 10px 14px;
      border-bottom: 1px solid var(--border-default);
      font-weight: 600; font-size: 11px;
    }
    .node-ico {
      width: 24px; height: 24px; border-radius: 5px;
      display: grid; place-items: center; flex-shrink: 0;
      font-size: 12px;
    }
    .node-lbl { display: flex; flex-direction: column; gap: 1px; min-width: 0; }
    .node-title { color: var(--fg-default); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .node-sub {
      font-size: 9px; font-weight: 400; font-family: var(--font-mono);
      color: var(--fg-subtle); letter-spacing: 0;
    }

    .node-body {
      padding: 8px 14px 10px;
      display: flex; flex-direction: column; gap: 4px;
    }
    .node-row {
      font-size: 10px; font-family: var(--font-mono); color: var(--fg-muted);
      display: flex; align-items: center; gap: 5px;
    }
    .node-row .d { width: 4px; height: 4px; border-radius: 50%; flex-shrink: 0; }

    /* Status pill */
    .status-pill {
      margin-left: auto;
      display: inline-flex; align-items: center; gap: 4px;
      padding: 2px 7px; border-radius: 999px;
      font-size: 9px; font-family: var(--font-mono); font-weight: 500;
    }
    .status-pill .blink {
      width: 5px; height: 5px; border-radius: 50%;
      animation: blink 2s ease-in-out infinite;
    }
    @keyframes blink { 0%,100%{opacity:1;} 50%{opacity:0.3;} }

    /* Node color themes */
    .node[data-type="frontend"] .node-ico { background: rgba(88,166,255,0.15); color: var(--accent-fg); }
    .node[data-type="frontend"]:hover { border-color: rgba(88,166,255,0.45); }

    .node[data-type="api"] .node-ico { background: rgba(163,113,247,0.15); color: var(--done-fg); }
    .node[data-type="api"]:hover { border-color: rgba(163,113,247,0.45); }

    .node[data-type="services"] .node-ico { background: rgba(232,136,58,0.15); color: var(--event-fg); }
    .node[data-type="services"]:hover { border-color: rgba(232,136,58,0.45); }

    .node[data-type="database"] .node-ico { background: rgba(210,153,34,0.15); color: var(--attention-fg); }
    .node[data-type="database"]:hover { border-color: rgba(210,153,34,0.45); }

    .node[data-type="docker"] {
      border-color: rgba(63,185,80,0.25);
      background: linear-gradient(145deg, var(--bg-default), rgba(26,64,40,0.12));
    }
    .node[data-type="docker"] .node-ico { background: rgba(63,185,80,0.15); color: var(--docker-fg); }
    .node[data-type="docker"]:hover { border-color: rgba(63,185,80,0.5); box-shadow: 0 0 30px rgba(63,185,80,0.08); }

    .node[data-type="cli"] {
      border-color: rgba(88,166,255,0.25);
      background: linear-gradient(145deg, var(--bg-default), rgba(45,90,142,0.12));
    }
    .node[data-type="cli"] .node-ico { background: rgba(88,166,255,0.15); color: var(--cli-fg); }
    .node[data-type="cli"]:hover { border-color: rgba(88,166,255,0.5); box-shadow: 0 0 30px rgba(88,166,255,0.08); }

    .node[data-type="sdk"] {
      border-color: rgba(247,120,186,0.25);
      background: linear-gradient(145deg, var(--bg-default), rgba(120,50,90,0.1));
    }
    .node[data-type="sdk"] .node-ico { background: rgba(247,120,186,0.15); color: var(--sdk-fg); }
    .node[data-type="sdk"]:hover { border-color: rgba(247,120,186,0.5); }

    .node[data-type="events"] {
      border-color: rgba(232,136,58,0.25);
      background: linear-gradient(145deg, var(--bg-default), rgba(100,60,20,0.12));
    }
    .node[data-type="events"] .node-ico { background: rgba(232,136,58,0.15); color: var(--event-fg); }
    .node[data-type="events"]:hover { border-color: rgba(232,136,58,0.5); }

    /* Docker container inner */
    .container-env {
      margin: 4px 10px 10px;
      border: 1px dashed rgba(63,185,80,0.25);
      border-radius: 6px;
      padding: 8px;
      background: rgba(63,185,80,0.03);
    }
    .container-env .ce-label {
      font-size: 8px; font-family: var(--font-mono);
      text-transform: uppercase; letter-spacing: 0.08em;
      color: rgba(63,185,80,0.55); margin-bottom: 4px;
    }
    .container-env .ce-row {
      font-size: 9px; font-family: var(--font-mono);
      color: var(--fg-muted); padding: 2px 0;
      display: flex; align-items: center; gap: 5px;
    }
    .container-env .ce-row::before {
      content: '›'; color: var(--docker-fg); opacity: 0.5; font-size: 10px;
    }

    /* ========================================
       Ticker
       ======================================== */
    .ticker {
      flex-shrink: 0;
      height: 36px;
      background: rgba(10,14,20,0.9);
      backdrop-filter: blur(8px);
      border-top: 1px solid var(--border-default);
      display: flex; align-items: center;
      overflow: hidden;
      padding: 0 16px; gap: 8px;
      z-index: 10;
    }
    .ticker-label {
      font-size: 8px; font-family: var(--font-mono);
      text-transform: uppercase; letter-spacing: 0.1em;
      color: var(--fg-subtle); flex-shrink: 0;
      padding-right: 10px; border-right: 1px solid var(--border-default);
    }
    .ticker-track {
      flex: 1; display: flex; gap: 20px;
      animation: scroll 35s linear infinite;
      white-space: nowrap;
    }
    @keyframes scroll { 0%{transform:translateX(0);} 100%{transform:translateX(-50%);} }
    .tk-ev {
      display: flex; align-items: center; gap: 5px;
      font-size: 10px; font-family: var(--font-mono);
      color: var(--fg-muted); flex-shrink: 0;
    }
    .tk-ev .tk-dot { width: 4px; height: 4px; border-radius: 50%; }
    .tk-ev .tk-type { font-weight: 500; }
    .tk-ev .tk-dim { color: var(--fg-subtle); }

    /* ========================================
       Controls
       ======================================== */
    .controls {
      position: fixed; bottom: 48px; left: 16px;
      display: flex; gap: 6px; z-index: 15;
    }
    .ctrl-btn {
      height: 28px; padding: 0 11px;
      border-radius: 6px; font-size: 10px;
      font-family: var(--font-mono); font-weight: 500;
      color: var(--fg-muted); background: var(--bg-default);
      border: 1px solid var(--border-default);
      transition: all 0.2s;
      display: flex; align-items: center; gap: 5px;
    }
    .ctrl-btn:hover { color: var(--fg-default); border-color: var(--fg-subtle); }
    .ctrl-btn.on { color: var(--accent-fg); border-color: rgba(88,166,255,0.4); background: rgba(88,166,255,0.06); }
    .ctrl-btn .cd { width: 5px; height: 5px; border-radius: 50%; }

    /* ========================================
       Lifecycle panel
       ======================================== */
    .lifecycle {
      position: fixed; bottom: 48px; right: 16px;
      background: var(--bg-default);
      border: 1px solid var(--border-default);
      border-radius: var(--radius-lg);
      padding: 14px 16px;
      z-index: 15; width: 220px;
    }
    .lc-title {
      font-size: 9px; font-family: var(--font-mono);
      text-transform: uppercase; letter-spacing: 0.08em;
      color: var(--fg-subtle); margin-bottom: 10px;
    }
    .lc-step {
      display: flex; align-items: center; gap: 8px;
      padding: 4px 0; position: relative;
    }
    .lc-step::before {
      content: ''; position: absolute;
      left: 7px; top: 20px; width: 1px;
      height: calc(100% - 8px);
      background: var(--border-default);
    }
    .lc-step:last-child::before { display: none; }
    .lc-dot {
      width: 15px; height: 15px; border-radius: 50%;
      border: 2px solid var(--border-default);
      background: var(--bg-canvas);
      display: grid; place-items: center;
      flex-shrink: 0; z-index: 1;
      font-size: 7px; font-weight: 700; color: #fff;
    }
    .lc-dot.done { border-color: var(--docker-fg); background: var(--docker-fg); }
    .lc-dot.active {
      border-color: var(--docker-fg); background: var(--success-dim);
    }
    .lc-dot.active::after {
      content: ''; width: 6px; height: 6px; border-radius: 50%;
      background: var(--docker-fg); animation: blink 2s ease-in-out infinite;
    }
    .lc-label {
      font-size: 10px; font-family: var(--font-mono); color: var(--fg-muted);
    }
    .lc-label.done { color: var(--fg-subtle); }
    .lc-label.active { color: var(--docker-fg); font-weight: 500; }

    /* ========================================
       Connection labels (positioned by JS)
       ======================================== */
    .conn-label {
      position: absolute;
      font-size: 8px; font-family: var(--font-mono);
      text-transform: uppercase; letter-spacing: 0.06em;
      pointer-events: none; z-index: 3;
      padding: 2px 6px;
      border-radius: 3px;
      background: rgba(10,14,20,0.7);
    }

    @media (prefers-reduced-motion: reduce) {
      *, *::before, *::after {
        animation-duration: 0.01ms !important;
        transition-duration: 0.01ms !important;
      }
    }
  </style>
</head>
<body>
<div class="page">
  <!-- Header -->
  <header class="header">
    <div class="header-left">
      <div class="logo-mark">A</div>
      <h1>Architecture<span>Data Flow Visualizer</span></h1>
    </div>
    <div class="legend">
      <div class="legend-item"><div class="legend-dot docker"></div>Docker Agent</div>
      <div class="legend-item"><div class="legend-dot cli"></div>CLI Agent</div>
      <div class="legend-item"><div class="legend-dot events"></div>SSE Events</div>
      <div class="legend-item"><div class="legend-dot data"></div>Data / REST</div>
    </div>
  </header>

  <!-- Canvas -->
  <div class="canvas-wrap" id="canvas">
    <svg id="conn-svg">
      <defs>
        <filter id="glow"><feGaussianBlur stdDeviation="3.5" result="b"/><feMerge><feMergeNode in="b"/><feMergeNode in="SourceGraphic"/></feMerge></filter>
      </defs>
    </svg>

    <div class="nodes-layer" id="nodes">
      <!-- ===== ROW 1: Frontend ===== -->
      <div class="node" data-id="frontend" data-type="frontend" style="left:3%; top:8%; width:195px;">
        <div class="node-hdr">
          <div class="node-ico">
            <svg width="14" height="14" viewBox="0 0 16 16" fill="none"><rect x="2" y="2" width="12" height="10" rx="2" stroke="currentColor" stroke-width="1.5"/><path d="M2 5h12" stroke="currentColor" stroke-width="1.5"/></svg>
          </div>
          <div class="node-lbl">
            <span class="node-title">Frontend</span>
            <span class="node-sub">:3000 — TanStack Start</span>
          </div>
        </div>
        <div class="node-body">
          <div class="node-row"><div class="d" style="background:var(--accent-fg)"></div>React 19 + Vite 7</div>
          <div class="node-row"><div class="d" style="background:var(--accent-fg)"></div>TanStack Router</div>
          <div class="node-row"><div class="d" style="background:var(--accent-fg)"></div>TanStack DB (client)</div>
          <div class="node-row"><div class="d" style="background:var(--accent-fg)"></div>Durable Streams sync</div>
        </div>
      </div>

      <!-- ===== ROW 2: API Layer ===== -->
      <div class="node" data-id="api" data-type="api" style="left:22%; top:8%; width:190px;">
        <div class="node-hdr">
          <div class="node-ico">
            <svg width="14" height="14" viewBox="0 0 16 16" fill="none"><rect x="2" y="2" width="12" height="12" rx="3" stroke="currentColor" stroke-width="1.5"/><path d="M4 8h8M8 4v8" stroke="currentColor" stroke-width="1.3" stroke-linecap="round"/></svg>
          </div>
          <div class="node-lbl">
            <span class="node-title">API Layer</span>
            <span class="node-sub">:3001 — Hono</span>
          </div>
        </div>
        <div class="node-body">
          <div class="node-row"><div class="d" style="background:var(--done-fg)"></div>28 REST endpoints</div>
          <div class="node-row"><div class="d" style="background:var(--done-fg)"></div>SSE /sessions/:id/stream</div>
          <div class="node-row"><div class="d" style="background:var(--done-fg)"></div>Zod validation</div>
        </div>
      </div>

      <!-- ===== ROW 2: Services ===== -->
      <div class="node" data-id="services" data-type="services" style="left:42%; top:5%; width:215px;">
        <div class="node-hdr">
          <div class="node-ico">
            <svg width="14" height="14" viewBox="0 0 16 16" fill="none"><circle cx="8" cy="4" r="2" stroke="currentColor" stroke-width="1.5"/><circle cx="4" cy="12" r="2" stroke="currentColor" stroke-width="1.5"/><circle cx="12" cy="12" r="2" stroke="currentColor" stroke-width="1.5"/><path d="M8 6v2M6.5 10l-1.2 1M9.5 10l1.2 1" stroke="currentColor" stroke-width="1.2"/></svg>
          </div>
          <div class="node-lbl">
            <span class="node-title">Services Layer</span>
            <span class="node-sub">Business Logic</span>
          </div>
        </div>
        <div class="node-body">
          <div class="node-row"><div class="d" style="background:var(--event-fg)"></div>AgentService — lifecycle</div>
          <div class="node-row"><div class="d" style="background:var(--event-fg)"></div>TaskService — workflow</div>
          <div class="node-row"><div class="d" style="background:var(--event-fg)"></div>SessionService — pub/sub</div>
          <div class="node-row"><div class="d" style="background:var(--event-fg)"></div>ProjectService — CRUD</div>
          <div class="node-row"><div class="d" style="background:var(--event-fg)"></div>WorktreeService — git</div>
        </div>
      </div>

      <!-- ===== Database ===== -->
      <div class="node" data-id="database" data-type="database" style="left:65%; top:8%; width:175px;">
        <div class="node-hdr">
          <div class="node-ico">
            <svg width="14" height="14" viewBox="0 0 16 16" fill="none"><ellipse cx="8" cy="4" rx="5" ry="2" stroke="currentColor" stroke-width="1.5"/><path d="M3 4v8c0 1.1 2.24 2 5 2s5-.9 5-2V4" stroke="currentColor" stroke-width="1.5"/><path d="M3 8c0 1.1 2.24 2 5 2s5-.9 5-2" stroke="currentColor" stroke-width="1" opacity="0.4"/></svg>
          </div>
          <div class="node-lbl">
            <span class="node-title">Database</span>
            <span class="node-sub">SQLite + Drizzle ORM</span>
          </div>
        </div>
        <div class="node-body">
          <div class="node-row"><div class="d" style="background:var(--attention-fg)"></div>9 tables</div>
          <div class="node-row"><div class="d" style="background:var(--attention-fg)"></div>better-sqlite3</div>
        </div>
      </div>

      <!-- ===== Stream Handler ===== -->
      <div class="node" data-id="stream" data-type="events" style="left:81%; top:5%; width:195px;">
        <div class="node-hdr">
          <div class="node-ico">
            <svg width="14" height="14" viewBox="0 0 16 16" fill="none"><path d="M2 4h12M2 8h12M2 12h12" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/></svg>
          </div>
          <div class="node-lbl">
            <span class="node-title">Stream Handler</span>
            <span class="node-sub">Event Bus + SSE</span>
          </div>
        </div>
        <div class="node-body">
          <div class="node-row"><div class="d" style="background:var(--event-fg)"></div>agent:started</div>
          <div class="node-row"><div class="d" style="background:var(--event-fg)"></div>agent:turn · chunk</div>
          <div class="node-row"><div class="d" style="background:var(--event-fg)"></div>tool:start · tool:result</div>
          <div class="node-row"><div class="d" style="background:var(--event-fg)"></div>agent:completed</div>
        </div>
      </div>

      <!-- ===== ROW 3: Docker Container (left) ===== -->
      <div class="node" data-id="docker" data-type="docker" style="left:3%; top:50%; width:250px;">
        <div class="node-hdr">
          <div class="node-ico">
            <svg width="14" height="14" viewBox="0 0 16 16" fill="none"><rect x="1" y="6" width="14" height="8" rx="2" stroke="currentColor" stroke-width="1.5"/><path d="M4 6V4a4 4 0 018 0v2" stroke="currentColor" stroke-width="1.5"/></svg>
          </div>
          <div class="node-lbl">
            <span class="node-title">Docker Container</span>
            <span class="node-sub">Sandbox Isolation</span>
          </div>
          <div class="status-pill" style="background:var(--success-dim);color:var(--docker-fg);">
            <span class="blink" style="background:var(--docker-fg);"></span>running
          </div>
        </div>
        <div class="container-env">
          <div class="ce-label">Container Environment</div>
          <div class="ce-row">non-root node user</div>
          <div class="ce-row">/workspace mount</div>
          <div class="ce-row">Claude CLI installed</div>
          <div class="ce-row">.credentials.json (OAuth)</div>
          <div class="ce-row">stop-file sentinel</div>
        </div>
      </div>

      <!-- ===== Agent Runner ===== -->
      <div class="node" data-id="runner" data-type="docker" style="left:22%; top:55%; width:195px;">
        <div class="node-hdr">
          <div class="node-ico">
            <svg width="14" height="14" viewBox="0 0 16 16" fill="none"><path d="M3 5l5 3-5 3V5z" fill="currentColor" opacity="0.3"/><path d="M3 5l5 3-5 3V5z" stroke="currentColor" stroke-width="1.5" stroke-linejoin="round"/></svg>
          </div>
          <div class="node-lbl">
            <span class="node-title">Agent Runner</span>
            <span class="node-sub">index.ts + event-emitter</span>
          </div>
        </div>
        <div class="node-body">
          <div class="node-row"><div class="d" style="background:var(--docker-fg)"></div>Structured events</div>
          <div class="node-row"><div class="d" style="background:var(--docker-fg)"></div>Max turns: 50</div>
        </div>
      </div>

      <!-- ===== Claude SDK (center) ===== -->
      <div class="node" data-id="sdk" data-type="sdk" style="left:42%; top:55%; width:220px;">
        <div class="node-hdr">
          <div class="node-ico">
            <svg width="14" height="14" viewBox="0 0 16 16" fill="none"><circle cx="8" cy="8" r="6" stroke="currentColor" stroke-width="1.5"/><path d="M5 8c0-1.66 1.34-3 3-3" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/><circle cx="8" cy="8" r="1.5" fill="currentColor" opacity="0.4"/></svg>
          </div>
          <div class="node-lbl">
            <span class="node-title">Claude Agent SDK</span>
            <span class="node-sub">@anthropic-ai/claude-agent-sdk</span>
          </div>
        </div>
        <div class="node-body">
          <div class="node-row"><div class="d" style="background:var(--sdk-fg)"></div>Plan → ExitPlanMode</div>
          <div class="node-row"><div class="d" style="background:var(--sdk-fg)"></div>Execute → acceptEdits</div>
          <div class="node-row"><div class="d" style="background:var(--sdk-fg)"></div>Swarm mode (parallel)</div>
        </div>
      </div>

      <!-- ===== CLI Agent (right) ===== -->
      <div class="node" data-id="cli" data-type="cli" style="left:65%; top:50%; width:215px;">
        <div class="node-hdr">
          <div class="node-ico">
            <svg width="14" height="14" viewBox="0 0 16 16" fill="none"><rect x="2" y="3" width="12" height="10" rx="2" stroke="currentColor" stroke-width="1.5"/><path d="M5 7l2 1.5L5 10" stroke="currentColor" stroke-width="1.3" stroke-linecap="round" stroke-linejoin="round"/><path d="M9 10h3" stroke="currentColor" stroke-width="1.3" stroke-linecap="round"/></svg>
          </div>
          <div class="node-lbl">
            <span class="node-title">CLI Agent (External)</span>
            <span class="node-sub">Agent Execution Service</span>
          </div>
          <div class="status-pill" style="background:rgba(45,90,142,0.3);color:var(--cli-fg);">
            <span class="blink" style="background:var(--cli-fg);"></span>executing
          </div>
        </div>
        <div class="node-body">
          <div class="node-row"><div class="d" style="background:var(--cli-fg)"></div>Process spawn on host</div>
          <div class="node-row"><div class="d" style="background:var(--cli-fg)"></div>Stream handler integration</div>
          <div class="node-row"><div class="d" style="background:var(--cli-fg)"></div>ANTHROPIC_API_KEY env</div>
        </div>
      </div>

      <!-- ===== Git Worktree ===== -->
      <div class="node" data-id="worktree" data-type="cli" style="left:82%; top:55%; width:185px;">
        <div class="node-hdr">
          <div class="node-ico">
            <svg width="14" height="14" viewBox="0 0 16 16" fill="none"><circle cx="8" cy="4" r="2" stroke="currentColor" stroke-width="1.5"/><circle cx="5" cy="12" r="2" stroke="currentColor" stroke-width="1.5"/><circle cx="11" cy="12" r="2" stroke="currentColor" stroke-width="1.5"/><path d="M8 6v2M6.5 9.5L5 10M9.5 9.5L11 10" stroke="currentColor" stroke-width="1.2"/></svg>
          </div>
          <div class="node-lbl">
            <span class="node-title">Git Worktree</span>
            <span class="node-sub">Isolated branch</span>
          </div>
        </div>
        <div class="node-body">
          <div class="node-row"><div class="d" style="background:var(--cli-fg)"></div>Per-task isolation</div>
          <div class="node-row"><div class="d" style="background:var(--cli-fg)"></div>Auto-cleanup lifecycle</div>
        </div>
      </div>
    </div><!-- /nodes-layer -->
  </div><!-- /canvas-wrap -->

  <!-- Ticker -->
  <div class="ticker">
    <div class="ticker-label">Live Events</div>
    <div class="ticker-track" id="ticker-track"></div>
  </div>
</div>

<!-- Controls -->
<div class="controls" id="controls"></div>

<!-- Lifecycle -->
<div class="lifecycle" id="lifecycle">
  <div class="lc-title">Agent Lifecycle</div>
  <div id="lc-steps"></div>
</div>

<script>
// ============================================================
// CONNECTION DEFINITIONS
// Each connection: { from, to, color, category, label?, side? }
//   side: 'right'|'bottom'|'left'|'top' for exit/entry anchors
// ============================================================
const CONNECTIONS = [
  // Data flow: Frontend → API → Services → Database
  { from: 'frontend', to: 'api',      color: '#a371f7', cat: 'data', label: 'HTTP / REST',  fromSide: 'right', toSide: 'left' },
  { from: 'api',      to: 'services', color: '#a371f7', cat: 'data', label: 'Service Calls', fromSide: 'right', toSide: 'left' },
  { from: 'services', to: 'database', color: '#a371f7', cat: 'data',                        fromSide: 'right', toSide: 'left' },

  // Docker path: Services → Docker → Runner → SDK
  { from: 'services', to: 'docker',   color: '#3fb950', cat: 'docker', label: 'Docker Exec',   fromSide: 'bottom', toSide: 'top' },
  { from: 'docker',   to: 'runner',   color: '#3fb950', cat: 'docker',                         fromSide: 'right',  toSide: 'left' },
  { from: 'runner',   to: 'sdk',      color: '#3fb950', cat: 'docker',                         fromSide: 'right',  toSide: 'left' },

  // CLI path: Services → CLI → Worktree → SDK
  { from: 'services', to: 'cli',      color: '#58a6ff', cat: 'cli', label: 'Process Spawn',  fromSide: 'bottom', toSide: 'top' },
  { from: 'cli',      to: 'worktree', color: '#58a6ff', cat: 'cli',                          fromSide: 'right',  toSide: 'left' },
  { from: 'worktree', to: 'sdk',      color: '#58a6ff', cat: 'cli',                          fromSide: 'bottom', toSide: 'bottom' },

  // Events back: SDK → Stream → API → Frontend
  { from: 'sdk',    to: 'stream',   color: '#e8883a', cat: 'events', label: 'Events',         fromSide: 'top',   toSide: 'bottom' },
  { from: 'stream', to: 'api',      color: '#e8883a', cat: 'events', label: 'SSE Stream',     fromSide: 'left',  toSide: 'right' },
  { from: 'api',    to: 'frontend', color: '#e8883a', cat: 'events', label: 'Durable Streams', fromSide: 'left',  toSide: 'right' },
];

// ============================================================
// STATE
// ============================================================
let particles = [];
let animating = true;
let dimmedCats = new Set();

// ============================================================
// GEOMETRY HELPERS
// ============================================================
function getAnchor(nodeEl, side) {
  const r = nodeEl.getBoundingClientRect();
  const cr = document.getElementById('canvas').getBoundingClientRect();
  const x = r.left - cr.left;
  const y = r.top - cr.top;
  const w = r.width;
  const h = r.height;
  switch (side) {
    case 'top':    return { x: x + w / 2, y: y };
    case 'bottom': return { x: x + w / 2, y: y + h };
    case 'left':   return { x: x,         y: y + h / 2 };
    case 'right':  return { x: x + w,     y: y + h / 2 };
    default:       return { x: x + w / 2, y: y + h / 2 };
  }
}

function cubicBezier(from, to, fromSide, toSide) {
  const dx = to.x - from.x;
  const dy = to.y - from.y;
  const dist = Math.sqrt(dx * dx + dy * dy);
  const offset = Math.min(dist * 0.45, 120);
  let cp1 = { ...from }, cp2 = { ...to };

  switch (fromSide) {
    case 'right':  cp1 = { x: from.x + offset, y: from.y }; break;
    case 'left':   cp1 = { x: from.x - offset, y: from.y }; break;
    case 'bottom': cp1 = { x: from.x, y: from.y + offset }; break;
    case 'top':    cp1 = { x: from.x, y: from.y - offset }; break;
  }
  switch (toSide) {
    case 'right':  cp2 = { x: to.x + offset, y: to.y }; break;
    case 'left':   cp2 = { x: to.x - offset, y: to.y }; break;
    case 'bottom': cp2 = { x: to.x, y: to.y + offset }; break;
    case 'top':    cp2 = { x: to.x, y: to.y - offset }; break;
  }
  return { from, to, cp1, cp2 };
}

function pointOnCubic(p0, p1, p2, p3, t) {
  const u = 1 - t;
  return {
    x: u*u*u*p0.x + 3*u*u*t*p1.x + 3*u*t*t*p2.x + t*t*t*p3.x,
    y: u*u*u*p0.y + 3*u*u*t*p1.y + 3*u*t*t*p2.y + t*t*t*p3.y,
  };
}

function svgPath(c) {
  return `M${c.from.x},${c.from.y} C${c.cp1.x},${c.cp1.y} ${c.cp2.x},${c.cp2.y} ${c.to.x},${c.to.y}`;
}

// ============================================================
// DRAW CONNECTIONS
// ============================================================
const svg = document.getElementById('conn-svg');
let pathEls = [];
let labelEls = [];

function drawConnections() {
  // Clear old
  while (svg.childNodes.length > 1) svg.removeChild(svg.lastChild); // keep <defs>
  pathEls = [];
  labelEls.forEach(l => l.remove());
  labelEls = [];
  document.querySelectorAll('.conn-label').forEach(e => e.remove());

  const canvas = document.getElementById('canvas');

  CONNECTIONS.forEach((conn, idx) => {
    const fromEl = document.querySelector(`[data-id="${conn.from}"]`);
    const toEl   = document.querySelector(`[data-id="${conn.to}"]`);
    if (!fromEl || !toEl) return;

    const fromPt = getAnchor(fromEl, conn.fromSide);
    const toPt   = getAnchor(toEl, conn.toSide);
    const curve  = cubicBezier(fromPt, toPt, conn.fromSide, conn.toSide);

    // Draw path
    const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
    path.setAttribute('d', svgPath(curve));
    path.setAttribute('fill', 'none');
    path.setAttribute('stroke', conn.color);
    path.setAttribute('stroke-opacity', '0.3');
    path.setAttribute('stroke-width', '1.5');
    path.setAttribute('stroke-linecap', 'round');
    path.setAttribute('data-cat', conn.cat);
    svg.appendChild(path);

    // Arrow at end
    const arrowT = 0.96;
    const arrowPt = pointOnCubic(curve.from, curve.cp1, curve.cp2, curve.to, arrowT);
    const tipPt = pointOnCubic(curve.from, curve.cp1, curve.cp2, curve.to, 1.0);
    const angle = Math.atan2(tipPt.y - arrowPt.y, tipPt.x - arrowPt.x) * 180 / Math.PI;
    const arrow = document.createElementNS('http://www.w3.org/2000/svg', 'polygon');
    arrow.setAttribute('points', '0,-4 10,0 0,4');
    arrow.setAttribute('transform', `translate(${tipPt.x},${tipPt.y}) rotate(${angle})`);
    arrow.setAttribute('fill', conn.color);
    arrow.setAttribute('opacity', '0.5');
    arrow.setAttribute('data-cat', conn.cat);
    svg.appendChild(arrow);

    pathEls.push({ path, curve, conn, arrow });

    // Label
    if (conn.label) {
      const midPt = pointOnCubic(curve.from, curve.cp1, curve.cp2, curve.to, 0.5);
      const lbl = document.createElement('div');
      lbl.className = 'conn-label';
      lbl.textContent = conn.label;
      lbl.style.color = conn.color;
      lbl.style.left = midPt.x + 'px';
      lbl.style.top = (midPt.y - 14) + 'px';
      lbl.style.transform = 'translateX(-50%)';
      lbl.setAttribute('data-cat', conn.cat);
      canvas.appendChild(lbl);
      labelEls.push(lbl);
    }
  });
}

// ============================================================
// PARTICLES
// ============================================================
function initParticles() {
  particles = [];
  pathEls.forEach(({ curve, conn }, idx) => {
    // 2 particles per connection with staggered starts
    for (let i = 0; i < 2; i++) {
      particles.push({
        curve,
        conn,
        t: i * 0.5,               // stagger
        speed: 0.003 + Math.random() * 0.002,
        radius: 2.5 - i * 0.5,
        el: null,
      });
    }
  });

  // Create SVG circle for each particle
  particles.forEach(p => {
    const c = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
    c.setAttribute('r', p.radius);
    c.setAttribute('fill', p.conn.color);
    c.setAttribute('filter', 'url(#glow)');
    c.setAttribute('data-cat', p.conn.cat);
    svg.appendChild(c);
    p.el = c;
  });
}

function animateParticles() {
  if (!animating) { requestAnimationFrame(animateParticles); return; }

  particles.forEach(p => {
    p.t += p.speed;
    if (p.t > 1) p.t -= 1;

    const pt = pointOnCubic(p.curve.from, p.curve.cp1, p.curve.cp2, p.curve.to, p.t);
    p.el.setAttribute('cx', pt.x);
    p.el.setAttribute('cy', pt.y);
  });

  requestAnimationFrame(animateParticles);
}

// ============================================================
// DIMMING
// ============================================================
function applyDimming() {
  svg.querySelectorAll('[data-cat]').forEach(el => {
    const cat = el.getAttribute('data-cat');
    if (dimmedCats.has(cat)) {
      el.setAttribute('opacity', '0.07');
    } else {
      el.removeAttribute('opacity');
      // Restore original stroke-opacity for paths
      if (el.tagName === 'path' && el.getAttribute('stroke-opacity')) {
        el.setAttribute('stroke-opacity', '0.3');
      }
    }
  });
  document.querySelectorAll('.conn-label[data-cat]').forEach(el => {
    el.style.opacity = dimmedCats.has(el.getAttribute('data-cat')) ? '0.08' : '';
  });
  // Dim matching nodes
  document.querySelectorAll('.node').forEach(n => {
    const ntype = n.getAttribute('data-type');
    // Map node types to categories
    const catMap = { docker: 'docker', cli: 'cli', events: 'events' };
    const nodeCat = catMap[ntype];
    if (nodeCat && dimmedCats.has(nodeCat)) {
      n.style.opacity = '0.2';
    } else {
      n.style.opacity = '';
    }
  });
}

// ============================================================
// CONTROLS
// ============================================================
function buildControls() {
  const ctr = document.getElementById('controls');
  const cats = [
    { id: 'animate', label: 'Animate', color: '#3fb950', isToggle: true },
    { id: 'docker',  label: 'Docker',  color: '#3fb950' },
    { id: 'cli',     label: 'CLI',     color: '#58a6ff' },
    { id: 'events',  label: 'Events',  color: '#e8883a' },
    { id: 'data',    label: 'Data',    color: '#a371f7' },
  ];
  cats.forEach(c => {
    const btn = document.createElement('button');
    btn.className = 'ctrl-btn on';
    btn.innerHTML = `<span class="cd" style="background:${c.color}"></span>${c.label}`;
    btn.onclick = () => {
      if (c.id === 'animate') {
        animating = !animating;
        btn.classList.toggle('on', animating);
      } else {
        if (dimmedCats.has(c.id)) {
          dimmedCats.delete(c.id);
          btn.classList.add('on');
        } else {
          dimmedCats.add(c.id);
          btn.classList.remove('on');
        }
        applyDimming();
      }
    };
    ctr.appendChild(btn);
  });
}

// ============================================================
// LIFECYCLE
// ============================================================
const LC_STATES = ['idle','initializing','planning','executing','waiting_approval','completed'];
let lcIdx = 3;

function buildLifecycle() {
  const ctr = document.getElementById('lc-steps');
  LC_STATES.forEach((s, i) => {
    const step = document.createElement('div');
    step.className = 'lc-step';
    const dot = document.createElement('div');
    dot.className = 'lc-dot';
    const lbl = document.createElement('span');
    lbl.className = 'lc-label';
    lbl.textContent = s;
    step.appendChild(dot);
    step.appendChild(lbl);
    ctr.appendChild(step);
  });
  updateLifecycle();
}

function updateLifecycle() {
  const dots = document.querySelectorAll('#lc-steps .lc-dot');
  const lbls = document.querySelectorAll('#lc-steps .lc-label');
  dots.forEach((d, i) => {
    d.className = 'lc-dot';
    lbls[i].className = 'lc-label';
    if (i < lcIdx) { d.classList.add('done'); d.textContent = '✓'; lbls[i].classList.add('done'); }
    else if (i === lcIdx) { d.classList.add('active'); d.textContent = ''; lbls[i].classList.add('active'); }
    else { d.textContent = ''; }
  });
}

setInterval(() => {
  lcIdx = (lcIdx + 1) % LC_STATES.length;
  updateLifecycle();
}, 3000);

// ============================================================
// TICKER
// ============================================================
function buildTicker() {
  const evs = [
    { t: 'agent:started',    c: '#3fb950', a: 'docker-01' },
    { t: 'agent:turn',       c: '#e8883a', a: 'docker-01', d: 'turn 3/50' },
    { t: 'chunk',            c: '#7b8da6', a: 'docker-01', d: '142 tokens' },
    { t: 'tool:start',       c: '#58a6ff', a: 'docker-01', d: 'Edit src/app.tsx' },
    { t: 'tool:result',      c: '#58a6ff', a: 'docker-01', d: 'success' },
    { t: 'agent:started',    c: '#3fb950', a: 'cli-02' },
    { t: 'agent:turn',       c: '#e8883a', a: 'cli-02',    d: 'turn 1/50' },
    { t: 'tool:start',       c: '#58a6ff', a: 'cli-02',    d: 'Bash npm test' },
    { t: 'tool:result',      c: '#3fb950', a: 'cli-02',    d: '12 passed' },
    { t: 'agent:plan_ready', c: '#a371f7', a: 'docker-01', d: '5 steps' },
    { t: 'agent:completed',  c: '#3fb950', a: 'docker-01' },
    { t: 'agent:turn_limit', c: '#f85149', a: 'cli-02',    d: 'turn 50/50' },
  ];
  const all = [...evs, ...evs]; // duplicate for loop
  const now = Date.now();
  const track = document.getElementById('ticker-track');
  track.innerHTML = all.map((e, i) => {
    const ts = new Date(now - (all.length - i) * 2500).toLocaleTimeString('en-US', { hour12:false, hour:'2-digit', minute:'2-digit', second:'2-digit' });
    return `<div class="tk-ev">
      <span class="tk-dot" style="background:${e.c}"></span>
      <span class="tk-type" style="color:${e.c}">${e.t}</span>
      <span class="tk-dim">→</span>
      <span>${e.a}</span>
      ${e.d ? `<span class="tk-dim">· ${e.d}</span>` : ''}
      <span class="tk-dim">${ts}</span>
    </div>`;
  }).join('');
}

// ============================================================
// INIT
// ============================================================
function init() {
  buildControls();
  buildLifecycle();
  buildTicker();

  // Wait for layout to settle before computing positions
  requestAnimationFrame(() => {
    requestAnimationFrame(() => {
      drawConnections();
      initParticles();
      animateParticles();
    });
  });

  // Redraw on resize
  let resizeTimer;
  window.addEventListener('resize', () => {
    clearTimeout(resizeTimer);
    resizeTimer = setTimeout(() => {
      drawConnections();
      // Rebuild particles on new paths
      particles.forEach(p => p.el && p.el.remove());
      initParticles();
    }, 150);
  });
}

init();
</script>
</body>
</html>
